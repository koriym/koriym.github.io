
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>BEAR Blog</title>
  <meta name="author" content="Akihito Koriyama">

  
  <meta name="description" content="Tweet 詳細はhttp://php-osx.liip.ch/を参照。以下元記事の間違い 1を訂正したまとめです。 PHPのインストール /usr/local/php5/にインストールされます。 1
2
3
curl -s -o /tmp/packager.tgz http://php-osx &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://koriym.github.io/page6/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="BEAR Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-6074569-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">BEAR Blog</a></h1>
  
    <h2>Because everything is a resource.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="koriym.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/09/php5-4%e3%83%90%e3%82%a4%e3%83%8a%e3%83%aa%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab/">OSX PHP 5.4バイナリインストール</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-09-14T00:00:00+09:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/2011/09/php5-4%e3%83%90%e3%82%a4%e3%83%8a%e3%83%aa%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab/#disqus_thread"
             data-disqus-identifier="http://koriym.github.io/2011/09/php5-4%e3%83%90%e3%82%a4%e3%83%8a%e3%83%aa%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><div style="float: right; margin-left: 10px;">
  <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" data-url="http://www.bear-project.net/blog/2011/09/php5-4%e3%83%90%e3%82%a4%e3%83%8a%e3%83%aa%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab/">Tweet</a>
</div>


<p>詳細は<a href="http://php-osx.liip.ch/">http://php-osx.liip.ch/</a>を参照。以下元記事の間違い <sup><a href="#footnote_0_798" id="identifier_0_798" class="footnote-link footnote-identifier-link" title="sudo tar -C /  -xzf /tmp/packager.tgzになっている。issue報告済み">1</a></sup>を訂正したまとめです。</p>

<h3>PHPのインストール</h3>

<p>/usr/local/php5/にインストールされます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -s -o /tmp/packager.tgz http://php-osx.liip.ch/packager/packager.tgz
</span><span class='line'>sudo tar -C /usr/local -xzf /tmp/packager.tgz
</span><span class='line'>sudo /usr/local/packager/packager.py install beta-frontenddev
</span></code></pre></td></tr></table></div></figure>


<h4>確認</h4>

<p>現在PHP 5.4.0beta2-dev というバージョンがインストールされます。<sup><a href="#footnote_1_798" id="identifier_1_798" class="footnote-link footnote-identifier-link" title="2011/10/24">2</a></sup></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>/usr/local/php5/bin/php -v
</span><span class='line'>
</span><span class='line'>PHP 5.4.0beta1-dev <span class="o">(</span>cli<span class="o">)</span> <span class="o">(</span>built: Aug <span class="m">23</span> <span class="m">2011</span> 11:16:42<span class="o">)</span>
</span><span class='line'>Copyright <span class="o">(</span>c<span class="o">)</span> 1997-2011 The PHP Group
</span><span class='line'>Zend Engine v2.4.0, Copyright <span class="o">(</span>c<span class="o">)</span> 1998-2011 Zend Technologies
</span><span class='line'>with Xdebug v2.2.0-dev, Copyright <span class="o">(</span>c<span class="o">)</span> 2002-2011, by Derick Rethans
</span></code></pre></td></tr></table></div></figure>


<h3>apapcheのhttpd.conf</h3>

<p>OSX純正のapache2の場合</p>

<p>/etc/apache2/httpd.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>LoadModule php5_module libexec/apache2/libphp5.so
</span></code></pre></td></tr></table></div></figure>


<p>を</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>LoadModule php5_module /usr/local/php5/libphp5.so
</span></code></pre></td></tr></table></div></figure>


<p>に変更</p>

<h3>アンインストール</h3>

<p>httpd.confを元のものに直してからphp5ディレクトリを消去します。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rm -rf /usr/local/php5
</span><span class='line'><span class="nv">$ </span>rm -rf /usr/local/packager/
</span></code></pre></td></tr></table></div></figure>


<h3>試してみよう</h3>

<ul>
<li><a href="http://d.hatena.ne.jp/jmtaro/20110908/1315508354">PHP5.4 でプロトタイプベースのオブジェクト指向を実現する &#8211; 国道十六号高架下</a></li>
<li><a href="http://d.hatena.ne.jp/anatoo/20110707/1310045371">PHP5.4のtraitを使ったシングルトンパターン実装によるtrait入門 &#8211; id:anatooのブログ </a></li>
<li><a href="http://meme.efcl.info/2011/07/php54.html">PHP5.4でビルトインウェブサーバーを使って反復実行環境の構築 | MemeTodo meme.efcl.info</a></li>
<li><a href="https://github.com/yuya-takeyama/LisPHP">yuya-takeyama / LisPHP</a>
などなど。現在は不十分ですがこの<a href="http://php.net/manual/ja/migration54.php">PHP 5.3.x から PHP 5.4.x への移行</a>ドキュメントも整ってくると思われます。 </ul>

<h3>PHP開発コミュニティへの協力</h3></li>
</ul>


<p>Rasmus Lerdorさんが<a href="https://plus.google.com/113641248237520845183/posts/R8qAfsM8qcs">&#8220;make test&#8221;の協力の呼びかけ</a>を行っています。ソースをコンパイルしてmake testとすると、test結果が自動的に送信されるような仕組みになっています。簡単に行えます。この記事とは直接の関係はありませんが紹介します。</p>

<h3>まとめ</h3>

<p>簡単です。インストールに時間もかからず、リンクエラーに悩まされる事も無く多くのextensionもサポートされていて開発用に良いんじゃないでしょうか。php5.3環境をmacports、php5.4環境をosx純正+このバイナリインストールのPHP5.4と使い分けています。</p>

<ol class="footnotes">
  <li id="footnote_0_798" class="footnote">
    sudo tar -C / -xzf /tmp/packager.tgzになっている。issue報告済み [<a href="#identifier_0_798" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_1_798" class="footnote">
    2011/10/24 [<a href="#identifier_1_798" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
</ol>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/09/gdd2011-devquiz/">GDD2011 DevQuiz</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-09-13T00:00:00+09:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/2011/09/gdd2011-devquiz/#disqus_thread"
             data-disqus-identifier="http://koriym.github.io/2011/09/gdd2011-devquiz/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><div style="float: right; margin-left: 10px;">
  <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" data-url="http://www.bear-project.net/blog/2011/09/gdd2011-devquiz/">Tweet</a>
</div>


<p>今年もGoogle Developers Days 2011のDevQuizに挑戦しました。<br/>
以下、その記録です。</p>

<h3>Web Game</h3>

<p>Chromeのエクステンションを作成。サンプルに少し追加して全てのカードをクリックするようにして解答しました。</p>

<p>多くの人が思ったようにChromeのエクステンションは簡単にできるのよく分かりました。solver.jsとmanifest.jsonの２つのファイルを作成するだけです。</p>

<p>このエクステンションは<a href="http://gdd-2011-quiz-japan.appspot.com/webgame/problem%E3%81%AE%E3%82%B5%E3%82%A4%E3%83%88%E3%81%AB%E5%87%BA%E7%8F%BE%E3%81%99%E3%82%8B%E5%85%A8%E3%81%A6%E3%81%AE%E3%82%AB%E3%83%BC%E3%83%89%E3%82%92%E3%82%AF%E3%83%AA%E3%83%83%E3%82%AF%E3%81%97%E3%81%BE%E3%81%99%E3%80%82">http://gdd-2011-quiz-japan.appspot.com/webgame/problem%E3%81%AE%E3%82%B5%E3%82%A4%E3%83%88%E3%81%AB%E5%87%BA%E7%8F%BE%E3%81%99%E3%82%8B%E5%85%A8%E3%81%A6%E3%81%AE%E3%82%AB%E3%83%BC%E3%83%89%E3%82%92%E3%82%AF%E3%83%AA%E3%83%83%E3%82%AF%E3%81%97%E3%81%BE%E3%81%99%E3%80%82</a></p>

<p>solver.js</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="nx">cont</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'><span class="k">while</span> <span class="p">(</span><span class="nx">cont</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">element0</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;card&#39;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">);</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">element1</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;card&#39;</span> <span class="o">+</span> <span class="nx">j</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">j</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">element0</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">cont</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">element1</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Card element is not found. Check element id.&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">j</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">myevent</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span><span class="p">(</span><span class="s1">&#39;MouseEvents&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">myevent</span><span class="p">.</span><span class="nx">initEvent</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">element0</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">myevent</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">element1</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">myevent</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Card color is &quot;&#39;</span> <span class="o">+</span> <span class="nx">element1</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">+</span> <span class="s1">&#39;&quot;.&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">j</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>manifest.json<br/>
<code>
{
  "name": "ChromeExtensionSolverHint",
  "version": "1.0",
  "description": "Open the first card and show background color of the card.",
  "content_scripts": [
    {
      "matches": [
        "http://gdd-2011-quiz-japan.appspot.com/webgame/problem*"
      ],
      "js": [
        "solver.js"
      ]
    }
  ],
  "permissions": [
  ]
}
</code></p>

<h3>Go</h3>

<p>Go言語で与えられた画像ファイルの使用色数を答える関数を作成するという問題です。</p>

<p>まずはOSX/LionにGoをインストールです。このサイトを参考にしました。<sup><a href="#footnote_0_763" id="identifier_0_763" class="footnote-link footnote-identifier-link" title="コンパイルとリンクを行うスクリプトもあって便利です。">1</a></sup><br/>
<a href="http://jeremyhubert.com/articles/installing-google-go-on-osx-snow-leopard.html">http://jeremyhubert.com/articles/installing-google-go-on-osx-snow-leopard.html</a></p>

<p>Go言語は初めてだったのですが触ってすぐに色々な興味深い特徴に気がつきます。<sup><a href="#footnote_1_763" id="identifier_1_763" class="footnote-link footnote-identifier-link" title="例えば、変数名の後に型が続く事や、大文字始まりならpublic宣言など。また未使用変数があればコンパイルにすら通りません。">2</a></sup><br/>
静的型付けのコンパイラ言語なのですが、丁寧に削られた簡素な記述のおかげかスクリプト言語のような柔軟でソフトな印象を感じました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package main
</span><span class='line'>import (
</span><span class='line'>    "fmt"
</span><span class='line'>    "io"
</span><span class='line'>    "strings"
</span><span class='line'>  imagep "image/png"
</span><span class='line'>    /* add more */
</span><span class='line'>)
</span><span class='line'>func CountColor(png io.Reader) int {
</span><span class='line'>  image, err := imagep.Decode(png)
</span><span class='line'>  if err != nil {
</span><span class='line'>      fmt.Printf("Error from png.Decode: %s\n", err)
</span><span class='line'>  }
</span><span class='line'>  width := image.Bounds().Size().X
</span><span class='line'>  height := image.Bounds().Size().Y
</span><span class='line'>    //fmt.Printf("width: %d, %d\n", width, height)
</span><span class='line'>  result := map[uint32]bool{}
</span><span class='line'>  var idx uint32
</span><span class='line'>  for y:=0 ; y &lt; height ; y++{
</span><span class='line'>      for x:= 0 ; x &lt; width ; x++ {
</span><span class='line'>          color := image.At(x, y)
</span><span class='line'>          //fmt.Printf("x, y, color: %d %d %x\n", x, y, color)
</span><span class='line'>          r, g, b, _ := color.RGBA();
</span><span class='line'>          idx = r*0x100*0x100 + g*0x100 + b
</span><span class='line'>          result[idx] = true
</span><span class='line'>      }
</span><span class='line'>  }
</span><span class='line'>  cnt := len(result)
</span><span class='line'>    return cnt
</span><span class='line'>}
</span><span class='line'>/* これらの関数は提出時に自動挿入されます。 */
</span><span class='line'>func main() {
</span><span class='line'>    png := GetPngBinary()
</span><span class='line'>    cnt := CountColor(png)
</span><span class='line'>    fmt.Println(cnt)
</span><span class='line'>}
</span><span class='line'>func GetPngBinary() io.Reader {
</span><span class='line'>    // img_strの中身は提出するたびに変化します。
</span><span class='line'>    img_str := "\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x18\x00\x00\x00\x08\x08\x06\x00\x00\x00\xe3\xa1?c\x00\x00\x02\xeeiCCPICC Profile\x00\x00x\x01\x85T\xcfk\x13A\x14\xfe6n\xa9\xd0\"\x08Zk\x0e\xb2x\x90\"IY\xabhE\xd46\xfd\x11bk\x0c\xdb\x1f\xb6E\x90d3I\xd6n6\xeb\xee&#038;\xb5\xa5\x88\xe4\xe2\xd1*\xdeE\xed\xa1\x07\xff\x80\x1ez\xf0d/J\x85ZE(\xde\xab(b\xa1\x17-\xf1\xcdnL\xb6\xa5\xea\xc0\xce~\xf3\xde7\xef}ov\xdf\x00\rr\xd24\xf5\x80\x04\xe4\r\xc7R\xa2\x11il|Bj\xfc\x88\x00\x8e\xa2\tA4%U\xdb\xecN$\x06A\x83s\xf9{\xe7\xd8z\x0f\x81[V\xc3{\xfbw\xb2w\xad\x9a\xd2\xb6\x9a\x07\x84\xfd@\xe0G\x9a\xd9*\xb0\xef\x17q\nY\x12\x02\x88&lt;\xdf\xa1)\xc7t\x08\xdf\xe3\xd8\xf2\xec\x8f9Nyx\xc1\xb5\x0f+=\xc4Y\"|@5-\xce\x7fM\xb8S\xcd%\xd3@\x83H8\x94\xf5qR&gt;\x9c\xd7\x8b\x94\xd7\x1d\x07inf\xc6\xc8\x10\xbdO\x90\xa6\xbb\xcc\xee\xabb\xa1\x9cN\xf6\x0e\x90\xbd\x9d\xf4~N\xb3\xde&gt;\xc2!\xc2\x0b\x19\xad?F\xb8\x8d\x9e\xf5\x8c\xd5?\xe2a\xe1\xa4\xe6\xc4\x86=\x1c\x185\xf4\xf8`\x15\xb7\x1a\xa9\xf85\xc2\x14_\x10M'\xa2Tq\xd9.\r\xf1\x98\xae\xfdV\xf2J\x82p\x908\xcada\x80sZHO\xd7Ln\xf8\xba\x87\x05}&#038;\xd7\x13\xaf\xe2wVQ\xe1y\x8f\x13g\xde\xd4\xdd\xefE\xda\x02\xaf0\x0e\x1d\x0c\x1a\x0c\x9a\rHP\x10E\x04a\x98\xb0P@\x86&lt; \x1a14\xb2r?#\xab\x06\x1b\x93{2u$j\xbbtbD\xb1A{6\xdc=\xb7Q\xa4\xdd&lt;\xfe(\"q\x94C\xb5\x08\x92\xfcA\xfe*\xaf\xc9O\xe5y\xf9\xcb\\\xb0\xd8V\xf7\x94\xad\x9b\x9a\xba\xf2\xe0;\xc5\xe5\x99\xb9\x1a\x1e\xd7\xd3\xc8\xe3sM^|\x95\xd4v\x93WG\x96\xacyz\xbc\x9a\xec\x1a?\xecW\x971\xe6\x825\x8f\xc4s\xb0\xfb\xf1-_\x95\xcc\x97)\x8c\x14\xc5\xe3U\xf3\xeaK\x84uZ17\xdf\x9fl\x7f;=\xe2.\xcf.\xb5\xd6s\xad\x89\x8b7V\x9b\x97g\xfdjH\xfb\xee\xaa\xbc\x93\xe6U\xf9O^\xf5\xf1\xfcg\xcd\xc4c\xe2)1&#038;v\x8a\xe7!\x89\x97\xc5.\xf1\x92\xd8K\xab\x0b\xe2`m\xc7\x08\x9d\x95\x86)\xd2m\x91\xfa$\xd5``\x9a\xbc\xf5/]?[x\xbdF\x7f\x0c\xf5Q\x94\x19\xcc\xd2T\x89\xf7\x7f\xc2*d4\x9d\xb9\x0eo\xfa\x8f\xdb\xc7\xfc\x17\xe4\xf7\x8a\xe7\x9f(\x02/l\xe0\xc8\x99\xbamSq\xef\x10\xa1e\xa5ns\xae\x02\x17\xbf\xd1}\xf0\xb6nk\xa3~8\xfc\x04X&lt;\xab\x16\xadR5\x9f \xbc\x01\x1cv\x87z\x1e\xe8)\x98\xd3\x96\x96\xcd9R\x87,\x9f\x93\xba\xe9\xcabR\xccP\xdbCRR\xd7%\xd7eK\x16\xb3\x99Ub\xe9v\xd8\x99\xd3\x1dn\x1c\xa19B\xf7\xc4\xa7Je\x93\xfa\xaf\xf1\x11\xb0\xfd\xb0R\xf9\xf9\xacR\xd9~N\x1a\xd6\x81\x97\xfao\xc0\xbc\xfdE\xc0x\x8b\x89\x00\x00\x00\x97IDAT(\x15\x9d\x92\x81\x0e\x80 \x08D\xa5\xf9m\xf5Y\xad\xcf\xaa\x9f#nz$\xba\xb9\xca\xad\x85\xc1\xbd\x03S\xd4\x96H\xf2\xa5\xea\xe1\xeb@\x8e\x02\xd0}\x14/\x80\x03\xca\xa75{\xeb0\x80\x01\xa9\xa0\xdcC|\x02:\xf1\xc3U\xc7\\K\x97}\xda9HPcq0pQ\x8aE\xe94y\x05'3\x92M[\x86\xc7\xc1\xa4n\x82\x01\x8ci\xe2\xc5\x7f\x02N`\xda\xdcCK\xaeqbqsD\xbd\x86=\xe0g\xdb\x9dy\xba\xb4Xp\x8bX\xf0\xe7\x8d\x89g\x84pD_\x0cx\x9438x7\xa4yC\r7\x04z\xae\x00\x00\x00\x00IEND\xaeB`\x82"
</span><span class='line'>    return strings.NewReader(img_str)
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>
ポイントというほどの所もないですが、色を数えるのに各色8bitなので16進数3桁の数字にしてキーにしその数を数えました。</p>

<h3>スライドパズル</h3>

<p>大きさが色々あり、盤面の中にも壁がある<a href="http://ja.wikipedia.org/wiki/15%E3%83%91%E3%82%BA%E3%83%AB">15パズル</a>の変形版のようなパズルを5000問解くという問題です。一問0.1点。これまでの３つのクイズの合計100点あったのですが、101点になるために今までの100点獲得の労力を軽く超えるような難易度でした。難しかったです。</p>

<p>CPU100%でファンを全開で一晩中計算し続けさせるようなパズルの解法のプログラムは、ms単位で処理の終わる普段のwebプログラムと全く違う世界です。AIプログラミングの基礎的な事から分かってなかったのでその学習から始めました。前回のGDD Pacman問題の反省です。<sup><a href="#footnote_2_763" id="identifier_2_763" class="footnote-link footnote-identifier-link" title="自分で適当に考え実装し後からああ自分の実装はBFSというやつだったのか..などとならないように！">3</a></sup>　</p>

<p>まず大事なのは問題をツリー構造にモデル化することです。問題プロセスの状態を節点（node）、その状態遷移を枝（branch)で表します。一番初めの節点を根（root）、一番末端を葉とした状の不可逆のツリー構造をモデルとし、そのルートからゴールまでの状態遷移に様々な探索方法をあてはめ解法を求めます。</p>

<p>競技用プログラムやAIプログラムに慣れてる方ならこの辺りの話は基礎の基礎なのだと思いますが、自分は一つ一つをあーなるほどと理解するところから始めました。</p>

<ul>
<li><a href="http://goo.gl/t8lz0">幅優先探索 BFS Breadth first search,</a></li>
<li><a href="http://goo.gl/YKjur">反復深化深さ優先探索 IDDFS diterative deepening depth-first search</a></li>
<li><a href="http://goo.gl/xXEAd">最良優先探索 Best-first search A*</a></li>
</ul>


<p>最良優先探索はいくつもあるのですが、向いてそうなのは A*、評価関数はオーソドックスな<a href="http://ja.wikipedia.org/wiki/%E3%83%9E%E3%83%B3%E3%83%8F%E3%83%83%E3%82%BF%E3%83%B3%E8%B7%9D%E9%9B%A2">マンハッタン距離</a>に少しオリジナルな関数を加えたらと考えました。</p>

<h4>言語の選択</h4>

<p>最初は普通に考えて速度の速いコンパイル言語をと、ちょっと学習してみたGoか普段使わないC/C++/Javaに挑戦するかとか考えました。<sup><a href="#footnote_3_763" id="identifier_3_763" class="footnote-link footnote-identifier-link" title=" Cはその昔SonyのPlayStation用ゲーム制作の一部を手伝った事があるくらいでポリゴンで3Dの関節プログラムとか、アセンブラのゲームの移植とか、すっかり忘れてるのですが再挑戦も面白いと思いました">4</a></sup> しかし#gdd11jpでPythonで高得点を取ってる方がいたのを見たのと <sup><a href="#footnote_4_763" id="identifier_4_763" class="footnote-link footnote-identifier-link" title="Cythonというコンパイラがあって超高速で実行できるのは後で知りました＾＾； ">5</a></sup>　使った事のないPHP5.3の機能ややってみたい実装があったのでPHPにしました。<sup><a href="#footnote_5_763" id="identifier_5_763" class="footnote-link footnote-identifier-link" title="どうせならPHP5.4でやれば良かったですね">6</a></sup>。目標として（使い切りだし時間も限られてますが）丁寧なOOPでマンハッタン距離+αのヒューストリックのA*で実装というのを立てます。</p>

<h4>実装</h4>

<p><a href="https://github.com/koriym/gdd11jp">https://github.com/koriym/gdd11jp</a></p>

<p>以下、READMEからです。</p>

<blockquote><p>■slide.php<br/>
本体。answer.txtがあれば解答済みファイルとしてスキップに利用、答えはoutput.txtで出力。<br/>
どのパズルをスキップするか、およびパズルに応じたタスク管理を選択するロジックをクロージャで渡して演算を開始。</p>

<p>幅優先探索は、反復深化深さ優先探索ははどちらもブラインドサーチで3x3と3x4,4/3のみに対応。それ以上は=(壁)検知付きマンハッタン距離、正位置にあるピースに重みづけ、それに手数削減のための過去の移動距離をそれぞれコストとして合計したものを関数としてヒューリスティック探索。繰り返し検知、逆探索検索付き。消費メモリ、消費時間に応じて無回答。制限時間になってもヒューリスティック関数の値が上昇し続けてたら時間制限を延長する”もう少しかも、頑張れ"機能。"下端を除くゲーム盤面の端で1つ足りないだけの状態にペナルティの効果"は今ひとつ。</p>

<p>演算コスト削減は、マンハッタン距離コストマップ、移動可否マップの事前演算。メモリ省力化として配列のSplFixedArray使用等。基本的な探索実装で目標スコア3000後半程度。肝心のソルバーは強くないが想定の範囲は大体実装。</p>

<p>クラス</p>

<p><strong>PuzzuleRepository</strong><br/>
ファイルからパズルオブジェクトを取り出せるリポジトリクラス。<br/>
<strong>Puzzle</strong><br/>
パズルの基本データ。プロパティの公開されているデータ構造クラス。<br/>
<strong>Game</strong><br/>
ゲーム状態を保持しパズルの基本操作ができるオブジェクト。方向と合わせてタスクとして登録される。<br/>
<strong>Play</strong><br/>
ルールを知りプレイを行うクラス。ゲーム完了するまでループ実行。<br/>
<strong>Task</strong><br/>
BFS, IDDFS, A*探索を行うためのタスクマネージメントクラス。<br/>
それぞれPHPのSplQueue、SplStack、SplPriorityQueueクラスを利用。</p></blockquote>

<p>PHPには A*にそのまま適用できる<a href="http://jp.php.net/manual/ja/class.splpriorityqueue.php">SplPriorityQueue</a> クラス、幅優先探索に<a href="http://jp.php.net/manual/ja/class.splqueue.php">SplQueue</a>クラス、深さ優先探索 に<a href="http://jp.php.net/manual/ja/class.splstack.php">SplStack </a>クラスという標準的なデータ構造用のクラスが5.3から用意されていてこれを利用しました。<br/>
肝心のソルバーはマンハッタン距離（途中の壁検知付の）と移動ヒストリーの長さを合算してコストにするものと、その逆探索の基本的なものですが、パズルを二次元配列にしないで高速化と処理の簡素化のために一次元にしたのと、移動処理の時のif R, if L &hellip;と4つ続ける冗長さを排除したのが小さなこだわりです。双方向探索の実装をしてれば大きくスコアを伸ばせたのではないかと思います。高速な言語に移植する方法もありましたがPHPと基本的なアルゴリズムでどれくらいのスコアが取れるのだろうという興味もありました。少しの改善で4000ありえるかなあというところでタイムアップでした。3750/5000です。高得点とは言えませんが、幅優先実装してたった0.57点でPHPじゃやっぱり&hellip;と途方にくれた時から考えると大きな前進でした。</p>

<h4>Clean Code</h4>

<p>限られた時間である程度の結果を出しながら多くのOOP原則に従ったClean Codeで記述というのも今回の目標の一つでした<sup><a href="#footnote_6_763" id="identifier_6_763" class="footnote-link footnote-identifier-link" title="点にはなりませんが">7</a></sup><br/>
単一責任原則（SRP:the Single Responsibility Principle） 、デメテルの法則（Law of Demetre (LoD)）、おまえが呼ぶな、俺が呼ぶの「ハリウッドの原則」、オープン・クローズドの原則（OCP）、gettr/setterの排除、等々意識したのですが不十分な所も多々あり反省の残るところです。それでも"次"にはかなり再利用できそうです。また、PHPのコーディングでprivate/protectedのprefixに_（アンダースコア）を使わないスタイルがいいのでは？にというトレンドが一部であるようで今回はそれに従ってみました。その他は現在のPHPのごく標準的なコード規約に従ってると思います。</p>

<h4>実行方法</h4>

<pre>$ git clone git@github.com:koriym/gdd11jp.git
$ cd gdd11jp/puzzle
$ php slide.php
</pre>


<h4>まとめ</h4>

<p>コンテストと違ったイベント感、使用言語を超え同じ取り組みをする事で生まれる共有感、高得点の人もそうでない人も、DevQuizはプログラミングが本来持つコーディングの楽しみが実感できる素晴らしい機会だと思います。<sup><a href="#footnote_7_763" id="identifier_7_763" class="footnote-link footnote-identifier-link" title="中学生の時にはじめてプログラミングしたワクワク感が少し甦りました。">8</a></sup> 機会を与えてくれた主催者の方々と<a href="http://twitter.com/search/%23gdd11jp">#gdd11jp</a>で楽しい時間を共有してくれた皆様には感謝を申し上げます。ありがとうございました。GDD11でお会いしましょう！</p>

<ol class="footnotes">
  <li id="footnote_0_763" class="footnote">
    コンパイルとリンクを行うスクリプトもあって便利です。 [<a href="#identifier_0_763" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_1_763" class="footnote">
    例えば、変数名の後に型が続く事や、大文字始まりならpublic宣言など。また未使用変数があればコンパイルにすら通りません。 [<a href="#identifier_1_763" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_2_763" class="footnote">
    自分で適当に考え実装し後からああ自分の実装はBFSというやつだったのか..などとならないように！ [<a href="#identifier_2_763" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_3_763" class="footnote">
    Cはその昔SonyのPlayStation用ゲーム制作の一部を手伝った事があるくらいでポリゴンで3Dの関節プログラムとか、アセンブラのゲームの移植とか、すっかり忘れてるのですが再挑戦も面白いと思いました [<a href="#identifier_3_763" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_4_763" class="footnote">
    Cythonというコンパイラがあって超高速で実行できるのは後で知りました＾＾； [<a href="#identifier_4_763" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_5_763" class="footnote">
    どうせならPHP5.4でやれば良かったですね [<a href="#identifier_5_763" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_6_763" class="footnote">
    点にはなりませんが [<a href="#identifier_6_763" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_7_763" class="footnote">
    中学生の時にはじめてプログラミングしたワクワク感が少し甦りました。 [<a href="#identifier_7_763" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
</ol>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/">PHP Hello Worldコールグラフ(2011)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-08-06T00:00:00+09:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/#disqus_thread"
             data-disqus-identifier="http://koriym.github.io/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><div style="float: right; margin-left: 10px;">
  <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" data-url="http://www.bear-project.net/blog/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/">Tweet</a>
</div>


<h3>Hello Worldベンチマーク</h3>

<p>去年の<a href="http://www.bear-project.net/blog/2010/04/hello-world%E3%82%B3%E3%83%BC%E3%83%AB%E3%82%B0%E3%83%A9%E3%83%95/">Hello Worldコールグラフ</a>に続いて再度HelloWorldグラフをとりました。</p>

<p>グラフをとるためにリファレンスにしたHelloWorldベンチマークのサイトは前回とは違い、SolarPHPというフレームワークのリードDeveloperのPaul M Jones氏の<a href="https://github.com/pmjones/php-framework-benchmarks">php-framework-benchmarks</a>というプロジェクトです。</p>

<p>SolarPHP自体はYiiのようにミニマムオーバーヘッドを特別アピールしているフレームワークではありませんが、Paul M Jones氏は数年前から定期的にこのような発表を行っていて、PHPでこの種のベンチマークに最も熱心に取り組んでる人だと思います。 Symfony2.0のリードコミッターのFabien氏もこのプロジェクトを<a href="https://github.com/fabpot/php-framework-benchmarks">fork</a>してSymfony2.0を加えています。</p>

<div id="__ss_8705097" style="width: 595px;">
  <strong style="display: block; margin: 12px 0 4px;"><a title="Benchmarking Applications and Frameworks" href="http://www.slideshare.net/pmjones88/benchmarking-applications-and-frameworks" target="_blank">Benchmarking Applications and Frameworks</a></strong>  <div style="padding: 5px 0 12px;">
    View more <a href="http://www.slideshare.net/" target="_blank">presentations</a> from <a href="http://www.slideshare.net/pmjones88" target="_blank">pmjones88</a>
  </div>
</div>


<h3>HelloWorldアプリのスペック</h3>

<p>基準となるHelloWorldアプリは以下のようなものです。</p>

<ul>
<li>最小限のアプリ（フルアプリケーションでない)</li>
<li>通常のconfig</li>
<li>アクションコードなし</li>
<li>ビューレイアウトもビューヘルパーもなし</li>
<li>スタティックなテキスト</li>
<li>ページキャッシュなし</li>
<li>データーベースなし</li>
</ul>


<p>アプリケーションロジックを含まないが「HelloWorldに徹底的にカスタマイズしたされたものでもない」、ごく標準的仕様のミニマムアプリです。</p>

<p>このアプリのベンチマークにはどういう意味があるのでしょうか。また比較にはどういう点に注意が必要でしょうか。スライドから抜粋して紹介します。</p>

<h3>ベンチマーク結果の比較</h3>

<h4>同じフレームワークでの比較</h4>

<p>継続的ベンチマーキング、新しいアーキテクチャの採用には実行コストが伴う、その利点/コスト分析として。新旧バージョンでの比較統計。</p>

<h4>違うフレームワークでの比較</h4>

<p>他システムとの応答比較、アーキテクチャコスト比較等。速度比較をする場合は同じような&#8221;スタイル/クラス&#8221;（PHP5/デザインパターン/front,pageコントローラ/ビューの分離など）で比べるべきです。つまりCIとKohana、Cake/Lithium/Solar/Symfony/Yii/Zendで比較するのが妥当です。</p>

<p>以上は特にフレームワーク開発者にとって重要です。同じクラス/スタイルのアーキテクチャで同程度の機能で極端な速度さがあればそれは設計や実装に見直す点が有るという事に繋がるでしょう。</p>

<p>Webサイトは高度になり表現方法も多様化しています。１つのページを表示したあと、様々な&#8221;ページの断片&#8221;が用意されるようなGmailのようなページではそのつぶつぶのような断片的JSONの発行にそれぞれこのミニマムオーバーヘッドコストがかかってます。実行コストを最小化しつつ豊富な機能を実装するような技術的試みが続けられてると思います。<sup><a href="#footnote_0_628" id="identifier_0_628" class="footnote-link footnote-identifier-link" title="そういう意味でSymfony2のベンチ結果に注目していました">1</a></sup><sup><a href="#footnote_1_628" id="identifier_1_628" class="footnote-link footnote-identifier-link" title="前回の記事でのCakePHPやsymfonyはこの点にまったく配慮がなかったのですが、今回大きく改良しています。">2</a></sup></p>

<h3>結果を過大評価しない</h3>

<p>スライドの中では「最も遅いフレームワークでも充分早い」と言っています。フレームワークの選定基準には様々な判断材料がありますが、この種のベンチ結果は重要でないことは前回記事のリファレンスのphp-markでも言っていますし、このプロジェクトでも言っています。Do not interpret the numbers alone <a href="http://code.google.com/p/phpmark/">http://code.google.com/p/phpmark/</a>。この数字を過大評価してフレームワークを選定したり批評したりするのは適切ではないでしょう。</p>

<p>「フレームワーク対決」の結果などではなく 、開発や対策など特定の目的を持ったときに意味のある数字だと思いますがどうでしょうか。</p>

<h3>ベンチマーク結果</h3>

<p>スライドで紹介されてる結果です。</p>

<p><strong>WARNING: ベンチマークはミスリードさせる可能性があります</strong></p>

<p><a href="http://www.bear-project.net/blog/wp-content/uploads/2011/08/51ed59663476e958f90c87515027326e.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/08/51ed59663476e958f90c87515027326e.png" title="FG 35%" width="597" height="369" class="alignnone size-full wp-image-747" /></a> <a href="http://www.bear-project.net/blog/wp-content/uploads/2011/08/39f1ac6508847c8a22ea39ab64eb56e7.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/08/39f1ac6508847c8a22ea39ab64eb56e7-300x187.png" title="FG 100%" width="300" height="187" class="alignnone size-medium wp-image-745" /></a> <div id="attachment_694" class="wp-caption alignnone" style="width: 601px">
  <a href="http://www.bear-project.net/blog/wp-content/uploads/2011/08/a9947644a1f44666561852b0eaec3716.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/08/a9947644a1f44666561852b0eaec3716.png" title="Hello World benchmark 30%" width="591" height="441" class="size-full wp-image-694" /></a><p class="wp-caption-text">
    フレームワークのスケール</p>

<p></div></p>

<p><a href="http://www.bear-project.net/blog/wp-content/uploads/2011/08/18b9e5798fa07886cd4e0a2ff2dbf2b4.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/08/18b9e5798fa07886cd4e0a2ff2dbf2b4-300x224.png" title="hello_world_benchmark" width="300" height="224" class="alignnone size-medium wp-image-692" /></a>
アーキテクチャの似たフレームワーク同士では結果が似たような速度の傾向があります。<br/>
DBアクセスを含めたアプリで比較してるcakephperさんの記事と合わせて見ると一層興味深いのではないでしょうか。</p>

<ul>
<li><a href="http://d.hatena.ne.jp/cakephper/20110802/1312275110">cakephperの日記(CakePHP, MongoDB) &#8211; 色々なPHPフレームワークのパフォーマンスを比較</a></li>
</ul>


<h3>ベンチマーク結果の利用</h3>

<p>基本的にアプリケーションロジックが取り除かれたこのコードが性能の上限です。キャンペーンや有名サイトでの紹介など一時的高負荷が予想されるときの負荷対策の基準になりえます。<sup><a href="#footnote_2_628" id="identifier_2_628" class="footnote-link footnote-identifier-link" title="高負荷のトップサイトなどでデータソースをRDBから他のキャッシュ向けストレージで利用する場合は、データベースの速度はあまり問題にならないでしょう。">3</a></sup></p>

<h3>XHGUI</h3>

<p>コールグラフは<a href="http://phpspot.org/blog/archives/2011/04/phpxhprofxhgui.html">XHGUI</a>というツールを利用しました。xhprofをフォークしたプロファイリングツールで結果保存にDBを利用し、複数回のプロファイリングを管理できます。</p>

<p>apacheを毎回リスタートさせ、以下のコマンドラインで出た結果のうち良いものをグラフ描画用に使用しています。</p>

<p><code>ab -c 10 -t 10 http://examplle.com/helloWorld/</code></p>

<div id="attachment_714" class="wp-caption alignnone" style="width: 310px">
  <a href="http://www.bear-project.net/blog/wp-content/uploads/2011/08/5c5d54d8f3985a7de20ca8719b89d500.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/08/5c5d54d8f3985a7de20ca8719b89d500-300x195.png" title="XHGUI" width="300" height="195" class="size-medium wp-image-714" /></a><p class="wp-caption-text">
    XHGUI - ヒストリー画面

</div>




<div id="attachment_718" class="wp-caption alignnone" style="width: 310px">
  <a href="http://www.bear-project.net/blog/wp-content/uploads/2011/08/79045a2d0cd2ad3d1fd7d375ee1780a3.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/08/79045a2d0cd2ad3d1fd7d375ee1780a3-300x134.png" title="XHGUI" width="300" height="134" class="size-medium wp-image-718" /></a><p class="wp-caption-text">
    XHGUI - プロファイル詳細画面

</div>


<h3>Hello Worldコールグラフ</h3>

<p>本題のコールグラフです。コール数の少ない順に表示しています。<br/>
※クリックすると別画面で開きますが画像はとても大きいのに注意してください。</p>

<p>アーキテクチャの似通ったフレームワークはやはり似通ったグラフの大きさとcall数になってますが、Yiiだけ特別です。特筆すべきはCakePHPの前回調査(v1.2)と今回(v1.3)の違いでコール数が1/10以下になっています。<sup><a href="#footnote_3_628" id="identifier_3_628" class="footnote-link footnote-identifier-link" title="前回が大すぎですね">4</a></sup></p>

<div id="attachment_660" class="wp-caption alignnone" style="width: 748px">
  <a href="http://www.bear-project.net/blog/wp-content/uploads/2011/08/Yii1.1.5.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/08/Yii1.1.5-738x1024.png" title="Yii1.1.5" width="738" height="1024" class="size-large wp-image-660" /></a><p class="wp-caption-text">
    Yii1.1.5 / 269 calls / 4853x6728 px

</div>




<div id="attachment_663" class="wp-caption alignnone" style="width: 971px">
  <a href="http://www.bear-project.net/blog/wp-content/uploads/2011/08/kohaa3.0.9.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/08/kohaa3.0.9-961x1024.png" title="kohaa3.0.9" width="961" height="1024" class="size-large wp-image-663" /></a><p class="wp-caption-text">
    Kohaa3.0.9 / 365 calls / 3240x3451 px

</div>




<div id="attachment_740" class="wp-caption alignnone" style="width: 1034px">
  <a href="http://www.bear-project.net/blog/wp-content/uploads/2011/08/ci.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/08/ci-1024x933.png" title="CodeIgniter2.0" width="1024" height="933" class="size-large wp-image-740" /></a><p class="wp-caption-text">
    CodeIgniter 2.0 / 447 calls / 3515x3250px

</div>




<div id="attachment_661" class="wp-caption alignnone" style="width: 882px">
  <a href="http://www.bear-project.net/blog/wp-content/uploads/2011/08/lithium0.9.9.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/08/lithium0.9.9-872x1024.png" title="lithium0.9.9" width="872" height="1024" class="size-large wp-image-661" /></a><p class="wp-caption-text">
    Lithium 0.9.9 / 732 calls / 5839x6856 px

</div>




<div id="attachment_662" class="wp-caption alignnone" style="width: 613px">
  <a href="http://www.bear-project.net/blog/wp-content/uploads/2011/08/SolarPHP1.1.1.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/08/SolarPHP1.1.1-603x1024.png" title="SolarPHP1.1.1" width="603" height="1024" class="size-large wp-image-662" /></a><p class="wp-caption-text">
    SolarPHP 1.1.1 / 1,174 calls / 3228x5477 px

</div>




<div id="attachment_645" class="wp-caption alignnone" style="width: 833px">
  <a href="http://www.bear-project.net/blog/wp-content/uploads/2011/08/cake1.3.10.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/08/cake1.3.10-823x1024.png" title="CakePHP 1.3.10" width="823" height="1024" class="size-large wp-image-645" /></a><p class="wp-caption-text">
    CakePHP 1.3.10 / 1,177 calls / 4767x5982 px

</div>




<div id="attachment_665" class="wp-caption alignnone" style="width: 648px">
  <a href="http://www.bear-project.net/blog/wp-content/uploads/2011/08/symfony2pr4.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/08/symfony2pr4-638x1024.png" title="symfony2pr4" width="638" height="1024" class="size-large wp-image-665" /></a><p class="wp-caption-text">
    Symfony2 pr4 / 1,274 calls / 4595x7373 px

</div>




<div id="attachment_649" class="wp-caption alignnone" style="width: 1034px">
  <a href="http://www.bear-project.net/blog/wp-content/uploads/2011/08/symfony1.4.8.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/08/symfony1.4.8-1024x926.png" title="symfony1.4.8" width="1024" height="926" class="size-large wp-image-649" /></a><p class="wp-caption-text">
    symfony1.4.8 / Calls 1,661 / 5837x5280 px

</div>




<div id="attachment_664" class="wp-caption alignnone" style="width: 1034px">
  <a href="http://www.bear-project.net/blog/wp-content/uploads/2011/08/Zend-1.11.9.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/08/Zend-1.11.9-1024x953.png" title="Zend 1.11.9" width="1024" height="953" class="size-large wp-image-664" /></a><p class="wp-caption-text">
    Zend Framework 1.11.9 / 1,799 calls / 7324x6819 px

</div>




<div class="row-fluid">
  <ul class="thumbnails">
    <li class="span2">
      <a class="thumbnail" href='http://www.bear-project.net/blog/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/%e3%82%b9%e3%82%af%e3%83%aa%e3%83%bc%e3%83%b3%e3%82%b7%e3%83%a7%e3%83%83%e3%83%88-2011-08-06-11-52-52/' title='FG 35%'>FG 35%</a>
    </li>
    <li class="span2">
      <a class="thumbnail" href='http://www.bear-project.net/blog/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/%e3%82%b9%e3%82%af%e3%83%aa%e3%83%bc%e3%83%b3%e3%82%b7%e3%83%a7%e3%83%83%e3%83%88-2011-08-06-11-53-00/' title='FG 100%'>FG 100%</a>
    </li>
    <li class="span2">
      <a class="thumbnail" href='http://www.bear-project.net/blog/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/ci/' title='CodeIgniter2.0'>CodeIgniter2.0</a>
    </li>
    <li class="span2">
      <a class="thumbnail" href='http://www.bear-project.net/blog/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/%e3%82%b9%e3%82%af%e3%83%aa%e3%83%bc%e3%83%b3%e3%82%b7%e3%83%a7%e3%83%83%e3%83%88-2011-08-05-0-34-26/' title='XHGUI'>XHGUI</a>
    </li>
    <li class="span2">
      <a class="thumbnail" href='http://www.bear-project.net/blog/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/%e3%82%b9%e3%82%af%e3%83%aa%e3%83%bc%e3%83%b3%e3%82%b7%e3%83%a7%e3%83%83%e3%83%88-2011-08-06-2-28-19/' title='XHGUI'>XHGUI</a>
    </li>
    <li class="span2">
      <a class="thumbnail" href='http://www.bear-project.net/blog/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/%e3%82%b9%e3%82%af%e3%83%aa%e3%83%bc%e3%83%b3%e3%82%b7%e3%83%a7%e3%83%83%e3%83%88-2011-08-06-1-22-11/' title='Hello World benchmark 30%'>Hello World benchmark 30%</a>
    </li>
    <li class="span2">
      <a class="thumbnail" href='http://www.bear-project.net/blog/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/%e3%82%b9%e3%82%af%e3%83%aa%e3%83%bc%e3%83%b3%e3%82%b7%e3%83%a7%e3%83%83%e3%83%88-2011-08-06-1-21-57/' title='hello_world_benchmark'>hello_world_benchmark</a>
    </li>
    <li class="span2">
      <a class="thumbnail" href='http://www.bear-project.net/blog/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/symfony2pr4/' title='symfony2pr4'>symfony2pr4</a>
    </li>
    <li class="span2">
      <a class="thumbnail" href='http://www.bear-project.net/blog/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/zend-1-11-9/' title='Zend 1.11.9'>Zend 1.11.9</a>
    </li>
    <li class="span2">
      <a class="thumbnail" href='http://www.bear-project.net/blog/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/kohaa3-0-9/' title='kohaa3.0.9'>kohaa3.0.9</a>
    </li>
    <li class="span2">
      <a class="thumbnail" href='http://www.bear-project.net/blog/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/solarphp1-1-1/' title='SolarPHP1.1.1'>SolarPHP1.1.1</a>
    </li>
    <li class="span2">
      <a class="thumbnail" href='http://www.bear-project.net/blog/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/lithium0-9-9/' title='lithium0.9.9'>lithium0.9.9</a>
    </li>
    <li class="span2">
      <a class="thumbnail" href='http://www.bear-project.net/blog/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/yii1-1-5/' title='Yii1.1.5'>Yii1.1.5</a>
    </li>
    <li class="span2">
      <a class="thumbnail" href='http://www.bear-project.net/blog/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/symfony1-4-8/' title='symfony1.4.8'>symfony1.4.8</a>
    </li>
    <li class="span2">
      <a class="thumbnail" href='http://www.bear-project.net/blog/2011/08/php-hello-world%e3%82%b3%e3%83%bc%e3%83%ab%e3%82%b0%e3%83%a9%e3%83%952011/cake1-3-10/' title='CakePHP 1.3.10'>CakePHP 1.3.10</a>
    </li>
  </ul>
</div>




<ol class="footnotes">
  <li id="footnote_0_628" class="footnote">
    そういう意味でSymfony2のベンチ結果に注目していました [<a href="#identifier_0_628" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_1_628" class="footnote">
    前回の記事でのCakePHPやsymfonyはこの点にまったく配慮がなかったのですが、今回大きく改良しています。 [<a href="#identifier_1_628" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_2_628" class="footnote">
    高負荷のトップサイトなどでデータソースをRDBから他のキャッシュ向けストレージで利用する場合は、データベースの速度はあまり問題にならないでしょう。 [<a href="#identifier_2_628" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_3_628" class="footnote">
    前回が大すぎですね [<a href="#identifier_3_628" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
</ol>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/07/bear-sunday/">BEAR (Sunday)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-07-29T00:00:00+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/2011/07/bear-sunday/#disqus_thread"
             data-disqus-identifier="http://koriym.github.io/2011/07/bear-sunday/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><div style="float: right; margin-left: 10px;">
  <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" data-url="http://www.bear-project.net/blog/2011/07/bear-sunday/">Tweet</a>
</div>




<div style="width:425px" id="__ss_8720699">
  <strong style="display:block;margin:12px 0 4px"><a href="http://www.slideshare.net/akihito.koriyama/bear-suday-design" title="BEAR (Suday) design" target="_blank">BEAR (Suday) design</a></strong> <div style="padding:5px 0 12px">
    View more <a href="http://www.slideshare.net/" target="_blank">presentations</a> from <a href="http://www.slideshare.net/akihito.koriyama" target="_blank">BEAR-project</a>
  </div>
</div>


<p><a href="https://gist.github.com/1111850">BEAR Sundayデザインメモ</a></p>

<p>PHP5.3+（またはPHP5.4）専用BEARのデザインメモをスライドとgist（テキストメモ）にしました。</p>

<p>アーキテクチャ的には「リソース指向」の更なる追求と「RESTful CQRS」が大きなテーマです。沢山のアイデアがあるのですが、今回はその２つを前回の<a href="http://www.bear-project.net/blog/2011/07/bear1-to-saturday/">BEAR1 to Saturday (2003, 2011)</a>に続いて記事にします。</p>

<h3>リソース指向フレームワーク</h3>

<p>リソース指向で、MVCのモデルにあたる部分をリソースとして扱うだけでなく、ページやビューにあたる他のコンポーネントもリソースとして扱います。それによりコントローラー、ビューもリソース同様のテスト可能性や再利用性の向上が求められるのではないかと考えます。もし全てのコンポーネントがCLIで簡単にリクエストして結果が求められるのであれば、テストの記述も簡単なものになるのではないでしょうか。キャッシュや外部アプリ/ホストの利用も同様に有効になるのではと思います。<sup><a href="#footnote_0_592" id="identifier_0_592" class="footnote-link footnote-identifier-link" title="例えばidを受け取ってそのIDのユーザーリソースとリンクされたその友達リソースを取得しHTML viiewリソースにリンクする「ページリソース」を考えてみます。ページはユーザーや友達リソースの値や実装には関心を持ちません。リソースの値の取得・セットではなく、接続性だけが記述してあります。そのように高度に疎結合なページではアプリケーションを超えた利用が可能です。写真サイトでもブログサイトでも「ユーザーと友達を表示する」というリソースの接続性が変わらないためです。写真サイトのユーザーページリソースをブログサイトのユーザーページが利用する事ができます。 ">1</a></sup></p>

<h3>CQRS (コマンドクエリ責務分離)</h3>

<p><a href="http://www.bear-project.net/blog/wp-content/uploads/2011/07/cqrs_architecture.jpg"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/07/cqrs_architecture-300x212.jpg" alt="" title="CQRS architecture" width="300" height="212" class="alignnone size-medium wp-image-616" /></a><br/>
CQRSとは「コマンドクエリ責務分離」といって簡単にいうと参照と更新では責任や仕組みを分離しましょうというアーキテクチャパターンです。</p>

<p><a href="http://d.hatena.ne.jp/digitalsoul/20100712/1278886009">Greg Young流CQRS &#8211; Mark Nijhof</a></p>

<p>例えばブログ記事の投稿を考えてみます。記事の投稿の時には、モデルはデータベースのテーブルの様々な項目に興味を持ちます。正規化され、結合され、複数のテーブルが更新されます。テーブルのコラムの情報はアトミック性をもち、関係性を持ちます。リレーショナルデータベースが有効に機能します。</p>

<p>ところが投稿されたこのブログ記事を読み込むときには、記事表示ページはこの関連付けされたリレーションを持った情報に興味を持たない事がほとんどです。結合、ソートされ、HTML化されたブログの記事の「文字列」が読めさえすれば読めればいいのです。この場合はただの１つの文字列がブログ記事IDから読み込めればいいということになります。つまり更新と参照では関心が異なるのです。</p>

<p>これを現状のBEAR（あるいは多くのフレームワーク）では通常はキャッシュとして実装し速度向上を目的にします。キャッシュは生成は簡単ですが破壊のタイミングが問題になることがあります。適当な秒数で破壊再生成したり、データ更新の時にモデルやコントローラが破壊します。</p>

<p>代わりにフレームワークがこれを行い、キャッシュの生成と破壊を透過にするだけでなく、キャッシュ生成のトリガーをユーザーでなくデータ作成、更新時にします。キャッシュというより、読み込み用データを書き込み時に作成すると言った方がピンと来るかもしれません。<sup><a href="#footnote_1_592" id="identifier_1_592" class="footnote-link footnote-identifier-link" title="クローラーがインデックスをつくるように">2</a></sup></p>

<p>あるいは更新処理が、参照を行うまで保持されているモデルはどうでしょうか？。そのような&#8221;遅延更新モデル&#8221;ではブログを誰も見なければ、記事が実データベーステーブルにinsertされる事はありません。代わりに更新イベントハンドラ（BEARではリソースリクエストハンドラ）は誰かがそのブログを見てくれるその日まで、その書き込みイベントを保持してるはずです。<sup><a href="#footnote_2_592" id="identifier_2_592" class="footnote-link footnote-identifier-link" title="つまり、遅延読み込みだけでなく、遅延作成、遅延更新といった遅延結合が可能になります。">3</a></sup></p>

<h3>REST meets CQRS</h3>

<p>同じインターフェイスを持つ（RESTful)、実処理とそのリクエストが関心に応じて分離(CQRS)がされるという事はフレームワークやアプリケーションにとって他にどういう力をもたらすでしょうか？クエリー（参照）とコマンド（更新）はその実処理においてだけでなく、コーディングについても非対称性があります。多くの場合、<del datetime="2011-08-03T02:42:39+00:00">更新</del>参照のページの方がコーディングが簡単なのです。</p>

<p>あるモデルの更新と参照を違うプログラマが担う事ができます。参照データだけ用意すれば参照ページが機能するという事は、参照しか必要のないプロトタイプ開発にも役立てる事ができるでしょう。<sup><a href="#footnote_3_592" id="identifier_3_592" class="footnote-link footnote-identifier-link" title="&ldquo;この種のアーキテクチャを採用することで得られるメリットとしてもう１つ強調しておきたいものがあります。それは異なるチーム間で作業負荷を分担するのがきわめて簡単であるということです。これはチーム間に時差がある場合に特に言うことができます。ドメインロジックは正しくなければならないものです。これは単価の高い開発者を投入したいと思う場所でしょう。つまり、業務を理解し、正しいコーディングプラクティスを理解した開発者をということです。言っていることは分かりますよね？しかし、参照部分はそれほど重要ではありません。もちろん正しい必要はあるのですが、価値がある場所ではなく、素早く作って１、２年のうちに作り替えることができます。つまり、単価の低い開発者に作ってもらうことができるものだということです。ドメインに関する知識が多く求められることもなく、本当に重要なのは、GUIがどのように機能し、どのようなコマンドが使え、どのようなイベントが要求されるかということだけです。&rdquo; &ndash; Greg Young流CQRS &ndash; Mark Nijhofより引用">4</a></sup></p>

<p>リクエストの公開宣言と境界の明確化、リクエストと実行の分離などCQRSの特徴の多くはフレームワークやアプリケーションのみならず、プロジェクトの進め方までに柔軟性を与える優れた可能性を持っているのではと考えます。</p>

<h3>webアプリケーションをwebのアーキテクチャで構築する</h3>

<p>CQRSのwebフレームワークというものは自分が知る限り数は少なく、またこれをRESTfulにというのはアイデアとしては語られても<sup><a href="#footnote_4_592" id="identifier_4_592" class="footnote-link footnote-identifier-link" title="
DDD/CQRS  REST and CQRS  ">5</a></sup> 実装を知りません。</p>

<p>しかしCQRSは「コンポーネントよりむしろ接続に注目する」BEARを拡張するアーキテクチャとしては最良のものではないかと考えます。またこの実装はチャレンジな部分が大きく<sup><a href="#footnote_5_592" id="identifier_5_592" class="footnote-link footnote-identifier-link" title="今までもそうでしたが">6</a></sup> 開発時に再検証や方針の再検討など必要な不確定部分が多いとは思います。スライドやGistではアイデアを大きく広げましたが、どこもまで、あるいはどのように実装するかは検討すべき点はまだまだあります。メモでかいたデザインのいくつかは実装、検討過程でボツになるかもしれません。<sup><a href="#footnote_6_592" id="identifier_6_592" class="footnote-link footnote-identifier-link" title="その過程でよりよい実装アイデアがでるかもしれませんが ">7</a></sup></p>

<p>色々な技術がありますが、やはりこれまでのBEARの開発と運用で学んだ「webアプリケーションをwebのアーキテクチャ<sup><a href="#footnote_7_592" id="identifier_7_592" class="footnote-link footnote-identifier-link" title="RESTful">8</a></sup> で構築する」有用性、そこを忘れず軸にして進めたいと思います。</p>

<p>「クライアントやサーバーサイドがどんなに複雑に高度になってもHTTPという接続技術のアーキテクチャが基本的に変わらず機能し続けてきた」 &#8211; これにはまだまだ学べる事があると思っています。</p>

<ol class="footnotes">
  <li id="footnote_0_592" class="footnote">
    例えばidを受け取ってそのIDのユーザーリソースとリンクされたその友達リソースを取得しHTML viiewリソースにリンクする「ページリソース」を考えてみます。ページはユーザーや友達リソースの値や実装には関心を持ちません。リソースの値の取得・セットではなく、接続性だけが記述してあります。そのように高度に疎結合なページではアプリケーションを超えた利用が可能です。写真サイトでもブログサイトでも「ユーザーと友達を表示する」というリソースの接続性が変わらないためです。写真サイトのユーザーページリソースをブログサイトのユーザーページが利用する事ができます。 [<a href="#identifier_0_592" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_1_592" class="footnote">
    クローラーがインデックスをつくるように [<a href="#identifier_1_592" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_2_592" class="footnote">
    つまり、遅延読み込みだけでなく、遅延作成、遅延更新といった遅延結合が可能になります。 [<a href="#identifier_2_592" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_3_592" class="footnote">
    &#8220;この種のアーキテクチャを採用することで得られるメリットとしてもう１つ強調しておきたいものがあります。それは異なるチーム間で作業負荷を分担するのがきわめて簡単であるということです。これはチーム間に時差がある場合に特に言うことができます。ドメインロジックは正しくなければならないものです。これは単価の高い開発者を投入したいと思う場所でしょう。つまり、業務を理解し、正しいコーディングプラクティスを理解した開発者をということです。言っていることは分かりますよね？しかし、参照部分はそれほど重要ではありません。もちろん正しい必要はあるのですが、価値がある場所ではなく、素早く作って１、２年のうちに作り替えることができます。つまり、単価の低い開発者に作ってもらうことができるものだということです。ドメインに関する知識が多く求められることもなく、本当に重要なのは、GUIがどのように機能し、どのようなコマンドが使え、どのようなイベントが要求されるかということだけです。&#8221; &#8211; Greg Young流CQRS &#8211; Mark Nijhofより引用 [<a href="#identifier_3_592" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_4_592" class="footnote">
    <a href="http://groups.google.com/group/dddcqrs/browse_thread/thread/dd59a59a5495d803/9acb9d6ebf67b24b?lnk=gst&#038;q=rest#9acb9d6ebf67b24b"> DDD/CQRS REST and CQRS </a> [<a href="#identifier_4_592" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_5_592" class="footnote">
    今までもそうでしたが [<a href="#identifier_5_592" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_6_592" class="footnote">
    その過程でよりよい実装アイデアがでるかもしれませんが [<a href="#identifier_6_592" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_7_592" class="footnote">
    RESTful [<a href="#identifier_7_592" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
</ol>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/07/net-baka/">読了 ネットバカ</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-07-24T00:00:00+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/2011/07/net-baka/#disqus_thread"
             data-disqus-identifier="http://koriym.github.io/2011/07/net-baka/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><div style="float: right; margin-left: 10px;">
  <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" data-url="http://www.bear-project.net/blog/2011/07/%e8%aa%ad%e4%ba%86%ef%bc%9a%e3%83%8d%e3%83%83%e3%83%88%e3%83%90%e3%82%ab/">Tweet</a>
</div>


<p>この本は自分の長年の問いに、それが自分だけが感じてた疑問ではなく、多く語られ議論されてきたものだと知らせてくれ、その疑問にははっきりと用語が与えられそれぞれ深い洞察があるのだと知らせてくれた良書。本書の主題とは外れるところはあっても気になった引用等を記してみたい。</p>

<h3>メッセージであるというメッセージ</h3>

<blockquote><p>「メディアはメッセージである」<br/>
- マーシャル・マクルーハン　1964年「メディア論」</p></blockquote>

<p>本書で最初に引用されるのがマクルーハンのこの有名な一文。自分が初めて聞いたのは確か高校生の時だったと思う。それからあらゆるメディアの登場の度に引用され、語られて来たのを見ている。<sup><a href="#footnote_0_439" id="identifier_0_439" class="footnote-link footnote-identifier-link" title="いつか読もうと思ってるが僕はこのメディア論を読んだ事はない。しかし絶頂期でさえ読まれる事より引用される事の方が多かったそうだ。">1</a></sup><sup><a href="#footnote_1_439" id="identifier_1_439" class="footnote-link footnote-identifier-link" title="http://ja.wikipedia.org/wiki/%E3%83%9E%E3%83%BC%E3%82%B7%E3%83%A3%E3%83%AB%E3%83%BB%E3%83%9E%E3%82%AF%E3%83%AB%E3%83%BC%E3%83%8F%E3%83%B3">2</a></sup></p>

<blockquote><p>新しいコミニケーションテクノロジーが持つ変容のパワーをマクルーハンはただ認め、祝福してただけではないということだ。彼はこの脅威について警告もしていたー<strong>そしてその脅威について無知であることの危険性についても</strong></p></blockquote>

<p>メディアはメッセージである &#8211; 高校生の僕にはマクルーハンのこの謎めいたメッセージの真の意味を理解する事はできなかった。しかし強烈な印象を持っていてずっと離れない言葉だったのは確か。その意味に迫るんだろうと予感させる本書のプロローグに期待をした。</p>

<h3>プラスティックな脳</h3>

<p>plastic（形容詞） &#8211; 自由な形にできる, 塑造できる, 可塑性の；</p>

<p>1968年 &#8211; 「2001年宇宙の旅」が封切られた僕の生まれた年 &#8211; に26才のマイケルマーゼニックという博士号を取得したばかりの若者がサルの頭蓋骨に穴をあけ、神経可塑性の研究をし、驚くべき発見をする。</p>

<blockquote><p>成人の脳は可塑的<sup><a href="#footnote_2_439" id="identifier_2_439" class="footnote-link footnote-identifier-link" title="外から成形されやすい">3</a></sup>で（後の研究者によれば「非常に可塑的」あるいは「とてつもなく可塑的」）で全ての神経回路 &#8211; 感情、視覚、聴覚、運動、思考、学習、認識、記憶、神経回路のすべてが変化しうる。しかし、「多忙者生存」といわれ与え続けた刺激にしたがってのみ変化する特質は、人の生存や活動に適したように成形されるわけではない。プラスティック（可塑的）ではあるがエラスティック（弾性がある）わけではない。</p></blockquote>

<p>これはそれまで信じられて来た機械的な脳 &#8211; 成人になれば変わらぬ構造をする &#8211; を大きく覆すものだった。最初は四肢の喪失など神経の構造な大規模な構造変化のときに「アップデート」されると信じられた脳の変化も、どうもそうではなく健全で機能してる神経回路に対しても常時アップデートされてる事がわかる。<sup><a href="#footnote_3_439" id="identifier_3_439" class="footnote-link footnote-identifier-link" title="つまり「ゲーム脳」とか言ってる人や記事を色眼鏡で見てた僕の認識にも&rdquo;アップデート&rdquo;が必要">4</a></sup></p>

<p>脳は外界からの刺激によって、変化する。massiveに、物理的に。<br/>
本書の主題だ。</p>

<p>OECD高所得国の平均修学年数は10年を超える。<br/>
こんな事勉強して何になるんだろう？そう思った事の学生の時の自分に伝えたい。<br/>
脳に新しいスキーマを構築し、知性を深めるプロセスを繰り返す刺激を脳に与え続ける事が大事と。</p>

<h3>インストゥメンタリスト</h3>

<p>パーソナルコンピュータ、携帯電話、常時接続のような携帯電話のEメール、FB, Twitter、色々なテクノロジーやメディアが登場しマスコミで面白く便利なものとして、あるいは時には脅威を持って紹介され、その後こう締めくくられる「（技術は技術、それ以上であってそれ以下でもなく）結局はそれを使う私たち自身の問題なのかもしれません。」</p>

<p>僕は直感的に「これは間違ってる」と思ってた。支配権、決定権は使用者にあると心地よく聞こえるけど、その捉え方はちょっとイノセントすぎるというか違和感があった。強力なメディアやテクノロジーは、単に新しいオプションというだけではないんじゃないだろうか。 <sup><a href="#footnote_4_439" id="identifier_4_439" class="footnote-link footnote-identifier-link" title="こっちをもっと巻き込むような&hellip;そもそも自分達使用者は本当に選んでいるんだろうかという疑問もあった。">5</a></sup></p>

<blockquote><p>道具主義者（インストゥメンタリスト） &#8211; 道具は中立的人口物であり、ユーザーの意識的欲望に完全に従属するものだと考える人々である</p>

<p>どの道具を使うかについて個人や社会が様々な決定を行ってるとしても、テクノロジーと進歩の方向性とペースを我々が充分にコントロールしてきた事にならない。地図や時計を使う事を我々が「選んで」きてのだと主張するのは無理な話だ。（あたかもそうしないことができたのようでないか）また、そうしたテクノロジーの副作用を我々が「選んだ」と考えるのもなおさら無理なことである。そうした副作用の多くはそのテクノロジーが使用され始めた時にはまったく予想されてなかったのだから。政治学者ラングドン・ウィナーは次のように言う、。「近代社会の経験が我々に何かを教えてくれるとしたら、それはテクノロジーが人間の活動に対する補助でなく、その活動、およびその意味を再形成する、強力な力でもあるということだ」</p></blockquote>

<p>その自分のもやもやした「結局は私たち自身の問題なのかも知れません」という「新たなテクノロジーは新しい選択肢にすぎない」という見方に対する自分の疑問にはっきり答える章がでてくる。</p>

<h3>そしてそののちに、道具が我々を</h3>

<blockquote><p>われわれが道具とのあいだに結ぶ強い絆は、二つの方向に働く。テクノロジーがわれわれの延長になるにつれ、われわれもテクノロジーの延長になる。ハンマーを手にした大工は、自分の手を、ハンマーを使うようにしか使うことができない。その手は、釘を打ったり抜いたりするための道具になるのだ。双眼鏡を顔の前に持ってきた兵士は、そのレンズが見せてくれるものしか見ることができない。遠くは見えるようになるが、近くのものは見えなくなるのだ。</p>

<p>「我々は道具を作る。そしてそののちに、道具が我々を作る。」 &#8211; 1967  ジョン・カルキン　（イエズス会神父、メディア学者）</p>

<p>「物は鞍にまたがり/人類を乗りこなす」 <a href="http://ja.wikipedia.org/wiki/%E3%83%A9%E3%83%AB%E3%83%95%E3%83%BB%E3%83%AF%E3%83%AB%E3%83%89%E3%83%BB%E3%82%A8%E3%83%9E%E3%83%BC%E3%82%BD%E3%83%B3">ラルフ･ウォルドー・エマソン</a></p></blockquote>

<p>テクノロジーは我々を拡張し、再定義する。<br/>
技術は我々の延長にあるが、その我々も技術の延長にあるようになる。</p>

<p>映画や小説、ジャーナリズムはテクノロジーのこの側面を暗くとらえ警鐘する。しかし過去に置いても人とはずっとそういうものだった。映画「2001年宇宙の旅」で人類の祖先が骨をハンマーとして振り上げ（つまり初めて道具を使う生物が誕生して）その骨が宇宙船になり100万年をスキップするシーンがある。人と道具が不可分であった事を示す映画史上に残る名シーンだと思う。再理解した。</p>

<p>自分の疑問に確信が得られた。</p>

<p>新しいテクノロジーは決して単なるオプション、新しいー選択肢などでは無い。使用する者を拡張し、再定義する、未来の自分自身の一部だ。</p>

<h3>テクノロジーの鈍感化効果</h3>

<p>拡張には代償がある。</p>

<blockquote><p>力織機が発明されたとき、織工たちは手で織ってたときよりもはるかに多くの布を一日で製造できるようになったが、手の器用さをいくらか犠牲にしてしまった。</p></blockquote>

<p>これを経験してない現代人はいない。</p>

<p>増幅の代償として鈍感がもたらされる。ワープロソフトと車載ナビゲーションが何を増幅して何を鈍感にしただろう。先人達が一ヶ月かかって耕せなかった土地を一日で耕す、巨大トラクターの空調の聞いたケージはどんな鈍感をもたらすんだろうか。</p>

<blockquote><p>テクノロジーの鈍感化効果を考察したのは自身も認めてるようにマクルーハンではない。これをもっとも雄弁かつ不吉な形で表現したのは、おそらく旧約聖書の詩編作者だ。</p>

<p>彼らの偶像は金銀の、<br/>
人の手になる者たちである。<br/>
口はあるが、語らない。<br/>
耳はあるが、聞こえない。<br/>
鼻はあるが、匂わない。<br/>
手はあるが、取らない。<br/>
足はあるが、歩かない。<br/>
のどから声を出すこともない。<br/>
それらを作った者たちは、それらに似ている。<br/>
それらを信じるものたちもみなそうである。</p></blockquote>

<p>あらゆる場面で鈍感を強要する現代の都市生活。<br/>
鈍感は力なんだという事を言い始める人まででてきた。</p>

<h3>記憶のトランスファー</h3>

<p><a href="http://ja.wikipedia.org/wiki/%E3%83%AF%E3%83%BC%E3%82%AD%E3%83%B3%E3%82%B0%E3%83%A1%E3%83%A2%E3%83%AA">作動記憶、ワーキングメモリ</a>と呼ばれ”る情報を一時的に保持し操作するためのシステム”は脳科学者達の初期の研究(1956)によると７つ±２の情報の断片しか処理できない。<sup><a href="#footnote_5_439" id="identifier_5_439" class="footnote-link footnote-identifier-link" title="Miller （1956年）による「マジカルナンバー7&plusmn;2」">6</a></sup> 後にそれは2から4に訂正され、後に恐らく低い方の数字と見積もられる。人が同時に持てる記憶のエレメントは非常に限られている。<sup><a href="#footnote_6_439" id="identifier_6_439" class="footnote-link footnote-identifier-link" title="短期記憶には感覚入力そのものの500msからせいぜい５秒程度の持続時間しか持たない非意識的な感覚記憶から、選択的注意を伴い意識化することで短期記憶貯蔵庫に15秒から30秒間保持されるものまで記憶保持時間に幅があります http://www.blog.crn.or.jp/report/04/52.html">7</a></sup></p>

<p>コンピュータのプログラムを良く知る人は、一体人の脳というのはコンピュータプログラムとどのような点で似ていて、どのような点で似ていないかとか一度は考えた事があると思う。知性の正体とはどういうものであろうか。あるいはコンピュータの記憶と人の記憶は何が似ていて何が違ってるだろうか。</p>

<p>作動記憶と長期記憶は例えば、RAMとHDDのようなものなのだろうか。その例えはRAMの方はいいかもしれない。しかし長期記憶は全く違う。</p>

<p>コンピュータの世界では長期記憶と作動記憶は、保存方法に違いはあれど基本的にはビット単位で同じだ。予め容量には上限がある点も同じ。ところが脳は違う、全然違う。</p>

<h3>知性の正体</h3>

<blockquote><p>長期記憶は、事実、印象、出来事を保管する巨大な倉庫のような役割だけを果たしていて、「思考や問題解決といった複雑な認知プロセスでは、ほとんど何の役割も果たしていない」とかつては考えられていた。だが、長期記憶がじつは理解を行う場でもあると、脳科学者達は気がついた。長期記憶はは事実だけでなく、複雑な概念、すわなちスキーマ（体系的図式）をも保管しているのだ。バラバラの断片をパターン化された知識へと組織する事によって、スキーマは我々の思考を豊かなものにする。「われわれの知的能力の大部分は、長きにわたって獲得したスキーマに由来している。専門的な概念を理解できるのは、それらの概念に関連するスキーマを持ってるからである」</p>

<p>作動記憶から長期記憶へと情報を差し替え、概念スキーマとして組み上げる能力によって、知性の深さは決定される</p></blockquote>

<p>僕は知識を「知恵」に変換するプロセスが大切だと考えてた。（知恵とは、より抽象度、応用度が高い動的知識みたいなものと理解していた。）　つまり本書で言う概念スキーマに近い。しかし本書ではその漠然とした考えに、実際には睡眠で見る夢やタンパク質、脳神経の物理現象など色々な要素が関わって物理的につくられていくという事が説明してあって大変興味深かった。知性や知恵とは概念というだけなくて、現象でもあった。</p>

<h3>ソクラテスとプラトン、音声文化から文字文化へ</h3>

<blockquote><p>「王様、この文字というものを学べば、エジプト人たちの知恵はたかまり、もの覚えはよくなるでしょう。私の発見したものは、記憶と知恵の秘訣なのですから。」──しかし、タモスは答えて言った。</p>

<p>「たぐいなき技術の神テウトよ、技術上の事柄を生み出す力をもった人と、生み出された技術がそれを使う人々にどのような害をあたえ、どのような益をもたらすかを判別する力をもった人とは、別の者なのだ。いまもあなたは。文字の生みの親として、愛情にほだされ、文字が実際にもっている効能と正反対のことを言われた。なぜなら、人々がこの文字というものを学ぶと、記憶力の訓練がなおざりにされるため、その人達の魂の中には、忘れっぽい性質が植え付けられることだろうから。それはほかでもない、彼らは書いたものを信頼して、ものを思い出すのに、自分以外のものに彫りつけられたしるしによって外から思い出すようになり、自分で自分の力によって内から思い出すことをしないようになるからである。じじつ、あなたが発明したのは、記憶の秘訣ではなくて、想起の秘訣なのだ。また他方、あなたがこれを学ぶ人たちに与える知恵というのは、知恵の外見であって、真実の知恵ではない。すなわち、彼らはあなたのおかげで、親しく教えをうけなくてももの知りになるため、多くの場合ほんとうは何も知らないでいながら、見かけだけはひじょうな博識家であると思われるようになるだろうし、また知者となる代りに知者であるといううぬぼれだけが発達するため、つき合いにくい人間となるだろう。」<br/>
（プラトン『パイドロス』藤沢令夫訳　岩波文庫　１３４、１３５頁）</p></blockquote>

<p>((新興メディア叩き in 古代ギリシア <a href="http://trushnote.exblog.jp/14087619/">http://trushnote.exblog.jp/14087619/</a>)) <sup><a href="#footnote_7_439" id="identifier_7_439" class="footnote-link footnote-identifier-link" title="パイドロス http://ja.wikipedia.org/wiki/%E3%83%91%E3%82%A4%E3%83%89%E3%83%AD%E3%82%B9">8</a></sup></p>

<p>紀元前3500年、シュメール人が楔形文字を発明し、知が話し言葉の「音声文化」から文字が思考表現の主要媒体となる「文字文化」へ移行するという人類史上最大のメディアシフトが起こる。<sup><a href="#footnote_8_439" id="identifier_8_439" class="footnote-link footnote-identifier-link" title="僕はイランイラク国境に近いジグラットでこの楔型文字を見た事がある。その時の感動がこの対話を知った事で深まった。">9</a></sup></p>

<p>「文字を学ぶ物達にあなたが与えるのは真の知恵ではなく知恵のようにみえるものでしかない。多くの事を知ってるようにみえるがたいていの場合何も知らない人になる。」 と「文字は記憶と知恵の秘訣を授けるものであるから、エジプトの民を賢くし記憶力を高めるであろう」と文字の有効性を説く技術の神テウトにエジプトの王は否定的な見方をする。「文字は人々の魂に忘れっぽさを植え付けるだろう。みずからのなかから思い出すのではなく、外に記されたものから呼び起こそうとするようになるだろう」</p>

<h3>技術の神テウトはGoogleになった</h3>

<p>5500年の時を経て技術の神テウトはインターネットに、Googleになった。</p>

<p>最初のマクルーハンの警鐘が思い起こされる。「脅威について無知であることの危険性」を語る人も出てきた。<sup><a href="#footnote_9_439" id="identifier_9_439" class="footnote-link footnote-identifier-link" title="Googleで人の記憶は変質する――米心理学者が発表 http://www.itmedia.co.jp/enterprise/articles/1107/15/news062.html">10</a></sup></p>

<p>警告を受け入れ、脳や自分たちの変質を拒否するために検索エンジンの過度な使用をやめるべきか？そんな事はできない。<br/>
「技術は我々の延長にあるが、その我々も技術の延長」にもうなっている。携帯電話と同じ。それらは単なる選択可能な１オプションではない、使い手を変容させるメッセージだ。しかし脅威について無知である必要はない。ではどうすれば。</p>

<p>僕が面白いと思うのはこのソクラテスの話を書き記したのがプラトンという事だ。ソクラテスは弁論家 <sup><a href="#footnote_10_439" id="identifier_10_439" class="footnote-link footnote-identifier-link" title="生涯に渡って著作がない">11</a></sup>でプラトンは書き手だ。</p>

<p>「うちなる考えを外なる記号に置き換える事によって、より浅い思考をするものにわれわれを変える恐れがある」というソクラテスの考えを共有しつつもプラトンは書き言葉の新しい可能性を認識していた。新しいメディアの脅威について警告を理解しつつ祝福もしていた。著作を残さなかったこのソクラテスの話を現代の我々が知る事ができるのは、そのテクノロジーをつかって文字として残したプラトンのおかげだ。</p>

<p>テウト神を警戒するエジプトの王の思慮深さは素晴らしいが、同時にプラトンのようでありたいと思った。崇拝でも否定でもなく、思慮深さを持ちつつ新しい可能性を見いだすところに本当の進歩があると思う。</p>

<p>タイトルの軽さから気楽に読み始めた本書は、脳科学という乗り物で人類と技術を旅する壮大な旅になった。ネット以前、ネット以後を経験した人類唯一の我々の世代全ての人にお勧めする。1964年のマクルーハンの警鐘に耳を傾けよう。</p>

<ol class="footnotes">
  <li id="footnote_0_439" class="footnote">
    いつか読もうと思ってるが僕はこのメディア論を読んだ事はない。しかし絶頂期でさえ読まれる事より引用される事の方が多かったそうだ。 [<a href="#identifier_0_439" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_1_439" class="footnote">
    http://ja.wikipedia.org/wiki/%E3%83%9E%E3%83%BC%E3%82%B7%E3%83%A3%E3%83%AB%E3%83%BB%E3%83%9E%E3%82%AF%E3%83%AB%E3%83%BC%E3%83%8F%E3%83%B3 [<a href="#identifier_1_439" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_2_439" class="footnote">
    外から成形されやすい [<a href="#identifier_2_439" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_3_439" class="footnote">
    つまり「ゲーム脳」とか言ってる人や記事を色眼鏡で見てた僕の認識にも&#8221;アップデート&#8221;が必要 [<a href="#identifier_3_439" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_4_439" class="footnote">
    こっちをもっと巻き込むような&#8230;そもそも自分達使用者は本当に選んでいるんだろうかという疑問もあった。 [<a href="#identifier_4_439" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_5_439" class="footnote">
    Miller （1956年）による「マジカルナンバー7±2」 [<a href="#identifier_5_439" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_6_439" class="footnote">
    短期記憶には感覚入力そのものの500msからせいぜい５秒程度の持続時間しか持たない非意識的な感覚記憶から、選択的注意を伴い意識化することで短期記憶貯蔵庫に15秒から30秒間保持されるものまで記憶保持時間に幅があります http://www.blog.crn.or.jp/report/04/52.html [<a href="#identifier_6_439" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_7_439" class="footnote">
    パイドロス http://ja.wikipedia.org/wiki/%E3%83%91%E3%82%A4%E3%83%89%E3%83%AD%E3%82%B9 [<a href="#identifier_7_439" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_8_439" class="footnote">
    僕はイランイラク国境に近いジグラットでこの楔型文字を見た事がある。その時の感動がこの対話を知った事で深まった。 [<a href="#identifier_8_439" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_9_439" class="footnote">
    Googleで人の記憶は変質する――米心理学者が発表 http://www.itmedia.co.jp/enterprise/articles/1107/15/news062.html [<a href="#identifier_9_439" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_10_439" class="footnote">
    生涯に渡って著作がない [<a href="#identifier_10_439" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
</ol>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/07/bear1-to-saturday/">BEAR1 to Saturday (2003, 2011)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-07-14T00:00:00+09:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/2011/07/bear1-to-saturday/#disqus_thread"
             data-disqus-identifier="http://koriym.github.io/2011/07/bear1-to-saturday/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><div style="float: right; margin-left: 10px;">
  <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" data-url="http://www.bear-project.net/blog/2011/07/bear1-to-saturday/">Tweet</a>
</div>


<h3>Sundayへ</h3>

<p>元々頭にあったBEARのラフなロードマップとしてv0.8までに機能的な実装を終え、v0.9でテストとパフォーマンスチューニング、リファクタリングを行いv1.0に繋げるというものでした。着々と続けてたのですが、（特にPHP 5.3に合わせた）PHPでの開発手法やwebアプリケーションフレームワーク世界の大きな潮流の変化を感じ、フルスクラッチで再構築する事を決めました。それをBEAR2にするのか、BEAR v1.0にするのか今はまだ未定ですが、そのコード名を”Sunday”にしました。（同時に現状今サービスしてるPHP5.2+のものが&#8221;Saturday&#8221;になりました。）</p>

<p>これを機会にこれまでを一度振り返って記録します。</p>

<h3>BEAR1</h3>

<p>最初のBEARの開発と利用は2003年12月です。自分でもびっくりするほど古いのですが、日本でMojaviが2004年後半から注目を集めたという事ですのでその１年前ぐらいです。</p>

<p>構成としてはページコントローラのシンプルなMVCのようなものでした。ページクラスをテンプレートパターンで必要メソッドを記述してメインクラスがページクラスをイベントに応じてコールし、ページの結果をHTMLとして出力する&#8230;そういう基本は今のBEARと同じです。</p>

<p>つまりメイン（クライアント）とページ（サービス）の分離が設計の中心です。モデルはクラス設計されてて、そのメソッド内（例えばUser::postEntry()）でPEAR::DBを使ってSQLを発行してました。テンプレートエンジンにはSmarty、ページャーにPEAR::Pagerなどを用い、認証にTCI(電話認証）を使う今で言う携帯専用のSNSです。</p>

<p>これはインスパイアされたり、お手本にしたものがありません。何も知りませんでした。フレームワークという言葉もMVCもこれをつくったずっと後で知りました。複数人数での開発と、webの処理フローの単純さから、こういうのがいいんじゃないかと思って作ったのがこの時のBEARです。 <sup><a href="#footnote_0_394" id="identifier_0_394" class="footnote-link footnote-identifier-link" title="PEARコンポーネントのグルー（当時言葉知りませんでしたが）が必要だとは思っていました。BEARの名前の由来の一つでもあります。">1</a></sup></p>

<p>なので自分のWebプログラミングのごく初期からフレームワークをつくってたということになります。</p>

<h3>旧Bear</h3>

<p>2005年5月19日にAUから携帯専用ブログDuo Blogがリリースされます<sup><a href="#footnote_1_394" id="identifier_1_394" class="footnote-link footnote-identifier-link" title="テレビCMでは仲間由紀恵がブログもできるよ！とCMしていました">2</a></sup> これに用いたのが&#8221;Bear&#8221;です。しかしこの時のBear<sup><a href="#footnote_2_394" id="identifier_2_394" class="footnote-link footnote-identifier-link" title="数年ぶりのPHP、Webプログラミング">3</a></sup> の反省は大きくリリース後に大改造を行い、アーキテクチャ的に今のに近い形にはなりました。まだ時代はPHP4です。</p>

<p>オブジェクトモデルを廃止して、自由にメソッドを持てないようにしました（統一インターフェイス）、その時のメソッドはたった２つ。「参照」と「アクション」だけでした。<sup><a href="#footnote_3_394" id="identifier_3_394" class="footnote-link footnote-identifier-link" title="これはモデルがあり、つまりDBの「ビュー」と「ストアドプロシージャ」です。PC用でASPのレガシープロジェクトをPHPでモバイル用に作り替えたときに、この構成の疎結合性が大変有効に機能するのに注目しました">4</a></sup>リクエストは状態を持たず（ステートレスリクエスト）、機能毎に名前があり（アドレス可能性）、処理は処理を呼ぶ事ができ（レイヤード）処理を直接は呼ばないでそのモデルアクセスクラスが間接的に呼ぶようになっていて機能名と引き数と状態を持たないので簡単にキャッシュがつくれました(ULC$SS=Uniform-Layered-Client-Cache-Stateless-Server) 。今考えるとリソース指向設計(ROA)の特徴の多くを持っていたのですが、まだそのときそういう言葉や概念を知らず、手探りで良い設計を求めていました。</p>

<p>つまりモデル部分を関数ファイルにしたのです。URIは要は関数名です。関数はステートレスです。キャッシュ化もレイヤー化も簡単です。独立性もあり、利用クライアント対してに内部技術の暴露はありません。時代はPHPもOOPという感じでしたが、このモデル部分に関しては完全に逆を行きクラスから関数にしました。</p>

<p>単純ですがこのアーキテクチャは機能しました。スコープは制限され、モジュラー性は高まり、複数人での作業もスムーズになりました。学習、コーディング、メンテ、CPU、コストが低下しパフォーマンスもあがったように思えました。携帯用で始めましたが、PCや途中でやってきたAJAXブームにも(prototype.jsで）対応しました。ROR / CakePHPの大波も来たのですがマイペースで開発を続けました。</p>

<h3>BEAR meets REST.</h3>

<p>ある日、山本陽平さんの<a href="http://yohei-y.blogspot.com/2005/04/rest_23.html">REST 入門 </a>を知りました。<sup><a href="#footnote_4_394" id="identifier_4_394" class="footnote-link footnote-identifier-link" title="2005年4月の新しいとはいえない記事ですがこの時まで知りませんでした。">5</a></sup></p>

<p>自分が考えてた事、経験を通じて知った事、BEARの基本設計部分ですがその全てに名前付き解説がされてる事を知ります。これはとてつもない衝撃でした。BEARはRESTfulとしてつくってのではなくRESTfulだったのです。良いのでは信じてた設計のほとんどはHTTPで実装されてたものでした。自分では解決できなかった問題の解答もすでにありました。HTTP/RESTのと偉大さを改めて知り、そろそろと考えていたPHP5対応に明確な指針が生まれました。「<a href="http://en.wikipedia.org/wiki/Resource-oriented_architecture">リソース指向アーキテクチャ</a>」です。</p>

<p>つまり、BEARは従来のMVCのアンチテーゼや、REST賛美から生まれた訳ではありません。アプリケーション要求と開発メンテ効率の最大化を求め、それを実践していて気がついたらRESTfulだったのです。</p>

<h3>Saturday</h3>

<h4>デザイン</h4>

<p>他のフレームワークに詳しい人や従来使ってた人に色々ヒアリングを行って追加機能も決めて行きました。例えば<a href="http://capsctrl.que.jp/kdmsnr/wiki/PofEAA/?TwoStepView">ツーステップビュー</a>などです。しかし不思議な事に他のフレームワークでは当たり前のフロントコントローラーやActive Record / ORMを検討してほしいという人はその時あまりいませんでした。それでもそれらを否定するものではなく、後から簡単にアドオンできるという目処があり標準で不採用は簡単に決まりました。</p>

<p>またリソースアクセスにhttpと同じようなURI<sup><a href="#footnote_5_394" id="identifier_5_394" class="footnote-link footnote-identifier-link" title="迷ったURIテンプレートの採用は見送りました">6</a></sup>を使う事にしました。これにより処理系をスキーマとして切り替える事ができ、今まで固定されていた「関数」というただ一つのモデル・アーキテクチャの依存から抜けることができました。これは過去に作成した関数リソースを無駄にしないだけでなく、別アーキテクチャのレガシーモデルも同じように扱えることを意味していました。</p>

<p>URIでモデルとコントローラを接続するのは単にCとMにAというラッパーを差し込もうというのとは別の話です。URIスキーマのスキーマは本当の意味でのスキーマ（式型、図式、形式、シェーマ=ドイツ語）になり、接続に異なったソフトウエアパラダイムを持ち込む事が可能になりました。</p>

<p>Active Recordなどコンポーネントの利用の簡単さと機能の豊富さを語る時代ですが、むしろ、その接続と入れ替え可能性に注力しようという方針も立てました。SQLを記述するのがいいか、ORMがいいのかではなく、それらが選択可能で等価的であるという事が重要だと考えました。RESTfulがそれを実現します。</p>

<h4>標準を選択</h4>

<p>コンポーネントはなるべく標準的なもの広く使われているようなものをを選択するように考えました。迷ったのは開発終了のPEAR::DBに変わりにPDOを使うかPEAR::MDB2を使うかです。より標準的なのはどちらでしょうか？エクステンションであるPDOにも思えます。</p>

<p>結局、より抽象化された拡張機能とPEAR::Pagerと相性の良さそうなMDB2にしたのですが<sup><a href="#footnote_6_394" id="identifier_6_394" class="footnote-link footnote-identifier-link" title="今ならDoctorine DBALでしょうか">7</a></sup>　しかし重要なのはアプリケーション開発者がMDB2不使用を決めた場合に、それがマイナスにならないという事です。その場合はリソースのMDB2の依存はゼロにならないと行けません。</p>

<p>コード規約、ファイル配置、命名規則、それら全てをより標準的なものを採用しようという方針もたてました。これは難しくありません、（規約などの）フレームワークとしてPEARには圧倒的なプレゼンスがあり、Zendも基本的にはそれを踏襲していました。SolarPHPもそうでそれらに習うだけです。<sup><a href="#footnote_7_394" id="identifier_7_394" class="footnote-link footnote-identifier-link" title="その点何故SymfonyやCakePHPがああいう俺俺規則なのかはさっぱり分かりませんでした。">8</a></sup> JSも標準で用意するbear,jsをprotyotype.jsベースからjQueryベースにしました。</p>

<h4>DI</h4>

<p>RESTと並んで初期に注力したのはDIです。今でもそうですが、PHPに要らないという意見が多くありまた色々な実装が出ては定着してないという現実もありました。しかし、最大の問題は「自分がよく分かってない」という事でした。（笑）<sup><a href="#footnote_8_394" id="identifier_8_394" class="footnote-link footnote-identifier-link" title="多くの解説記事は特定のDI実装と強く結ばれた話ばかりで、真の本質的なところや使用すべき用語がなかなか分かりませんでした。分離の原則を実現する技術の解説なのに皮肉な話です">9</a></sup></p>

<p>PHPでは標準的でもなく、自分が使った事もなく、要求もされてないソフトウエアパラダイムを採用に引かれたのはもちろん理由があります。旧Bearであった問題の解決と、方針として立てた「入れ替え可能性」です。</p>

<p>ライブラリを整備していくと、様々な要求があります。例えばiPhoneのページ用意されてなかったら、表示するのは携帯用でしょうか? PC用でしょうか？そういう一つ一つの設定、ロジックに様々な要求がある場合にグローバルdifineや、configファイルをどんどん増やして行ってユーザーが選択可能にしていくのがway to goでしょうか？フレームワークコードにバグがあれば、あるいは機能追加したければユーザーはどういう行動をとる事ができるのがベストでしょうか？</p>

<p>インスタンス管理にも不満がありました。DRYといいながら同じようなシングルトンコードが色々なクラスに存在します。</p>

<p>コンストラクタの引き数のデフォルトはどうやって決めたら良いでしょうか？クラスに直接かけば値がハードコードされてます。グローバルdefineを山のように書いてたのが旧Bearです。クラスを生成するとき > アプリケーションのデフォルト > フレームワークのデフォルトと優先順位をもって初期値を決めたい時に、旧来のnew演算子や各メソッドが実装するsingleton/factoryパターンでは限界がありました。<sup><a href="#footnote_9_394" id="identifier_9_394" class="footnote-link footnote-identifier-link" title="New Considered Harmfulという記事を読んだのもその頃です。">10</a></sup></p>

<p>またどういうDI実装がいいのかというのも大きな問題でした。旧来のやり方の弊害はJavaでも語られていました。JavaではXMLは「アジャイル」ですがPHPでは「コードの方がアジャイル」とも言えます。欲しいのは形式としての正しさよりその効果です。</p>

<h4>Solar::dependency()</h4>

<p>そこで大きく惹かれたのはPHP5専用フレームワークのSolarPHPの<a href="http://solarphp.org/manual:solar:dependency_injection">Dependency Injection</a>です。ただし、そのままではちょっとmagicすぎるという印象を持ち、そこでインジェクターメソッドというコンストラクトの後に呼ばれる注入メソッド（実際は初期化メソッド）を生成時に必ず呼ばれるようにし、そこで利用オブジェクトをサービスロケータ経由でPull（Dependency Pull)する仕組みのものを設計しました。そのメソッドは外部から選択可能です。生成時に呼ばれるという点ではコンストラクトインジェクションに近いものですが、選択可能であるという点でそのデメリットを補い、コンテナを不要にできるのではと考えました。</p>

<p>「いや、しかしクラス自身が依存オブジェクトをとってきてこれって注入..?」「外部インジェクターが使えるし&#8230;」色々思いましたが、しかし重要なのは外部から依存（利用）オブジェクトをコントロールできるのか？という事です。利用メソッドから見れば、どっかの誰かが準備してくれて、利用オブジェクトは準備されてます。それがコントロールできるのが重要です。言葉の厳密性に多少目をつぶりSolarPHPのDIの模倣し、より単純にしてDIが解決することを別のより簡単な手段で解決しようと試みました。</p>

<p>それともう一点、初学者がスムーズにたとえば模倣から入れるかということでした。</p>

<p>学習コストの低減は大きなテーマです。そこで「制御の反転って知ってますか？」「依存性の注入とはですねえ、DIコンテナってのがありまして」というようにパラダイムの説明抜きには入れなうような事態に抵抗がありました。「BEAR::dependencyってnewみたいなもんなんですよ、クラス名と初期値でオブジェクトが得られます。」という風に旧来のnew演算子からスムーズに入れそうな気がした事も採用動機になりました。</p>

<p>ほとんどをSolar::depedncy()から学びました。リスペクトもありメソッド名を変えずにそのままにしてます。最初に恩恵を受けたのはBEAR自身です。BEARではこの技術の適用範囲に制限を持ちませんでした。後にデバック用やテスト用の別コンポーネントを持つときにも大きな効用を発揮しました。</p>

<p>現在発表されているPHP5.3+用のフレームワークの多くにDI <sup><a href="#footnote_10_394" id="identifier_10_394" class="footnote-link footnote-identifier-link" title="またはDIの解決しようとする問題を解決する技術">11</a></sup>が導入されていて、この方針の方向性にある程度の確信が生まれます。また、DIの他にも以下のPHP5.3+フレームワークの多く（またはいくつか）で見られる特徴もありました。</p>

<ul>
<li>オートローダーOnly (PSR-0)</li>
<li>アノテーション</li>
<li>非フルスタック指向</li>
<li>非スタティックコール指向</li>
<li>ユニバーサルコンストラクタ</li>
<li>グローバルdefineの原則廃止</li>
<li>ミニマムレイテンシー（速度）の重視</li>
<li>遅延評価（レイジーロード）</li>
</ul>


<h4>リソースオブジェクト</h4>

<p>BEARで様々につかわれてるDTO（データー転送用オブジェクト）がRO（リソースオブジェクト）です。このDTOはcode,header, bodyといったリソースの値を保持するのも大きな役割ですが、リクエストに対する統一インターフェイスとリンク機能を備えてるのが特徴です。リソース内部で何が起ころうともクライアントには同じフォーマットのものが帰ってくるのはHTTPをモデルにしています。ユーザーのURI入力間違いだろうと、内部のサーバーエラーであろうとwebサーバーは同じフォーマット(code, header, body)のデータを処理するだけで、そのリクエスト状態に関心を持つことはありません。</p>

<p>新しく最もROA的に思えたの機能がリンクです。Aタグの無いWWW世界を想像してみてください。あるいは情報と情報の関係性を利用者側ですべて把握する必要がある情報システム。それらに命を吹き込むのがリンクです。その点、今のBEARのリンク実装はまだ大きなイノベーションの余地があると考えています。</p>

<h3>Saturday公開</h3>

<p>2008年7月31日に初めてBEARを外部に公開します。PHP5.2対応の初のリリースです。<br/>
最初の動機はごく単純で、社内リポジトリ/wikiだと外注さんが見れないというものでした。</p>

<h3>そしてSundayへ</h3>

<p>ここまでが簡単にまとめた「BEARの今まで」です。<br/>
これまでの成果と反省をしROAを再確認しつつSundayに繋げたいと思っています。</p>

<p>そのために現在起こっているWebアプリケーションの開発手法の変化、アプリケーション要求、クライアントとアウトプットの多様化、PHPの言語仕様等、ソフトウエア設計の外側の世界もバランスのとれた態度を示さなければなりません。解決としてのRESTfulがその解答になると思っています。</p>

<ol class="footnotes">
  <li id="footnote_0_394" class="footnote">
    PEARコンポーネントのグルー（当時言葉知りませんでしたが）が必要だとは思っていました。BEARの名前の由来の一つでもあります。 [<a href="#identifier_0_394" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_1_394" class="footnote">
    テレビCMでは仲間由紀恵がブログもできるよ！とCMしていました [<a href="#identifier_1_394" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_2_394" class="footnote">
    数年ぶりのPHP、Webプログラミング [<a href="#identifier_2_394" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_3_394" class="footnote">
    これはモデルがあり、つまりDBの「ビュー」と「ストアドプロシージャ」です。PC用でASPのレガシープロジェクトをPHPでモバイル用に作り替えたときに、この構成の疎結合性が大変有効に機能するのに注目しました [<a href="#identifier_3_394" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_4_394" class="footnote">
    2005年4月の新しいとはいえない記事ですがこの時まで知りませんでした。 [<a href="#identifier_4_394" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_5_394" class="footnote">
    迷ったURIテンプレートの採用は見送りました [<a href="#identifier_5_394" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_6_394" class="footnote">
    今ならDoctorine DBALでしょうか [<a href="#identifier_6_394" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_7_394" class="footnote">
    その点何故SymfonyやCakePHPがああいう俺俺規則なのかはさっぱり分かりませんでした。 [<a href="#identifier_7_394" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_8_394" class="footnote">
    多くの解説記事は特定のDI実装と強く結ばれた話ばかりで、真の本質的なところや使用すべき用語がなかなか分かりませんでした。分離の原則を実現する技術の解説なのに皮肉な話です [<a href="#identifier_8_394" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_9_394" class="footnote">
    <a href="http://c2.com/cgi/wiki?NewConsideredHarmful">New Considered Harmful</a>という記事を読んだのもその頃です。 [<a href="#identifier_9_394" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_10_394" class="footnote">
    またはDIの解決しようとする問題を解決する技術 [<a href="#identifier_10_394" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
</ol>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/05/php%e3%82%82%e3%82%84%e3%82%89%e3%81%aa%e3%81%8d%e3%82%83jenkins/">PHPもやらなきゃJenkins</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-05-20T00:00:00+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/2011/05/php%e3%82%82%e3%82%84%e3%82%89%e3%81%aa%e3%81%8d%e3%82%83jenkins/#disqus_thread"
             data-disqus-identifier="http://koriym.github.io/2011/05/php%e3%82%82%e3%82%84%e3%82%89%e3%81%aa%e3%81%8d%e3%82%83jenkins/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><div style="float: right; margin-left: 10px;">
  <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" data-url="http://www.bear-project.net/blog/2011/05/php%e3%82%82%e3%82%84%e3%82%89%e3%81%aa%e3%81%8d%e3%82%83jenkins/">Tweet</a>
</div>


<p><a href="http://www.bear-project.net/blog/wp-content/uploads/2011/05/2793401dfcd60fa8778cab5a1524cd8f.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/05/2793401dfcd60fa8778cab5a1524cd8f.png" alt="" title="Jenkins" width="415" height="147" class="alignnone size-full wp-image-376" /></a>
改名なのかフォークなのか、とにかくHudsonプロジェクトはHudsonとJenkinsに分かれました。（開発者はフォークではなく改名と主張していて、この辺りの話はinfoQが詳しいようです。<a href="http://www.infoq.com/jp/hudson">http://www.infoq.com/jp/hudson</a> )<br/>
※前回の記事で紹介したphp-hudson-template はphp-jenkins-template に変わっています。</p>

<p>またPHPUnitで有名なSebastian氏がbuld.xmlを自動で作成してくれるPPW (<a href="https://github.com/sebastianbergmann/php-project-wizard">PHP Project Wizard </a>)というツールをリリースして、面倒だったプロジェクトの設定ファイルbuld.xmlの作成がとても簡単になりました。</p>

<p>Sebastian氏は<a href="http://jenkins-php.org/">http://jenkins-php.org/</a>というPHPでJenkinsを使うためのガイドをするサイトも用意しています。以下はその補足です。</p>

<h3>Jenkins インストール</h3>

<h4>本体</h4>

<ol>
<li>Jenkinsをインストール<br/>
<a href="http://jenkins-ci.org/">Jenkins公式サイト http://jenkins-ci.org</a>あらダウンロードしてインストールします。Windows/OSX/Ubuntu等のネイティブインストーラーもあるのでそれを利用するのがいいんじゃないでしょうか。自分はOSXのネイティブインストーラを使用しました。以下の例はOSXでのものです。</li>
</ol>


<p>起動はCLIで行います。<br/>
<code>
$ java -jar /Applications/Jenkins/jenkins.war
</code></p>

<p><a href="http://localhost:8080%E3%81%A7Jenkins%E3%81%AE%E7%94%BB%E9%9D%A2%E3%81%8C%E7%A2%BA%E8%AA%8D%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%AF%E3%81%9A%E3%81%A7%E3%81%99%E3%80%82">http://localhost:8080%E3%81%A7Jenkins%E3%81%AE%E7%94%BB%E9%9D%A2%E3%81%8C%E7%A2%BA%E8%AA%8D%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%AF%E3%81%9A%E3%81%A7%E3%81%99%E3%80%82</a></p>

<p>続いてJenkins用プラグインをインストールをします</p>

<p><code>
wget http://localhost:8080/jnlpJars/jenkins-cli.jar
java -jar jenkins-cli.jar -s http://localhost:8080 install-plugin checkstyle
java -jar jenkins-cli.jar -s http://localhost:8080 install-plugin clover
java -jar jenkins-cli.jar -s http://localhost:8080 install-plugin dry
java -jar jenkins-cli.jar -s http://localhost:8080 install-plugin htmlpublisher
java -jar jenkins-cli.jar -s http://localhost:8080 install-plugin jdepend
java -jar jenkins-cli.jar -s http://localhost:8080 install-plugin plot
java -jar jenkins-cli.jar -s http://localhost:8080 install-plugin pmd
java -jar jenkins-cli.jar -s http://localhost:8080 install-plugin violations
java -jar jenkins-cli.jar -s http://localhost:8080 install-plugin xunit
java -jar jenkins-cli.jar -s http://localhost:8080 install-plugin git
java -jar jenkins-cli.jar -s http://localhost:8080 safe-restart
mv jenkins-cli.jar /Applications/Jenkins/
</code></p>

<p>次はPHPのツールです。</p>

<p><code>
sudo pear channel-discover pear.pdepend.org
sudo pear channel-discover pear.phpmd.org
sudo pear channel-discover pear.phpunit.de
sudo pear channel-discover components.ez.no
sudo pear channel-discover pear.symfony-project.com
sudo pear install pdepend/PHP_Depend
sudo pear install phpmd/PHP_PMD
sudo pear install phpunit/phpcpd
sudo pear install phpunit/phploc
sudo pear install PHPDocumentor
sudo pear install PHP_CodeSniffer
sudo pear install --alldeps phpunit/PHP_CodeBrowser
sudo pear install --alldeps phpunit/PHPUnit
sudo pear install phpunit/ppw
</code></p>

<h4>PHP Project Wizard (PPW)を使ってbuild.xmlを作成</h4>

<p>プロジェクト用の設定ファイルbuild.xmlファイルを作成します。リポジトリに対して一つ用意します。通常はパッケージのトップディレクトリに配置します。</p>

<p>作成はPPWというツールを使えば簡単です。</p>

<p>例えばzf2の場合はbuild.xmlが用意されていませんが、下記のようにppwコマンドでzf2/build.xmlとzf2/phpunit.xml.distが作成できます。</p>

<p><code>
$ git clone git://git.zendframework.com/zf.git zf2
$ cd zf2
$ ppw -name zf2 --source library/Zend/Acl --tests tests/Zend/Acl/ --bootstrap tests/Bootstrap.php --phpcs Zend .
</code></p>

<p>Wrote build script for Apache Ant to ./build.xml<br/>
Wrote configuration for PHPUnit to ./phpunit.xml.dist</p>

<p><code>
$ cd zf2
$ ant
</code><br/>
buildがうまくできると、zf2/build/に出力結果が保存されます。作成されたcode browserを開いてみましょう。<br/>
<code>
$ open build/code-browser/index.html
</code><br/>
<a href="http://www.bear-project.net/blog/wp-content/uploads/2011/05/0b7a8c9337217359309b72646469bd89.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/05/0b7a8c9337217359309b72646469bd89-300x83.png" alt="" title="CodeBrowser" width="300" height="83" class="alignnone size-medium wp-image-372" /></a><br/>
Jenkinsで試す前にまずantでbuildができるか試してみるのがいいと思います。</p>

<h3>Jenkinsでプロジェクト作成</h3>

<h4>プロジェクトのテンプレート作成</h4>

<p>jobフォルダにgitでプロジェクトテンプレートを用意します。</p>

<p><code>
$ cd ~/.hudson/jobs
$ git clone git://github.com/sebastianbergmann/php-jenkins-template.git php-template
$ java -jar /Applications/Jenkins/jenkins-cli.jar -s http://localhost:8080 reload-configuration
</code></p>

<h3>新規プロジェクト作成</h3>

<p>利用可能にしたプロジェクトテンプレートを指定して、新規プロジェクトを作成します。</p>

<p><a href="http://www.bear-project.net/blog/wp-content/uploads/2011/05/70b01b700a5d3988c82ac32f33a03345.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/05/70b01b700a5d3988c82ac32f33a03345.png" alt="" title="新規プロジェクト" width="586" height="431" class="alignnone size-full wp-image-370" /></a>
次の画面で、ビルド無効化 のチェックを外し、ソースコード管理システムを編集してソースコードレポジトリ情報を設定します。プロジェクト設定を保存し、ビルドを実行します。</p>

<p><a href="http://www.bear-project.net/blog/wp-content/uploads/2011/05/40103152c2ea101b4041d7d00f05f97f.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/05/40103152c2ea101b4041d7d00f05f97f.png" alt="" title="新規プロジェクト" width="544" height="293" class="alignnone size-full wp-image-392" /></a></p>

<h3>まとめ</h3>

<ul>
<li>HudsonはJenkinsに</li>
<li>Sebastian氏がppwというbuild.xml作成ツールとプロジェクトテンプレートを用意し利用が楽に</li>
<li>PHPコミュニティに多大な貢献をしてる氏に感謝</li>
<li>CIしよう</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/01/php%e3%82%82%e3%82%84%e3%82%89%e3%81%aa%e3%81%8d%e3%82%83hudson/">PHPもやらなきゃHudson</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-01-17T00:00:00+09:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/2011/01/php%e3%82%82%e3%82%84%e3%82%89%e3%81%aa%e3%81%8d%e3%82%83hudson/#disqus_thread"
             data-disqus-identifier="http://koriym.github.io/2011/01/php%e3%82%82%e3%82%84%e3%82%89%e3%81%aa%e3%81%8d%e3%82%83hudson/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><div style="float: right; margin-left: 10px;">
  <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" data-url="http://www.bear-project.net/blog/2011/01/php%e3%82%82%e3%82%84%e3%82%89%e3%81%aa%e3%81%8d%e3%82%83hudson/">Tweet</a>
</div>


<h3>Hudsonとは</h3>

<p>Hudsonとは「継続的インテグレーションサーバー」です。継続的インテグレーションとは</p>

<blockquote><p>Extreme Programmingに端を発し，Martin Fowlerによって広められた概念で，狭義には，別々に開発された部品を持ち寄ってお互いの動作を検証する「統合テスト」を早い段階から恒常的に行うことを指します。</p></blockquote>

<p><a href="http://gihyo.jp/dev/feature/01/hudson/0001">Hudsonを使ったアジャイルな開発入門</a>より</p>

<p>原文: <a href="http://www.martinfowler.com/articles/continuousIntegration.html">Continuous Integration</a></p>

<p><a href="http://wiki.hudson-ci.org/display/JA/Meet+Hudson">公式サイト</a>からも説明を引用します。</p>

<blockquote><p>Hudsonは、ソフトウェアのビルドやcronで起動するジョブなどの繰り返しのジョブの実行を監視します。これらのうち、Hudsonは現在次の2つのジョブに重点を置いています。</p>

<ol>
<li>継続的なソフトウェアプロジェクトのビルドとテスト: つまり、CruiseControlやDamageControlが行うこと。 一言で言えば、Hudsonは、容易ないわゆる「継続インテグレーションシステム」を提供し、開発者が変更をプロジェクトに統合でき、ユーザーがより新しいビルドを容易に取得できるようにします。自動化された継続的なビルドは、生産性を向上させます。</li>
<li>外部で起動するジョブの実行監視: cronによるジョブやprocmailのジョブで、リモートマシンで動作するものも含みます。例えばcronについて言えば、出力をキャプチャーした定期的なメールだけ受信し、こつこつとそれを見ます。おかしくなっていることに気がつくかどうかは、すべてあなた次第です。Hudsonは出力を保存し、 いつおかしくなったのか容易に把握することができるようになります。</li>
</ol>
</blockquote>

<p>PHPの実行にコンパイルは必要ありません。では動的言語のPHPが必要とするビルドとはなんでしょうか？</p>

<p>HudsonはAPIドキュメントの作成やユニットテスト、コード解析ツール、コード重複発見ツールなど開発支援ツールやソフトウエア品質向上のためのソフトウエアを自動実行しレポートにまとめ、CI (継続的インテグレーション) システムとして機能します。</p>

<p>具体的にはレポジトリからソースを取得し、各種テストやソフトウエア品質解析ツールを実行し、その出力をまとめ管理します。</p>

<p>以下の作業がクリック一つあるいは定期的に実行され、その結果や履歴をwebで確認することができます。</p>

<ul>
<li>ユニットテスト</li>
<li>テストカバレッジ</li>
<li>コード規約チェック</li>
<li>重複コードチェック</li>
<li>ドキュメント作成</li>
<li>ソフトウエアメトリクス（品質測定）</li>
<li>コード分析</li>
</ul>


<h4>※ソフトウエアメトリクスとは？</h4>

<p>以下のリンクをご覧ください</p>

<ul>
<li><a href="http://ja.wikipedia.org/wiki/%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2%E6%B8%AC%E5%AE%9A%E6%B3%95">ソフトウェア測定法</a></li>
<li><a href="http://sel.ist.osaka-u.ac.jp/research/metrics/index.html.ja">ソフトウェアメトリクスを用いた品質の測定 </a></li>
<li><a href="http://www.atmarkit.co.jp/farc/rensai/matrix01/matrix01.html">初めてのソフトウェアメトリクス</a></li>
</ul>


<p>またソフトウエアメトリクスには様々な議論があるようです。</p>

<ul>
<li><a href="http://monoist.atmarkit.co.jp/fembedded/articles/kumikomi/24/kumikomi24.html">人類初のソフトウェア・メトリクスをめぐる熱い論争</a></li>
<li><a href="http://blogs.itmedia.co.jp/hiranabe/2009/07/---by-tom-demar.html">「測定できないものは制御できない｣は誤りだった。&#8211; by Tom Demarco</a></li>
</ul>


<h4>Hudsonのインストール</h4>

<p><a href="http://hudson-ci.org/">Hudson公式サイト http://hudson-ci.org/ </a>からDownload hudson.warの hudson.warファイルをダウンロードします。</p>

<div>
  <a href="http://www.bear-project.net/blog/wp-content/uploads/2011/01/eb23ae8f6239679043672e2cd44b66c6.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/01/eb23ae8f6239679043672e2cd44b66c6-300x184.png" alt="Download hudoson.war" title="Download hudoson.war" width="300" height="184" class="alignleft size-medium wp-image-292" /></a>
</div>


<p><br clear="all" /></p>

<h5>起動</h5>

<p><code>
$ java -jar /Applications/hudson.war
</code><br/>
<a href="http://localhost:8080/">http://localhost:8080/</a> で確認します。こんな画面でHudson先生が出現するはずです。</p>

<div id="attachment_304" class="wp-caption alignleft" style="width: 276px">
  <a href="http://www.bear-project.net/blog/wp-content/uploads/2011/01/82bcd49cff20ac5868fefae9eed0aef4.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/01/82bcd49cff20ac5868fefae9eed0aef4-266x300.png" alt="立ち上げたまま" title="Hudson初期画面" width="266" height="300" class="size-medium wp-image-304" /></a><p class="wp-caption-text">
    立ち上げた直後のHudson実行画面

</div>


<p><br clear="all" /></p>

<h4>必要なHudsonプラグインのインストール</h4>

<p>CI（継続開発)のためのテストや品質測定ツールをインストールします。様々なプラグインがありますが、ここでは以下のHudsonプラグインをインストールします。またそれぞれのプラグインはPHPのライブラリに依存し、別途PEARでのインストールが必要です。</p>

<ul>
<li><p>xUnit (for processing PHPUnit logfiles in JUnit format)<br/>
ユニットテスト（自動化テスト）<br/>
<a href="http://www.phpunit.de/manual/3.6/ja/automating-tests.html">http://www.phpunit.de/manual/3.6/ja/automating-tests.html</a></p></li>
<li><p>Clover (for processing PHPUnit code coverage xml output)<br/>
ユニットテストカバレッジツール（ユニットテストがカバーしてる範囲のコードを検出）<br/>
<a href="http://www.phpunit.de/manual/3.6/ja/code-coverage-analysis.html">http://www.phpunit.de/manual/3.6/ja/code-coverage-analysis.html</a></p></li>
<li><p>Checkstyle (for processing PHP_CodeSniffer logfiles in Checkstyle format)<br/>
コーディング規約のチェック<br/>
<a href="http://pear.php.net/manual/ja/package.php.php-codesniffer.php">http://pear.php.net/manual/ja/package.php.php-codesniffer.php</a></p></li>
<li><p>DRY (for processing phpcpd logfiles in PMD-CPD format)<br/>
重複コードのチェック<br/>
<a href="https://github.com/sebastianbergmann/phpcpd">https://github.com/sebastianbergmann/phpcpd</a></p></li>
<li><p>JDepend (for processing PHP_Depend logfiles in JDepend format)<br/>
メトリクス計測（依存関係や抽象化などのソフトウエアの品質測定）ツール <a href="http://pdepend.org/screenshots/full/jdepend.html">http://pdepend.org/screenshots/full/jdepend.html</a></p></li>
<li><p>PMD (for processing phpmd logfiles in PMD format)<br/>
コード分析ツール（バグの可能性や使用されえないコードの検出等）<br/>
<a href="http://pmd.sourceforge.net/">http://pmd.sourceforge.net/</a></p></li>
</ul>


<p>その他以下のプラグインも結果表示等のためにインストールします。</p>

<ul>
<li>HTML Publisher (for publishing the PHPUnit code coverage report, for instance)</li>
<li>Template Project (for using php-hudson-template as a template for Hudson jobs)</li>
<li>Violations (for processing various logfiles)</li>
</ul>


<p>立ち上げたHudoson CIサーバーをから以下のコマンドでインストールします。</p>

<p><code>
$ sudo java -jar hudson-cli.jar -s http://localhost:8080 install-plugin checkstyle dry htmlpublisher jdepend pmd template-project violations xunit clover
</code></p>

<p>Installing checkstyle from update center<br/>
Installing dry from update center<br/>
Installing htmlpublisher from update center<br/>
Installing jdepend from update center<br/>
Installing pmd from update center<br/>
Installing template-project from update center<br/>
Installing violations from update center<br/>
Installing xunit from update center<br/>
Installing clover from update center</p>

<h3>PHPのツールのインストール</h3>

<p>Hudsonプラグインが必要とする出力する（多くはXML）PHPのツールです。全てPEARパッケージでインストールします。</p>

<p><code>
pear channel-discover pear.pdepend.org
pear channel-discover pear.phpmd.org
pear channel-discover pear.phpunit.de
pear channel-discover components.ez.no
pear channel-discover pear.symfony-project.com
pear install pdepend/PHP_Depend-beta
pear install phpmd/PHP_PMD-alpha
pear install phpunit/phpcpd
pear install PHPDocumentor
pear install PHP_CodeSniffer
pear install --alldeps phpunit/PHP_CodeBrowser-alpha
pear install --alldeps phpunit/PHPUnit
</code></p>

<h3>build.xml</h3>

<p>buildを行うために各ツールの設定等を記したxmlファイル build.xmlを作成します。<br/>
<a href="http://www.phpunit.de/manual/3.6/ja/code-coverage-analysis.html">https://github.com/sebastianbergmann/php-hudson-template/blob/master/README.markdown</a>のbuild.xmlファイル(<a href="https://github.com/sebastianbergmann/php-object-freezerl">sebastianbergmann氏のOject Freezer</a>というパッケージ用のもの）を参考にし自分が対象とするパッケージ用のbuil.xmlを作成します。デフォルトのパスは &#8220;リポジトリルート/build.xml&#8221; です。</p>

<p>それぞれのツールのマニュアルを参照してbuild.xml内の引数を設定します。</p>

<p>※例えばコード規約の設定をPEARにしたいのならphpcsのセクションを以下のようにします。</p>

<p><code>
 &lt;!-- Generate checkstyle.xml --&gt;
 &lt;target name="phpcs"&gt;
  &lt;exec executable="phpcs" output="/dev/null"&gt;
   &lt;arg line="--report=checkstyle
              --report-file=${basedir}/build/logs/checkstyle.xml
              --standard=PEAR
              BEAR" /&gt;
  &lt;/exec&gt;
 &lt;/target&gt;
</code></p>

<h3>Hudsonでプロジェクト作成</h3>

<p>まずphp-hudson-templateというSebastian氏作成のプロジェクトテンプレートをgitで取得します。<br/>
これはプロジェクトの設定のひな形です。使用しないで全て手動で設定する事も可能です。</p>

<p>$ cd ~/.hudson/jobs<br/>
$ git clone git://github.com/sebastianbergmann/php-hudson-template.git</p>

<p><a href="https://github.com/sebastianbergmann/php-hudson-template">php-hudson-template</a>に掲載されている&#8221;Use publishers from another project &#8220;の方法では何故かうまくいかなかったので、ひな形をコピーして新規作成。</p>

<ul>
<li>Hudsonをリスタート</li>
<li>「既存ジョブのコピー」でphp-hudson-templateを入力して作成。これができないときは上記のgitでの取得ができていない。</li>
<li>&#8220;ソースコード管理システム&#8221; を指定</li>
<li>Ant-based build を設定</li>
</ul>


<p>それでもphpmdがうまくいかない。antをコマンドラインで実行してみる。</p>

<p><code>
$ cd ~/.hudson/jobs/&lt; プロジェクトフォルダ&gt;/workspace
$ ant phpmd
phpmd:
     [exec] Invalid field modifiers given, allowed modifiers are IS_PUBLIC, IS_PROTECTED, IS_PRIVATE and IS_STATIC.
     [exec] Result: 1
</code></p>

<p>とエラーがでる。<br/>
恐らくPEAR等のPHP4コードで修飾子がついてないところで例外が出てるのではと当たりをつけてみる。とりあえず消極的解決法として該当例外をコメントアウト。</p>

<p>/pdepend/PHP/Depend/Code/ASTFieldDeclaration.php<br/>
のsetModifiers()メソッド内の例外スローをコメントアウト<br/>
<code>
if (($expected &amp;#038; $modifiers) !== 0) {
            //throw new InvalidArgumentException(
            //    'Invalid field modifiers given, allowed modifiers are ' .
            //    'IS_PUBLIC, IS_PROTECTED, IS_PRIVATE and IS_STATIC.'
            //);
        }
</code><br/>
再度$ ant phpmd</p>

<p>BUILD SUCCESSFUL<br/>
Total time: 1 second</p>

<p>通った。~/.hudson/build/logs/pmd.xmlも作成されている。</p>

<h3>build成功</h3>

<p>以下はbuild成功した各ツールの結果画面です。</p>

<p><a href="http://www.bear-project.net/blog/wp-content/uploads/2011/01/90ff1f438f2e7acc851d08c62867949d.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/01/90ff1f438f2e7acc851d08c62867949d-261x300.png" alt="" title="build後" width="261" height="300" class="alignnone size-medium wp-image-323" /></a>
API Document<br/>
<a href="http://www.bear-project.net/blog/wp-content/uploads/2011/01/40a3a66f9aaf409e6d62264e99556fe0.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/01/40a3a66f9aaf409e6d62264e99556fe0-300x270.png" alt="" title="API Document" width="300" height="270" class="alignnone size-medium wp-image-325" /></a></p>

<p>Code Browser<br/>
<a href="http://www.bear-project.net/blog/wp-content/uploads/2011/01/a8227702a20d9446c485bc09cff35353.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/01/a8227702a20d9446c485bc09cff35353-300x261.png" alt="" title="Code Browser" width="300" height="261" class="alignnone size-medium wp-image-326" /></a></p>

<p>Code Coverage</p>

<p><a href="http://www.bear-project.net/blog/wp-content/uploads/2011/01/87cab7dce81d9abce4a58eb9f6dac4dc.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/01/87cab7dce81d9abce4a58eb9f6dac4dc-300x185.png" alt="" title="Code Coverage" width="300" height="185" class="alignnone size-medium wp-image-328" /></a>
PMD警告<br/>
<a href="http://www.bear-project.net/blog/wp-content/uploads/2011/01/cced4ef642dea3aae6d0843de93717db.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/01/cced4ef642dea3aae6d0843de93717db-300x288.png" alt="" title="PMD警告" width="300" height="288" class="alignnone size-medium wp-image-329" /></a></p>

<p>重複コード警告<br/>
<a href="http://www.bear-project.net/blog/wp-content/uploads/2011/01/5f71355fb746159fbda0ce6c9d593f24.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/01/5f71355fb746159fbda0ce6c9d593f24-300x202.png" alt="" title="重複コードチェック" width="300" height="202" class="alignnone size-medium wp-image-330" /></a></p>

<p>メトリックス1<br/>
<a href="http://www.bear-project.net/blog/wp-content/uploads/2011/01/fd0c1007332b4677c37ecae945f35016.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/01/fd0c1007332b4677c37ecae945f35016-300x188.png" alt="" title="メトリックス" width="300" height="188" class="alignnone size-medium wp-image-331" /></a></p>

<p><a href="http://www.bear-project.net/blog/wp-content/uploads/2011/01/76da52c53bb19b3ee0335981f4f076bb.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/01/76da52c53bb19b3ee0335981f4f076bb-271x300.png" alt="" title="メトリックス" width="271" height="300" class="alignnone size-medium wp-image-332" /></a>
ユニットテスト<br/>
<a href="http://www.bear-project.net/blog/wp-content/uploads/2011/01/ab08fd2e005c0db6ef6b641348d6d9da.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2011/01/ab08fd2e005c0db6ef6b641348d6d9da-300x136.png" alt="" title="スクリーンショット（2011-01-17 16.24.33）" width="300" height="136" class="alignnone size-medium wp-image-334" /></a></p>

<h3>リンク</h3>

<ul>
<li><p><div style="width:425px" id="__ss_3362460">
  <strong style="display:block;margin:12px 0 4px"><a href="http://www.slideshare.net/klab/llhudson" title="LL言語でもHudsonを使おう!">LL言語でもHudsonを使おう!</a></strong> <div style="padding:5px 0 12px">
    View more <a href="http://www.slideshare.net/">presentations</a> from <a href="http://www.slideshare.net/klab">KLab株式会社</a>.
  </div>
</div></p></li>
<li><p><a href="http://gihyo.jp/dev/feature/01/hudson/0001">Hudsonを使ったアジャイルな開発入門</a></p></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/09/gdd-2010-pacman%e5%95%8f%e9%a1%8c/">GDD 2010 Pacman問題</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2010-09-17T00:00:00+09:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2010</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/2010/09/gdd-2010-pacman%e5%95%8f%e9%a1%8c/#disqus_thread"
             data-disqus-identifier="http://koriym.github.io/2010/09/gdd-2010-pacman%e5%95%8f%e9%a1%8c/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><div style="float: right; margin-left: 10px;">
  <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" data-url="http://www.bear-project.net/blog/2010/09/gdd-2010-pacman%e5%95%8f%e9%a1%8c/">Tweet</a>
</div>


<p><a href="http://www.bear-project.net/blog/wp-content/uploads/2010/09/gddpacmanlv3.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2010/09/gddpacmanlv3-300x185.png" alt="GDD 2010 Pacman Lv.3" title="GDD 2010 Pacman Lv.3" width="300" height="185" class="size-medium wp-image-133" /></a></p>

<h3>GDD 2010 Dev Quiz</h3>

<p>GDD2010のDev Quizの最終問題Pacman。DevQuizは見事不合格に終わったのですが、挑戦の記録というのと、提出後ですがLv.3が解けるようになったので記念に記します。</p>

<h3>PHPで</h3>

<p>普段使っているPHPでコーディングしました。WebではなくCLIです。1ファイルでコンソールでアニメが表示されるようにしました。現在のコードでのハイスコアはLv1, Lv2, Lv3それぞれ、41, 210, 489です。これは人の手をともわなないAI探索のみでのスコアです。</p>

<p><a href="http://www.bear-project.net/blog/wp-content/uploads/2010/09/pacman_lv3.mov">Pacman Lv.3 demo</a><sup><a href="#footnote_0_112" id="identifier_0_112" class="footnote-link footnote-identifier-link" title="この動画はAIによる移動です。再現プレイではありません。">1</a></sup></p>

<h3>Pacman AI</h3>

<p>最初にPacmanに適当な移動ロジックを組み込んでモンスターのいない迷路でドットが全部とれるかというところから始めました。</p>

<p>「誘惑に弱いけど好奇心が強く、失敗してもすぐに反省する」</p>

<p>こういうのどうだろう。Pacmanに性格をつけしてAIっぽい動きすれば面白いんじゃないかと。つまり&#8230;</p>

<ul>
<li>誘惑に弱い=隣接するドットを食べること優先</li>
<li>好奇心=足跡を記録してなるべく行っていないところに行く</li>
<li>すぐに反省＝反復強化学習</li>
</ul>


<p>こんな感じです。実装にうつります。</p>

<p>まず移動可能な場所（上下左右、０〜４カ所）を調べます。０〜2カ所なら自動的に決めます。</p>

<p>０カ所＝動けないので停止。<br/>
１カ所＝その方向に移動。<br/>
２カ所＝来た方向と逆の方向に（途中で反転しない）</p>

<p>※基本的にモンスターと同じです。</p>

<p>３、４カ所ある場合</p>

<p>移動可能な場所のうち、次の優先順位で方向を決めました。</p>

<ul>
<li>隣接するところにエサがあればその方向</li>
<li>隣接するところで一回しか行ってなければその方向</li>
<li>直線でエサが見えればその方向</li>
<li>上記のどれにもあたらなければランダム</li>
</ul>


<p>とりあえずこんなもので、この優先順位を変えたりできる仕組みもあればと。</p>

<h3>モンスターのいない迷路を走らせてみる</h3>

<p>迷路を自走させてみるとそれなりに効率的に走りドットを全て食べてくれます。ちょっと安心。<br/>
パックマンというより<a href="http://twitpic.com/2gmm04">自走式掃除機ルンバのような動き</a>です。みててなかなか面白い。</p>

<p>あとはモンスター&#8230;どうだろ？</p>

<p>モンスターは基本、壁と考えてみる。単にその場所にいけないという点で壁と同じ。つまりパックマン視点だと迷路が１フレーム単位で変化するようなもの。</p>

<p>元々迷路全体をしっかり把握してるわけでなし、上記のその場その場のロジックでドットが全部食べれるのだからまあ何万回も走らしたら全部適当に食べてくれるだろう&#8230;と。<sup><a href="#footnote_1_112" id="identifier_1_112" class="footnote-link footnote-identifier-link" title="結局その見通しは大甘でした">2</a></sup></p>

<h3>モンスターを組み込んでみる</h3>

<p>取りかかるとパックマン自走のコーディングのヒントと思えるようなとこが多々あり&#8230;先にモンスターからやれば良かったとすぐに気づきます。orz</p>

<p>パックマン自走コードにも手をなおしつつ、それでも一つ一つモンスターを組み込みます。</p>

<p>例えば敵V<sup><a href="#footnote_2_112" id="identifier_2_112" class="footnote-link footnote-identifier-link" title="AKABE?">3</a></sup> はこんな感じ。</p>

<blockquote><p>敵 V</p>

<ul>
<li><p>敵から見た自機の相対位置を (dx, dy) と表すものとします。次のルールを上から順に適用し、最初に選ばれた方向に移動します。</p></li>
<li><p>dy ≠ 0 でかつ dy の符号方向にあるマスが進入可能であれば、その方向に移動します。</p></li>
<li>dx ≠ 0 でかつ dx の符号方向にあるマスが進入可能であれば、その方向に移動します。</li>
<li>現在位置の 下、左、上、右 の順で最初に進入可能なマスの方向に移動する。</li>
</ul>
</blockquote>

<p>こういうABSでの割り算で方向を出すとか、中学生の時にBASICで書いて以来かも&#8230;とか懐かしみながら組み込んで行きます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$ddy</span> <span class="o">=</span> <span class="nv">$dy</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="nv">$dy</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>敵L、敵R</h3>

<p>面倒そうなモンスターのロジックが出てきました。現在の方向からみての右、左です。</p>

<blockquote><p>敵 L</p>

<p>現在位置への進入方向から見て相対的に 左、前、右 の順で最初に進入可能なマスの方向に移動します。</p></blockquote>

<p>「右向いてるキャラの左は上」を求めるような実装です。普段しているWebのプログラミングで現在の方向からの相対的な「右」とか「左」は中々でてきません。</p>

<p>どうしようか、「もし今右を向いてたら、”右”は下方向」「下を向いてたら右は&#8230;」こういうのを４つ書くかなあ&#8230;いや&#8230;</p>

<p>&#8230;それもちょっと&#8230;そもそも「右」とは何かっていうと..うーん、国語辞書でも苦しい感じの説明だよなあ&#8230;.コーヒー飲みつつ色々考えながら窓の外を一分眺めます。</p>

<p>&#8230;配列で相対方向？</p>

<p>結局、「時計回り」の配列を用意して利用する方法を考えました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 時計回り配列</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">protected</span> <span class="nv">$_clockwiseDirection</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>array(0, 1)、array(-1, 0)&#8230;と下、左、上、右という時計回りの方向が並んでる配列（↓←↑→）です。</p>

<p>↓、←、↑、→と右回りの配列をつくって、１つ進んだら右回り、1つ後退したら左回り。</p>

<p>時計方向で並んでる配列の中で自分の「となりの右」が現在の方向から見た「右」です。配列の添字を１つ進めると右、減らすと左になります。一番右や左ではぐるっとまわって反対側の配列をとります。</p>

<p>うまく行きそうです。</p>

<p>モンスターはこれに優先順位があります。このようなコードになりました。<sup><a href="#footnote_3_112" id="identifier_3_112" class="footnote-link footnote-identifier-link" title="モンスタークラスにそれぞれの性格のモンスターがメソッドとして実装されていて迷路とPacmanの座標を受け取ったメソッドが進行方向を配列で返します。">4</a></sup></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * モンスターL</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * 現在位置への進入方向から見て相対的に 左、前、右 の順</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param array $maze    迷路</span>
</span><span class='line'><span class="sd">     * @param int   $pacmanX パックマンX座標</span>
</span><span class='line'><span class="sd">     * @param int   $pacmanX パックマンY座標</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">_moveL</span><span class="p">(</span><span class="k">array</span> <span class="nv">$maze</span><span class="p">,</span> <span class="nv">$pacmanX</span><span class="p">,</span> <span class="nv">$pacmanY</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$directionStrategy</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_getRelativeDirection</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_setPositionStatus</span><span class="p">(</span><span class="nv">$maze</span><span class="p">,</span> <span class="nv">$directionStrategy</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$result</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dx&#39;</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dy&#39;</span><span class="p">]);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>     <span class="o">*/</span>
</span></code></pre></td></tr></table></div></figure>


<p>14行目:左（-1)、前(0)、右（1)を優先順位にした絶対方向座標が$directionStrategyとしてつくられます。<br/>
15行目: 迷路配列をみて、優先順位($directionStrategy)どおりの順番で壁ではないかチェックして移動可能な座標の配列をつくります。<br/>
16行目: 移動可能で優先順位の最も高い座標が配列の最初(0)にはいりっているのでそれを取り出します。</p>

<p>「特定の優先方向配列を用意して、その移動可能状態を調べ、個別ロジックによって移動方向を決定」&#8230;</p>

<p>これがキャラクターの移動の基本戦略となり、Pacmanにも利用しました。</p>

<p>モンスターの動きデバック用の迷路をつくり、動きを一つ一つ確認。コンソールでのPHPプログラムでしたがusleep()関数と画面クリアを使えば、コンソールでもアニメーションが見られるのがわかりました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'> <span class="k">echo</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[;H</span><span class="se">\033</span><span class="s2">[2J&quot;</span><span class="p">;</span> <span class="c1">// これで画面クリア</span>
</span></code></pre></td></tr></table></div></figure>


<h3>いよいよモンスターのいる迷路をパックマンが自走</h3>

<p>予想と違ってなかなか厳しい。最初はクリアできませんでした。&hellip;.レベル１でさえも！！<br/>
当初、レベル３は現状の反復学習なし実装だと無理と確信します。</p>

<p>ところがレベル１は無理なのですが、レベル２をやると割とあっさりクリアできました。</p>

<p>？？？</p>

<p>debugモードで観察すると。効率よくするための「パックマンAI」が逆に正解ルートを必ず行けなくしてるのがわかりました。</p>

<p>レベル１の方針を変えます。</p>

<p>&ldquo;ランダム&rdquo;</p>

<p>何も考えずランダムに動かしてを繰り返すと数秒で最適解41点にたどりつけました。orz<br/>
レベル１、レベル２なんとか解けてそろそろタイムリミット。解けないLv.3の得点とソースコードを添えて提出しました。</p>

<h3>不合格、そしてLv.3クリア</h3>

<p>枠や開催場所によってはメアド入れたら通ったという方もいる中、GDD2010の参加不合格通知が届きます。結果からいうとパックマンはやる必要がないくらいの配点でした。<sup><a href="#footnote_4_112" id="identifier_4_112" class="footnote-link footnote-identifier-link" title="95%以上得点が圧縮調整されてました。参加者の得点が高かったのでしょう">5</a></sup> 自走パックマンに一生懸命で他の問題にほとんど手をつけてないのも原因でした。</p>

<p>しかししばらくして、やりかけだったプログラムの興味70%、勉強20%、パックマンLove10%という気持ちがLv.3解へのコーディングへと向かわせます。</p>

<p>反復学習の実装です。</p>

<h3>深さ優先探索</h3>

<div class="wp-caption alignright" style="width: 210px">
  <img alt="" src="http://upload.wikimedia.org/wikipedia/commons/thumb/2/2c/Depthfirst.png/200px-Depthfirst.png" title="反復木" width="200" height="197" /><p class="wp-caption-text">
    深さ優先探索のイメージ

</div>


<p>プログラムしたときは手法は思いついきで適当にした方法なのですが、実装が完全に終わって今日読んだオライリーの <a href="http://www.amazon.co.jp/gp/product/4873114284?ie=UTF8&amp;tag=koriymassoc-22&amp;linkCode=as2&amp;camp=247&amp;creative=1211&amp;creativeASIN=4873114284">アルゴリズムクイックリファレンス</a><img src="http://www.assoc-amazon.jp/e/ir?t=koriymassoc-22&#038;l=as2&#038;o=9&#038;a=4873114284" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />で分かったのがこれは<strong>深さ優先探索</strong>というものなんだそうです。 <sup><a href="#footnote_5_112" id="identifier_5_112" class="footnote-link footnote-identifier-link" title="それぐらい知っとけという感じですが">6</a></sup></p>

<p>wikiで以下のように説明されてます。</p>

<blockquote><p><a href="http://ja.wikipedia.org/wiki/%E6%B7%B1%E3%81%95%E5%84%AA%E5%85%88%E6%8E%A2%E7%B4%A2"></a><a href="http://ja.wikipedia.org/wiki/%E6%B7%B1%E3%81%95%E5%84%AA%E5%85%88%E6%8E%A2%E7%B4%A2">深さ優先探索</a>（ふかさゆうせんたんさく、英: depth-first search, DFS、バックトラック法ともいう）は、木やグラフを探索するためのアルゴリズムである。アルゴリズムは根から(グラフの場合はどのノードを根にするか決定する)始まり、バックトラックするまで可能な限り探索を行う。</p></blockquote>

<p>オライリー本からも引用します。</p>

<blockquote><p>「出来る限り前方に進み、同じ状態を二度と本文せずに、目的状態への経路を見つけようとする。探索木によっては、盤面の数が大変多くなるので、深さ優先探索は最大探索深さが前もって定まっているような場合にのみ実用的になる。深さ優先探索は、これから訪問する盤面状態をスタックに積み、訪問した盤面状態を集合に保持して、管理する。深さ優先探索は、スタックから未訪問の盤面状態を取り出し、可能な手を用いて、次の盤面状態集合を計算して木を拡張する。目標状態に到達したら、探索は終了する。」</p></blockquote>

<p>Pacmanでこう実装していました。<sup><a href="#footnote_6_112" id="identifier_6_112" class="footnote-link footnote-identifier-link" title="正に深さ優先探索！">7</a></sup></p>

<ul>
<li>ブランチは移動可能な場所が３つ以上あったとき</li>
<li>ブランチがあるときにそのゲーム状態をスタックに積む。</li>
<li>失敗したらスタックからゲームを取り出し失敗する前まで戻ってゲーム再開</li>
<li>自分の行動は記録し、失敗を繰り返さない</li>
</ul>


<p>※ゲーム全体はゲームオブジェクトとして１つの変数になってるので、それをarray_pushで配列としてスタックに積みます。<sup><a href="#footnote_7_112" id="identifier_7_112" class="footnote-link footnote-identifier-link" title="ゲームオブジェクトはプロパティとしてモンスターやパックマンのオブジェクトなどゲーム要素全てもっています。">8</a></sup></p>

<h3>探索木</h3>

<p>実際の動きはこのようになります。</p>

<p><code>
h mark 行き先(h)をマークし
 pushed 失敗しても前回の状態に戻れるように前回ゲームをスタックにつみ
h moved 進みます
hh mark 行き先(hh)をマークし...　　以下同様
h pushed
hh moved
hhk mark
hh pushed
hhk moved
hhkk mark
hhk pushed
hhkk moved
hhkkl mark
hhkk pushed
hhkkl moved
hhkkl GAME OVER ゲームオーバーになったので
hhkk is poped 積まれたゲームを上からとりだし
hhkkl is marked 移動可能方向を確認。hhkklという方角はすでに探索してるのでいきません。
hhkk GAME OVER 移動できる方角がもうないのでここでもゲームオーバーです。
hhk is poped その前につまれたゲームを取り出し    ....以下同様
hhkk is marked
hhk GAME OVER
hh is poped
hhk is marked
hhl mark
</code></p>

<p>これを繰り返せば全ての木の枝が探索できるはずです。<sup><a href="#footnote_8_112" id="identifier_8_112" class="footnote-link footnote-identifier-link" title="メモリと時間が許せば ">9</a></sup></p>

<h3>Lv.1でも全経路は無理?</h3>

<p>ところがそんなに簡単ではありません。Lv1くらい無条件の全経路を調べられないかと思いましたが、やはり難しそうです。この動画が少し参考になるでしょうか。階乗の計算量は膨大です。</p>

<p><a href="http://www.bear-project.net/blog/wp-content/uploads/2010/09/stack.mov">GDD Pacman LV.1 Deep-First Search</a></p>

<p>Lv2, Lv3では３つ以上の交差点でのみブランチをつくることにしました。また時間によるゲームオーバーからはスタックからゲームを取り出すことなしに、最初からやり直すのを繰り返す事にしました。<sup><a href="#footnote_9_112" id="identifier_9_112" class="footnote-link footnote-identifier-link" title="その方がスコアが良く、ランダムで繰り返しても同じゲームが再現することがほとんどありませんででした">10</a></sup> <sup><a href="#footnote_10_112" id="identifier_10_112" class="footnote-link footnote-identifier-link" title="ゲームオーバー時に積まれたゲームスタックを再評価し、10,000回に一回しか出ないような良いスコアの途中のゲーム状態から再開してみる..など色々やってみましたがあまりスコアアップに繋がりませんでした。オライリー本にもありますが&quot;大器晩成型&quot;のスコアがとであがってくるタイプのを消してしまうからではないかと思いました。">11</a></sup></p>

<h3>幅優先探索</h3>

<p>試してはいませんが、他の検索の紹介を。幅優先探索も同じ様に同じ状態を２度と訪問しないようにして、ゲーム状態を初期状態から近い順に評価します。深さ優先と違うのは、探索開始点から近いところから順に探索をしていくところです。深さ優先探索がスタックを使用するのに対して、幅優先探索はキューをする違いを理解すれば実装のイメージがわくのではないでしょうか。<sup><a href="#footnote_11_112" id="identifier_11_112" class="footnote-link footnote-identifier-link" title="これも膨大なメモリを要します。他にもいろいろな探索がオライリー本に紹介されてますがどれが一番向いてたのでしょうか">12</a></sup></p>

<p><a href="http://www.bear-project.net/blog/wp-content/uploads/2010/09/300px-Breadth-first-tree.png"><img src="http://www.bear-project.net/blog/wp-content/uploads/2010/09/300px-Breadth-first-tree.png" alt="" title="Breadth-Frst-Tree" width="300" height="207" class="aligncenter size-full wp-image-191" /></a></p>

<h3>Lv.2, Lv.3の探索木</h3>

<p>交差点だけブランチをつくるLv.2とLv.3でタイムオーバーまでゲームをしたら大体100ゲーム超ぐらいのゲームがスタックされます。Lv.2、Lv.3もあまり変わらなくLv.3がやや多いくらいです。</p>

<p>以下はタイムオーバーまで５回プレイした例です。</p>

<p><code>
Lv.3
Score:284/296 Point:284 Game:700/700 Stacked Game:107
Score:277/296 Point:277 Game:700/700 Stacked Game:103
Score:277/296 Point:277 Game:700/700 Stacked Game:111
Score:269/296 Point:269 Game:700/700 Stacked Game:107
Score:267/296 Point:267 Game:700/700 Stacked Game:101
Lv.2
Score:131/147 Point:131 Game:300/300 Stacked Game:107
Score:129/147 Point:129 Game:300/300 Stacked Game:112
Score:120/147 Point:120 Game:300/300 Stacked Game:111
Score:127/147 Point:127 Game:300/300 Stacked Game:101
Score:135/147 Point:135 Game:300/300 Stacked Game:100
</code></p>

<p>なかなか良いスコアです。これが一瞬で出るので、これを一晩ぶん回せば&hellip;と期待してしまいますがここからのスコアはなかなか伸びません。<sup><a href="#footnote_12_112" id="identifier_12_112" class="footnote-link footnote-identifier-link" title="残りドットが少なくなったら取りにいくロジックを追加したらかなり性能があがるかもしれません">13</a></sup> ３ドット取り残しとゲームクリアではクイズの配点としての差はあまりないでしょうけど、プログラムの性能としては格段に違います。</p>

<p>それでもLv.3クリアが一瞬から数分程度でできるまでの性能になりました。僕のGDD2010はここで終わりです。</p>

<h3>最後に</h3>

<p>昔の事ですがファミコンやゲームボーイでアクションゲームをいくつか作ったことがあります。<sup><a href="#footnote_13_112" id="identifier_13_112" class="footnote-link footnote-identifier-link" title="アセンブラは16bitのスーパーファミコン(65816)、メガドライブ (680000+Z80)までやりました">14</a></sup> 中高生の時もBASICや機械語<sup><a href="#footnote_14_112" id="identifier_14_112" class="footnote-link footnote-identifier-link" title="懐かしい響き!">15</a></sup> でこういうキャラクタベースのゲームを趣味でつくったりしてました。<sup><a href="#footnote_15_112" id="identifier_15_112" class="footnote-link footnote-identifier-link" title="自機が&rdquo;＠&rdquo;でした！当時いろんなゲームの自機が@。PC-6001用ASCIIのAXシリーズとか...">16</a></sup></p>

<p>思えばそれ以来のゲームプログラミングです。これからもこういうプログラムはする事はなかなかないと思うので貴重な機会となりました。参加はなりませんでしたが<a href="http://www.google.co.jp/search?q=%23gdd2010jp&amp;hl=ja&amp;safe=off&amp;prmd=u&amp;tbs=mbl:1&amp;tbo=u&amp;ei=qguTTNWoFcqHceyWjbkG&amp;sa=X&amp;oi=realtime_result_group_more_results_link&amp;ct=title&amp;resnum=4&amp;ved=0CDMQ5QUwAw">#gdd2010jp</a>で他の参加者の話を聞いたりコードを見たりするのも楽しかったです。<a href="http://togetter.com/li/44476">GDD2010JP DevQuiz ソース晒し祭り</a>でもPHPや自動探査で解いてるコードが少ないのとどういう風にコーディングしたらいいかさっぱり分からないという方もTLで散見したりで、多少なりとも参考になればと思い記事をかきました。</p>

<p>最後に<a href="http://twitter.com/asannou">asannou</a>さんの作製の素晴らしい<a href="http://www.gmodules.com/ig/creator?synd=open&amp;url=http://ido.nu/ayaya/pacman3.xml">ガジェット</a><sup><a href="#footnote_16_112" id="identifier_16_112" class="footnote-link footnote-identifier-link" title="動作確認にも大変世話になりました">17</a></sup> を貼付けて終わりにします。Lv.3クリアのベストスコアです。<sup><a href="#footnote_17_112" id="identifier_17_112" class="footnote-link footnote-identifier-link" title="AI検索のみの移動です。人の手による修正はありません">18</a></sup>　長文読んで頂いてありがとうございました。</p>

<h3>ソースコード</h3>

<p>ダウンロードは<a href="http://codepad.org/Xuv8jJIZ">code pad</a>で</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
<span class='line-number'>421</span>
<span class='line-number'>422</span>
<span class='line-number'>423</span>
<span class='line-number'>424</span>
<span class='line-number'>425</span>
<span class='line-number'>426</span>
<span class='line-number'>427</span>
<span class='line-number'>428</span>
<span class='line-number'>429</span>
<span class='line-number'>430</span>
<span class='line-number'>431</span>
<span class='line-number'>432</span>
<span class='line-number'>433</span>
<span class='line-number'>434</span>
<span class='line-number'>435</span>
<span class='line-number'>436</span>
<span class='line-number'>437</span>
<span class='line-number'>438</span>
<span class='line-number'>439</span>
<span class='line-number'>440</span>
<span class='line-number'>441</span>
<span class='line-number'>442</span>
<span class='line-number'>443</span>
<span class='line-number'>444</span>
<span class='line-number'>445</span>
<span class='line-number'>446</span>
<span class='line-number'>447</span>
<span class='line-number'>448</span>
<span class='line-number'>449</span>
<span class='line-number'>450</span>
<span class='line-number'>451</span>
<span class='line-number'>452</span>
<span class='line-number'>453</span>
<span class='line-number'>454</span>
<span class='line-number'>455</span>
<span class='line-number'>456</span>
<span class='line-number'>457</span>
<span class='line-number'>458</span>
<span class='line-number'>459</span>
<span class='line-number'>460</span>
<span class='line-number'>461</span>
<span class='line-number'>462</span>
<span class='line-number'>463</span>
<span class='line-number'>464</span>
<span class='line-number'>465</span>
<span class='line-number'>466</span>
<span class='line-number'>467</span>
<span class='line-number'>468</span>
<span class='line-number'>469</span>
<span class='line-number'>470</span>
<span class='line-number'>471</span>
<span class='line-number'>472</span>
<span class='line-number'>473</span>
<span class='line-number'>474</span>
<span class='line-number'>475</span>
<span class='line-number'>476</span>
<span class='line-number'>477</span>
<span class='line-number'>478</span>
<span class='line-number'>479</span>
<span class='line-number'>480</span>
<span class='line-number'>481</span>
<span class='line-number'>482</span>
<span class='line-number'>483</span>
<span class='line-number'>484</span>
<span class='line-number'>485</span>
<span class='line-number'>486</span>
<span class='line-number'>487</span>
<span class='line-number'>488</span>
<span class='line-number'>489</span>
<span class='line-number'>490</span>
<span class='line-number'>491</span>
<span class='line-number'>492</span>
<span class='line-number'>493</span>
<span class='line-number'>494</span>
<span class='line-number'>495</span>
<span class='line-number'>496</span>
<span class='line-number'>497</span>
<span class='line-number'>498</span>
<span class='line-number'>499</span>
<span class='line-number'>500</span>
<span class='line-number'>501</span>
<span class='line-number'>502</span>
<span class='line-number'>503</span>
<span class='line-number'>504</span>
<span class='line-number'>505</span>
<span class='line-number'>506</span>
<span class='line-number'>507</span>
<span class='line-number'>508</span>
<span class='line-number'>509</span>
<span class='line-number'>510</span>
<span class='line-number'>511</span>
<span class='line-number'>512</span>
<span class='line-number'>513</span>
<span class='line-number'>514</span>
<span class='line-number'>515</span>
<span class='line-number'>516</span>
<span class='line-number'>517</span>
<span class='line-number'>518</span>
<span class='line-number'>519</span>
<span class='line-number'>520</span>
<span class='line-number'>521</span>
<span class='line-number'>522</span>
<span class='line-number'>523</span>
<span class='line-number'>524</span>
<span class='line-number'>525</span>
<span class='line-number'>526</span>
<span class='line-number'>527</span>
<span class='line-number'>528</span>
<span class='line-number'>529</span>
<span class='line-number'>530</span>
<span class='line-number'>531</span>
<span class='line-number'>532</span>
<span class='line-number'>533</span>
<span class='line-number'>534</span>
<span class='line-number'>535</span>
<span class='line-number'>536</span>
<span class='line-number'>537</span>
<span class='line-number'>538</span>
<span class='line-number'>539</span>
<span class='line-number'>540</span>
<span class='line-number'>541</span>
<span class='line-number'>542</span>
<span class='line-number'>543</span>
<span class='line-number'>544</span>
<span class='line-number'>545</span>
<span class='line-number'>546</span>
<span class='line-number'>547</span>
<span class='line-number'>548</span>
<span class='line-number'>549</span>
<span class='line-number'>550</span>
<span class='line-number'>551</span>
<span class='line-number'>552</span>
<span class='line-number'>553</span>
<span class='line-number'>554</span>
<span class='line-number'>555</span>
<span class='line-number'>556</span>
<span class='line-number'>557</span>
<span class='line-number'>558</span>
<span class='line-number'>559</span>
<span class='line-number'>560</span>
<span class='line-number'>561</span>
<span class='line-number'>562</span>
<span class='line-number'>563</span>
<span class='line-number'>564</span>
<span class='line-number'>565</span>
<span class='line-number'>566</span>
<span class='line-number'>567</span>
<span class='line-number'>568</span>
<span class='line-number'>569</span>
<span class='line-number'>570</span>
<span class='line-number'>571</span>
<span class='line-number'>572</span>
<span class='line-number'>573</span>
<span class='line-number'>574</span>
<span class='line-number'>575</span>
<span class='line-number'>576</span>
<span class='line-number'>577</span>
<span class='line-number'>578</span>
<span class='line-number'>579</span>
<span class='line-number'>580</span>
<span class='line-number'>581</span>
<span class='line-number'>582</span>
<span class='line-number'>583</span>
<span class='line-number'>584</span>
<span class='line-number'>585</span>
<span class='line-number'>586</span>
<span class='line-number'>587</span>
<span class='line-number'>588</span>
<span class='line-number'>589</span>
<span class='line-number'>590</span>
<span class='line-number'>591</span>
<span class='line-number'>592</span>
<span class='line-number'>593</span>
<span class='line-number'>594</span>
<span class='line-number'>595</span>
<span class='line-number'>596</span>
<span class='line-number'>597</span>
<span class='line-number'>598</span>
<span class='line-number'>599</span>
<span class='line-number'>600</span>
<span class='line-number'>601</span>
<span class='line-number'>602</span>
<span class='line-number'>603</span>
<span class='line-number'>604</span>
<span class='line-number'>605</span>
<span class='line-number'>606</span>
<span class='line-number'>607</span>
<span class='line-number'>608</span>
<span class='line-number'>609</span>
<span class='line-number'>610</span>
<span class='line-number'>611</span>
<span class='line-number'>612</span>
<span class='line-number'>613</span>
<span class='line-number'>614</span>
<span class='line-number'>615</span>
<span class='line-number'>616</span>
<span class='line-number'>617</span>
<span class='line-number'>618</span>
<span class='line-number'>619</span>
<span class='line-number'>620</span>
<span class='line-number'>621</span>
<span class='line-number'>622</span>
<span class='line-number'>623</span>
<span class='line-number'>624</span>
<span class='line-number'>625</span>
<span class='line-number'>626</span>
<span class='line-number'>627</span>
<span class='line-number'>628</span>
<span class='line-number'>629</span>
<span class='line-number'>630</span>
<span class='line-number'>631</span>
<span class='line-number'>632</span>
<span class='line-number'>633</span>
<span class='line-number'>634</span>
<span class='line-number'>635</span>
<span class='line-number'>636</span>
<span class='line-number'>637</span>
<span class='line-number'>638</span>
<span class='line-number'>639</span>
<span class='line-number'>640</span>
<span class='line-number'>641</span>
<span class='line-number'>642</span>
<span class='line-number'>643</span>
<span class='line-number'>644</span>
<span class='line-number'>645</span>
<span class='line-number'>646</span>
<span class='line-number'>647</span>
<span class='line-number'>648</span>
<span class='line-number'>649</span>
<span class='line-number'>650</span>
<span class='line-number'>651</span>
<span class='line-number'>652</span>
<span class='line-number'>653</span>
<span class='line-number'>654</span>
<span class='line-number'>655</span>
<span class='line-number'>656</span>
<span class='line-number'>657</span>
<span class='line-number'>658</span>
<span class='line-number'>659</span>
<span class='line-number'>660</span>
<span class='line-number'>661</span>
<span class='line-number'>662</span>
<span class='line-number'>663</span>
<span class='line-number'>664</span>
<span class='line-number'>665</span>
<span class='line-number'>666</span>
<span class='line-number'>667</span>
<span class='line-number'>668</span>
<span class='line-number'>669</span>
<span class='line-number'>670</span>
<span class='line-number'>671</span>
<span class='line-number'>672</span>
<span class='line-number'>673</span>
<span class='line-number'>674</span>
<span class='line-number'>675</span>
<span class='line-number'>676</span>
<span class='line-number'>677</span>
<span class='line-number'>678</span>
<span class='line-number'>679</span>
<span class='line-number'>680</span>
<span class='line-number'>681</span>
<span class='line-number'>682</span>
<span class='line-number'>683</span>
<span class='line-number'>684</span>
<span class='line-number'>685</span>
<span class='line-number'>686</span>
<span class='line-number'>687</span>
<span class='line-number'>688</span>
<span class='line-number'>689</span>
<span class='line-number'>690</span>
<span class='line-number'>691</span>
<span class='line-number'>692</span>
<span class='line-number'>693</span>
<span class='line-number'>694</span>
<span class='line-number'>695</span>
<span class='line-number'>696</span>
<span class='line-number'>697</span>
<span class='line-number'>698</span>
<span class='line-number'>699</span>
<span class='line-number'>700</span>
<span class='line-number'>701</span>
<span class='line-number'>702</span>
<span class='line-number'>703</span>
<span class='line-number'>704</span>
<span class='line-number'>705</span>
<span class='line-number'>706</span>
<span class='line-number'>707</span>
<span class='line-number'>708</span>
<span class='line-number'>709</span>
<span class='line-number'>710</span>
<span class='line-number'>711</span>
<span class='line-number'>712</span>
<span class='line-number'>713</span>
<span class='line-number'>714</span>
<span class='line-number'>715</span>
<span class='line-number'>716</span>
<span class='line-number'>717</span>
<span class='line-number'>718</span>
<span class='line-number'>719</span>
<span class='line-number'>720</span>
<span class='line-number'>721</span>
<span class='line-number'>722</span>
<span class='line-number'>723</span>
<span class='line-number'>724</span>
<span class='line-number'>725</span>
<span class='line-number'>726</span>
<span class='line-number'>727</span>
<span class='line-number'>728</span>
<span class='line-number'>729</span>
<span class='line-number'>730</span>
<span class='line-number'>731</span>
<span class='line-number'>732</span>
<span class='line-number'>733</span>
<span class='line-number'>734</span>
<span class='line-number'>735</span>
<span class='line-number'>736</span>
<span class='line-number'>737</span>
<span class='line-number'>738</span>
<span class='line-number'>739</span>
<span class='line-number'>740</span>
<span class='line-number'>741</span>
<span class='line-number'>742</span>
<span class='line-number'>743</span>
<span class='line-number'>744</span>
<span class='line-number'>745</span>
<span class='line-number'>746</span>
<span class='line-number'>747</span>
<span class='line-number'>748</span>
<span class='line-number'>749</span>
<span class='line-number'>750</span>
<span class='line-number'>751</span>
<span class='line-number'>752</span>
<span class='line-number'>753</span>
<span class='line-number'>754</span>
<span class='line-number'>755</span>
<span class='line-number'>756</span>
<span class='line-number'>757</span>
<span class='line-number'>758</span>
<span class='line-number'>759</span>
<span class='line-number'>760</span>
<span class='line-number'>761</span>
<span class='line-number'>762</span>
<span class='line-number'>763</span>
<span class='line-number'>764</span>
<span class='line-number'>765</span>
<span class='line-number'>766</span>
<span class='line-number'>767</span>
<span class='line-number'>768</span>
<span class='line-number'>769</span>
<span class='line-number'>770</span>
<span class='line-number'>771</span>
<span class='line-number'>772</span>
<span class='line-number'>773</span>
<span class='line-number'>774</span>
<span class='line-number'>775</span>
<span class='line-number'>776</span>
<span class='line-number'>777</span>
<span class='line-number'>778</span>
<span class='line-number'>779</span>
<span class='line-number'>780</span>
<span class='line-number'>781</span>
<span class='line-number'>782</span>
<span class='line-number'>783</span>
<span class='line-number'>784</span>
<span class='line-number'>785</span>
<span class='line-number'>786</span>
<span class='line-number'>787</span>
<span class='line-number'>788</span>
<span class='line-number'>789</span>
<span class='line-number'>790</span>
<span class='line-number'>791</span>
<span class='line-number'>792</span>
<span class='line-number'>793</span>
<span class='line-number'>794</span>
<span class='line-number'>795</span>
<span class='line-number'>796</span>
<span class='line-number'>797</span>
<span class='line-number'>798</span>
<span class='line-number'>799</span>
<span class='line-number'>800</span>
<span class='line-number'>801</span>
<span class='line-number'>802</span>
<span class='line-number'>803</span>
<span class='line-number'>804</span>
<span class='line-number'>805</span>
<span class='line-number'>806</span>
<span class='line-number'>807</span>
<span class='line-number'>808</span>
<span class='line-number'>809</span>
<span class='line-number'>810</span>
<span class='line-number'>811</span>
<span class='line-number'>812</span>
<span class='line-number'>813</span>
<span class='line-number'>814</span>
<span class='line-number'>815</span>
<span class='line-number'>816</span>
<span class='line-number'>817</span>
<span class='line-number'>818</span>
<span class='line-number'>819</span>
<span class='line-number'>820</span>
<span class='line-number'>821</span>
<span class='line-number'>822</span>
<span class='line-number'>823</span>
<span class='line-number'>824</span>
<span class='line-number'>825</span>
<span class='line-number'>826</span>
<span class='line-number'>827</span>
<span class='line-number'>828</span>
<span class='line-number'>829</span>
<span class='line-number'>830</span>
<span class='line-number'>831</span>
<span class='line-number'>832</span>
<span class='line-number'>833</span>
<span class='line-number'>834</span>
<span class='line-number'>835</span>
<span class='line-number'>836</span>
<span class='line-number'>837</span>
<span class='line-number'>838</span>
<span class='line-number'>839</span>
<span class='line-number'>840</span>
<span class='line-number'>841</span>
<span class='line-number'>842</span>
<span class='line-number'>843</span>
<span class='line-number'>844</span>
<span class='line-number'>845</span>
<span class='line-number'>846</span>
<span class='line-number'>847</span>
<span class='line-number'>848</span>
<span class='line-number'>849</span>
<span class='line-number'>850</span>
<span class='line-number'>851</span>
<span class='line-number'>852</span>
<span class='line-number'>853</span>
<span class='line-number'>854</span>
<span class='line-number'>855</span>
<span class='line-number'>856</span>
<span class='line-number'>857</span>
<span class='line-number'>858</span>
<span class='line-number'>859</span>
<span class='line-number'>860</span>
<span class='line-number'>861</span>
<span class='line-number'>862</span>
<span class='line-number'>863</span>
<span class='line-number'>864</span>
<span class='line-number'>865</span>
<span class='line-number'>866</span>
<span class='line-number'>867</span>
<span class='line-number'>868</span>
<span class='line-number'>869</span>
<span class='line-number'>870</span>
<span class='line-number'>871</span>
<span class='line-number'>872</span>
<span class='line-number'>873</span>
<span class='line-number'>874</span>
<span class='line-number'>875</span>
<span class='line-number'>876</span>
<span class='line-number'>877</span>
<span class='line-number'>878</span>
<span class='line-number'>879</span>
<span class='line-number'>880</span>
<span class='line-number'>881</span>
<span class='line-number'>882</span>
<span class='line-number'>883</span>
<span class='line-number'>884</span>
<span class='line-number'>885</span>
<span class='line-number'>886</span>
<span class='line-number'>887</span>
<span class='line-number'>888</span>
<span class='line-number'>889</span>
<span class='line-number'>890</span>
<span class='line-number'>891</span>
<span class='line-number'>892</span>
<span class='line-number'>893</span>
<span class='line-number'>894</span>
<span class='line-number'>895</span>
<span class='line-number'>896</span>
<span class='line-number'>897</span>
<span class='line-number'>898</span>
<span class='line-number'>899</span>
<span class='line-number'>900</span>
<span class='line-number'>901</span>
<span class='line-number'>902</span>
<span class='line-number'>903</span>
<span class='line-number'>904</span>
<span class='line-number'>905</span>
<span class='line-number'>906</span>
<span class='line-number'>907</span>
<span class='line-number'>908</span>
<span class='line-number'>909</span>
<span class='line-number'>910</span>
<span class='line-number'>911</span>
<span class='line-number'>912</span>
<span class='line-number'>913</span>
<span class='line-number'>914</span>
<span class='line-number'>915</span>
<span class='line-number'>916</span>
<span class='line-number'>917</span>
<span class='line-number'>918</span>
<span class='line-number'>919</span>
<span class='line-number'>920</span>
<span class='line-number'>921</span>
<span class='line-number'>922</span>
<span class='line-number'>923</span>
<span class='line-number'>924</span>
<span class='line-number'>925</span>
<span class='line-number'>926</span>
<span class='line-number'>927</span>
<span class='line-number'>928</span>
<span class='line-number'>929</span>
<span class='line-number'>930</span>
<span class='line-number'>931</span>
<span class='line-number'>932</span>
<span class='line-number'>933</span>
<span class='line-number'>934</span>
<span class='line-number'>935</span>
<span class='line-number'>936</span>
<span class='line-number'>937</span>
<span class='line-number'>938</span>
<span class='line-number'>939</span>
<span class='line-number'>940</span>
<span class='line-number'>941</span>
<span class='line-number'>942</span>
<span class='line-number'>943</span>
<span class='line-number'>944</span>
<span class='line-number'>945</span>
<span class='line-number'>946</span>
<span class='line-number'>947</span>
<span class='line-number'>948</span>
<span class='line-number'>949</span>
<span class='line-number'>950</span>
<span class='line-number'>951</span>
<span class='line-number'>952</span>
<span class='line-number'>953</span>
<span class='line-number'>954</span>
<span class='line-number'>955</span>
<span class='line-number'>956</span>
<span class='line-number'>957</span>
<span class='line-number'>958</span>
<span class='line-number'>959</span>
<span class='line-number'>960</span>
<span class='line-number'>961</span>
<span class='line-number'>962</span>
<span class='line-number'>963</span>
<span class='line-number'>964</span>
<span class='line-number'>965</span>
<span class='line-number'>966</span>
<span class='line-number'>967</span>
<span class='line-number'>968</span>
<span class='line-number'>969</span>
<span class='line-number'>970</span>
<span class='line-number'>971</span>
<span class='line-number'>972</span>
<span class='line-number'>973</span>
<span class='line-number'>974</span>
<span class='line-number'>975</span>
<span class='line-number'>976</span>
<span class='line-number'>977</span>
<span class='line-number'>978</span>
<span class='line-number'>979</span>
<span class='line-number'>980</span>
<span class='line-number'>981</span>
<span class='line-number'>982</span>
<span class='line-number'>983</span>
<span class='line-number'>984</span>
<span class='line-number'>985</span>
<span class='line-number'>986</span>
<span class='line-number'>987</span>
<span class='line-number'>988</span>
<span class='line-number'>989</span>
<span class='line-number'>990</span>
<span class='line-number'>991</span>
<span class='line-number'>992</span>
<span class='line-number'>993</span>
<span class='line-number'>994</span>
<span class='line-number'>995</span>
<span class='line-number'>996</span>
<span class='line-number'>997</span>
<span class='line-number'>998</span>
<span class='line-number'>999</span>
<span class='line-number'>1000</span>
<span class='line-number'>1001</span>
<span class='line-number'>1002</span>
<span class='line-number'>1003</span>
<span class='line-number'>1004</span>
<span class='line-number'>1005</span>
<span class='line-number'>1006</span>
<span class='line-number'>1007</span>
<span class='line-number'>1008</span>
<span class='line-number'>1009</span>
<span class='line-number'>1010</span>
<span class='line-number'>1011</span>
<span class='line-number'>1012</span>
<span class='line-number'>1013</span>
<span class='line-number'>1014</span>
<span class='line-number'>1015</span>
<span class='line-number'>1016</span>
<span class='line-number'>1017</span>
<span class='line-number'>1018</span>
<span class='line-number'>1019</span>
<span class='line-number'>1020</span>
<span class='line-number'>1021</span>
<span class='line-number'>1022</span>
<span class='line-number'>1023</span>
<span class='line-number'>1024</span>
<span class='line-number'>1025</span>
<span class='line-number'>1026</span>
<span class='line-number'>1027</span>
<span class='line-number'>1028</span>
<span class='line-number'>1029</span>
<span class='line-number'>1030</span>
<span class='line-number'>1031</span>
<span class='line-number'>1032</span>
<span class='line-number'>1033</span>
<span class='line-number'>1034</span>
<span class='line-number'>1035</span>
<span class='line-number'>1036</span>
<span class='line-number'>1037</span>
<span class='line-number'>1038</span>
<span class='line-number'>1039</span>
<span class='line-number'>1040</span>
<span class='line-number'>1041</span>
<span class='line-number'>1042</span>
<span class='line-number'>1043</span>
<span class='line-number'>1044</span>
<span class='line-number'>1045</span>
<span class='line-number'>1046</span>
<span class='line-number'>1047</span>
<span class='line-number'>1048</span>
<span class='line-number'>1049</span>
<span class='line-number'>1050</span>
<span class='line-number'>1051</span>
<span class='line-number'>1052</span>
<span class='line-number'>1053</span>
<span class='line-number'>1054</span>
<span class='line-number'>1055</span>
<span class='line-number'>1056</span>
<span class='line-number'>1057</span>
<span class='line-number'>1058</span>
<span class='line-number'>1059</span>
<span class='line-number'>1060</span>
<span class='line-number'>1061</span>
<span class='line-number'>1062</span>
<span class='line-number'>1063</span>
<span class='line-number'>1064</span>
<span class='line-number'>1065</span>
<span class='line-number'>1066</span>
<span class='line-number'>1067</span>
<span class='line-number'>1068</span>
<span class='line-number'>1069</span>
<span class='line-number'>1070</span>
<span class='line-number'>1071</span>
<span class='line-number'>1072</span>
<span class='line-number'>1073</span>
<span class='line-number'>1074</span>
<span class='line-number'>1075</span>
<span class='line-number'>1076</span>
<span class='line-number'>1077</span>
<span class='line-number'>1078</span>
<span class='line-number'>1079</span>
<span class='line-number'>1080</span>
<span class='line-number'>1081</span>
<span class='line-number'>1082</span>
<span class='line-number'>1083</span>
<span class='line-number'>1084</span>
<span class='line-number'>1085</span>
<span class='line-number'>1086</span>
<span class='line-number'>1087</span>
<span class='line-number'>1088</span>
<span class='line-number'>1089</span>
<span class='line-number'>1090</span>
<span class='line-number'>1091</span>
<span class='line-number'>1092</span>
<span class='line-number'>1093</span>
<span class='line-number'>1094</span>
<span class='line-number'>1095</span>
<span class='line-number'>1096</span>
<span class='line-number'>1097</span>
<span class='line-number'>1098</span>
<span class='line-number'>1099</span>
<span class='line-number'>1100</span>
<span class='line-number'>1101</span>
<span class='line-number'>1102</span>
<span class='line-number'>1103</span>
<span class='line-number'>1104</span>
<span class='line-number'>1105</span>
<span class='line-number'>1106</span>
<span class='line-number'>1107</span>
<span class='line-number'>1108</span>
<span class='line-number'>1109</span>
<span class='line-number'>1110</span>
<span class='line-number'>1111</span>
<span class='line-number'>1112</span>
<span class='line-number'>1113</span>
<span class='line-number'>1114</span>
<span class='line-number'>1115</span>
<span class='line-number'>1116</span>
<span class='line-number'>1117</span>
<span class='line-number'>1118</span>
<span class='line-number'>1119</span>
<span class='line-number'>1120</span>
<span class='line-number'>1121</span>
<span class='line-number'>1122</span>
<span class='line-number'>1123</span>
<span class='line-number'>1124</span>
<span class='line-number'>1125</span>
<span class='line-number'>1126</span>
<span class='line-number'>1127</span>
<span class='line-number'>1128</span>
<span class='line-number'>1129</span>
<span class='line-number'>1130</span>
<span class='line-number'>1131</span>
<span class='line-number'>1132</span>
<span class='line-number'>1133</span>
<span class='line-number'>1134</span>
<span class='line-number'>1135</span>
<span class='line-number'>1136</span>
<span class='line-number'>1137</span>
<span class='line-number'>1138</span>
<span class='line-number'>1139</span>
<span class='line-number'>1140</span>
<span class='line-number'>1141</span>
<span class='line-number'>1142</span>
<span class='line-number'>1143</span>
<span class='line-number'>1144</span>
<span class='line-number'>1145</span>
<span class='line-number'>1146</span>
<span class='line-number'>1147</span>
<span class='line-number'>1148</span>
<span class='line-number'>1149</span>
<span class='line-number'>1150</span>
<span class='line-number'>1151</span>
<span class='line-number'>1152</span>
<span class='line-number'>1153</span>
<span class='line-number'>1154</span>
<span class='line-number'>1155</span>
<span class='line-number'>1156</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="sd">/**</span>
</span><span class='line'><span class="sd"> * GDD 2010 DevQuiz Pacman for PHP 5.3</span>
</span><span class='line'><span class="sd"> *</span>
</span><span class='line'><span class="sd"> * @author @koriym</span>
</span><span class='line'><span class="sd"> */</span>
</span><span class='line'><span class="sd">/**</span>
</span><span class='line'><span class="sd"> * デバック用関数 p</span>
</span><span class='line'><span class="sd"> */</span>
</span><span class='line'><span class="k">function</span> <span class="nf">p</span><span class="p">(</span><span class="nv">$values</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$trace</span> <span class="o">=</span> <span class="nb">debug_backtrace</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$trace</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">];</span>
</span><span class='line'>    <span class="nv">$line</span> <span class="o">=</span> <span class="nv">$trace</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;line&#39;</span><span class="p">];</span>
</span><span class='line'>    <span class="nv">$method</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$trace</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;class&#39;</span><span class="p">]))</span> <span class="o">?</span> <span class="s2">&quot; (</span><span class="si">{</span><span class="nv">$trace</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;class&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">.</span> <span class="s1">&#39;::&#39;</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="si">{</span><span class="nv">$trace</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;function&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$fileArray</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nx">FILE_USE_INCLUDE_PATH</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$p</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$fileArray</span><span class="p">[</span><span class="nv">$line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>    <span class="nb">unset</span><span class="p">(</span><span class="nv">$fileArray</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">preg_match</span><span class="p">(</span><span class="s2">&quot;/p\((.+)[\s,\)]/&quot;</span><span class="p">,</span> <span class="nv">$p</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>
</span><span class='line'>    <span class="nv">$varName</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">//    $label = &quot;$varName in {$file} on line {$line}$method&quot;;</span>
</span><span class='line'>    <span class="nv">$label</span> <span class="o">=</span> <span class="s2">&quot;on line </span><span class="si">{</span><span class="nv">$line</span><span class="si">}$method</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$values</span> <span class="o">=</span> <span class="nb">is_bool</span><span class="p">(</span><span class="nv">$values</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="nv">$values</span> <span class="o">?</span> <span class="s2">&quot;true&quot;</span> <span class="o">:</span> <span class="s2">&quot;false&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="nv">$values</span><span class="p">;</span>
</span><span class='line'>    <span class="k">echo</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="nv">$varName</span><span class="si">}</span><span class="s2">=[&quot;</span><span class="o">.</span> <span class="nb">print_r</span><span class="p">(</span><span class="nv">$values</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot;] </span><span class="si">$label\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="sd">/**</span>
</span><span class='line'><span class="sd"> * キャラクターインターフェイス</span>
</span><span class='line'><span class="sd"> *</span>
</span><span class='line'><span class="sd"> * @param string $MyChar 文字</span>
</span><span class='line'><span class="sd"> * @param int    $y      y座標</span>
</span><span class='line'><span class="sd"> * @paramint     $x      x座標</span>
</span><span class='line'><span class="sd"> *</span>
</span><span class='line'><span class="sd"> */</span>
</span><span class='line'><span class="k">interface</span> <span class="nx">Character_Interface</span><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$myChar</span><span class="p">,</span> <span class="nv">$y</span><span class="p">,</span> <span class="nv">$x</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="sd">/**</span>
</span><span class='line'><span class="sd"> * キャラクター</span>
</span><span class='line'><span class="sd"> *</span>
</span><span class='line'><span class="sd"> */</span>
</span><span class='line'><span class="k">abstract</span> <span class="k">class</span> <span class="nc">Character</span> <span class="k">implements</span> <span class="nx">Character_Interface</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * キャラ文字</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var string</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">protected</span> <span class="nv">$_char</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * X座標</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var int</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">protected</span> <span class="nv">$_x</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * Y座標</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var int</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">protected</span> <span class="nv">$_y</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * X移動</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var int</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">protected</span> <span class="nv">$_dx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * Y移動</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var int</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">protected</span> <span class="nv">$_dy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 移動可能座標</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">protected</span> <span class="nv">$_wayToGo</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 移動可能場所数</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var int</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">protected</span> <span class="nv">$_wayToGoCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 時計回り配列</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">protected</span> <span class="nv">$_clockwiseDirection</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * コンストラクタ</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param string $myChar</span>
</span><span class='line'><span class="sd">     * @param int    $x</span>
</span><span class='line'><span class="sd">     * @param int    $y</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$myChar</span><span class="p">,</span> <span class="nv">$x</span><span class="p">,</span> <span class="nv">$y</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_myChar</span> <span class="o">=</span> <span class="nv">$myChar</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span> <span class="o">=</span> <span class="nv">$x</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_y</span> <span class="o">=</span> <span class="nv">$y</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * ポジション取得</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     *　@return array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getPosition</span><span class="p">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_y</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * データ取得</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">get</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_myChar</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_y</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dy</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * キャラクタの移動可能状態をセット</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param array $maze              迷路</span>
</span><span class='line'><span class="sd">     * @param array $directionStrategy 移動方向戦略</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return void</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">function</span> <span class="nf">_setPositionStatus</span><span class="p">(</span><span class="nv">$maze</span><span class="p">,</span> <span class="nv">$directionStrategy</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$wayToGo</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$directionStrategy</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">list</span><span class="p">(</span><span class="nv">$dx</span><span class="p">,</span> <span class="nv">$dy</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$item</span><span class="p">;</span>
</span><span class='line'>            <span class="nv">$x</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span> <span class="o">+</span> <span class="nv">$dx</span><span class="p">;</span>
</span><span class='line'>            <span class="nv">$y</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_y</span> <span class="o">+</span> <span class="nv">$dy</span><span class="p">;</span>
</span><span class='line'>            <span class="nv">$isExist</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$maze</span><span class="p">[</span><span class="nv">$y</span><span class="p">][</span><span class="nv">$x</span><span class="p">]);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nv">$isExist</span> <span class="o">&amp;</span><span class="c1">#038;&amp;#038; $maze[$y][$x] === &#39;.&#39; || $maze[$y][$x] === &#39; &#39;) {</span>
</span><span class='line'>                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;dy&#39;</span> <span class="o">=&gt;</span> <span class="nv">$dy</span><span class="p">,</span> <span class="s1">&#39;dx&#39;</span> <span class="o">=&gt;</span> <span class="nv">$dx</span><span class="p">);</span>
</span><span class='line'>                <span class="nv">$cnt</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGoCount</span> <span class="o">=</span> <span class="nv">$cnt</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="sd">/**</span>
</span><span class='line'><span class="sd"> * パックマン</span>
</span><span class='line'><span class="sd"> *</span>
</span><span class='line'><span class="sd"> */</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Pacman</span> <span class="k">extends</span> <span class="nx">Character</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 方向履歴</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var string</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_joyStick</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 移動足跡</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_footprintMap</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 移動足跡初期化</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param int $width 幅</span>
</span><span class='line'><span class="sd">     * @param int $hight 高さ</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return void</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">setFootprintMap</span><span class="p">(</span><span class="nv">$width</span><span class="p">,</span> <span class="nv">$hight</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$hight</span> <span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_footprintMap</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">array_fill</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">$width</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * パックマン移動</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param array        $maze     迷路</span>
</span><span class='line'><span class="sd">     * @param int          $time     タイム</span>
</span><span class='line'><span class="sd">     * @param Pacman_Dicon $strategy DIコンテナ</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return void</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">move</span><span class="p">(</span><span class="nv">$maze</span><span class="p">,</span> <span class="nv">$time</span><span class="p">,</span> <span class="nx">Pacman_Dicon</span> <span class="nv">$dicon</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$funcMoveStrategy</span> <span class="o">=</span> <span class="nv">$dicon</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;move&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_setPositionStatus</span><span class="p">(</span><span class="nv">$maze</span><span class="p">,</span> <span class="nv">$dicon</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;direction&#39;</span><span class="p">));</span>
</span><span class='line'>        <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dy</span><span class="p">,</span> <span class="nv">$takeSnapShot</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$r</span> <span class="o">=</span> <span class="nv">$funcMoveStrategy</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_y</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dy</span><span class="p">,</span> <span class="nv">$maze</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGoCount</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_footprintMap</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_joyStick</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$pacmanThought</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_joyStick</span><span class="p">][</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dy</span><span class="p">][</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>            <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$takeSnapShot</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$c</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getJoyStickChar</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span><span class="p">,</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dy</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$pacmanThought</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_joyStick</span><span class="p">][</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dy</span><span class="p">][</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span><span class="p">]</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span> <span class="o">+=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_y</span> <span class="o">+=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dy</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_joyStick</span> <span class="o">.=</span> <span class="nx">self</span><span class="o">::</span><span class="na">getJoystickChar</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dy</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_footprintMap</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_y</span><span class="p">][</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$result</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_y</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dy</span><span class="p">,</span> <span class="nv">$takeSnapShot</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 方向からジョイスティック名を取得</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param int $dx</span>
</span><span class='line'><span class="sd">     * @param int $dy</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return string</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getJoyStickChar</span><span class="p">(</span><span class="nv">$dx</span><span class="p">,</span> <span class="nv">$dy</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$joyStickCharacters</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;j&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$direction</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$dx</span><span class="p">,</span> <span class="nv">$dy</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)));</span>
</span><span class='line'>        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$joyStickCharacters</span><span class="p">[</span><span class="nv">$direction</span><span class="p">];</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 足跡文字列取得</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return string</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getJoystick</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_joyStick</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="sd">/**</span>
</span><span class='line'><span class="sd"> * パックマンDIコンテナ</span>
</span><span class='line'><span class="sd"> *</span>
</span><span class='line'><span class="sd"> */</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Pacman_Dicon</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * サービス取得</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param string $service サービス取得名</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return mixed</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span><span class="nv">$service</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">switch</span> <span class="p">(</span><span class="nv">$service</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">case</span> <span class="s1">&#39;direction&#39;</span><span class="o">:</span>
</span><span class='line'>                <span class="nv">$directionStrategy</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span><span class='line'>                <span class="nb">shuffle</span><span class="p">(</span><span class="nv">$directionStrategy</span><span class="p">);</span>
</span><span class='line'>                <span class="k">return</span> <span class="nv">$directionStrategy</span><span class="p">;</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="k">case</span> <span class="s1">&#39;move&#39;</span><span class="o">:</span>
</span><span class='line'>                <span class="nv">$function</span> <span class="o">=</span>  <span class="k">function</span> <span class="p">(</span><span class="nv">$x</span><span class="p">,</span> <span class="nv">$y</span><span class="p">,</span> <span class="nv">$dx</span><span class="p">,</span> <span class="nv">$dy</span><span class="p">,</span> <span class="nv">$maze</span><span class="p">,</span> <span class="o">&amp;</span><span class="c1">#038;$wayCnt, $wayToGo, $footprintMap, $joystick)</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="k">switch</span> <span class="p">(</span><span class="nv">$wayCnt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
</span><span class='line'>                            <span class="c1">// 動けない</span>
</span><span class='line'>                            <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</span><span class='line'>                        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>                            <span class="c1">// 行き止まりなので唯一いける方向へ</span>
</span><span class='line'>                            <span class="nv">$togo</span> <span class="o">=</span> <span class="nv">$wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>                            <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$togo</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">],</span> <span class="nv">$togo</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">],</span> <span class="k">false</span><span class="p">);</span>
</span><span class='line'>                        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span><span class='line'>                            <span class="c1">// バックじゃない方</span>
</span><span class='line'>                            <span class="nv">$isReverse0</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$dx</span> <span class="o">===</span> <span class="p">(</span><span class="nv">$wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span><span class="c1">#038;&amp;#038; $dy === ($wayToGo[0][&#39;dy&#39;] * -1));</span>
</span><span class='line'>                            <span class="nv">$isReverse1</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$dx</span> <span class="o">===</span> <span class="p">(</span><span class="nv">$wayToGo</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span><span class="c1">#038;&amp;#038; $dy === ($wayToGo[1][&#39;dy&#39;] * -1));</span>
</span><span class='line'>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$isReverse0</span> <span class="o">||</span> <span class="nv">$isReverse1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                                <span class="nv">$i</span> <span class="o">=</span> <span class="o">!</span><span class="nv">$isReverse0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                                <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$wayToGo</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="s1">&#39;dx&#39;</span><span class="p">],</span> <span class="nv">$wayToGo</span><span class="p">[</span><span class="nv">$i</span><span class="p">][</span><span class="s1">&#39;dy&#39;</span><span class="p">],</span> <span class="k">false</span><span class="p">);</span>
</span><span class='line'>                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                            <span class="p">}</span>
</span><span class='line'>                        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span><span class='line'>                        <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span><span class='line'>                            <span class="c1">// 交差点で考える</span>
</span><span class='line'>                            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="c1">// 同じ行動はとらない</span>
</span><span class='line'>                    <span class="nv">$wayToGoFiltered</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$wayToGo</span> <span class="k">as</span> <span class="nv">$toGo</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$pacmanThought</span><span class="p">[</span><span class="nv">$joystick</span><span class="p">][</span><span class="nv">$toGo</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]][</span><span class="nv">$toGo</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]]))</span> <span class="p">{</span>
</span><span class='line'>                            <span class="nv">$wayToGoFiltered</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$toGo</span><span class="p">;</span>
</span><span class='line'>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                            <span class="nv">$wayCnt</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$wayToGoFiltered</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="c1">// どこも行けない</span>
</span><span class='line'>                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;no_way_to_go&#39;</span><span class="p">);</span>
</span><span class='line'>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nv">$wayToGo</span> <span class="o">=</span> <span class="nv">$wayToGoFiltered</span><span class="p">;</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$wayToGoFiltered</span> <span class="k">as</span> <span class="nv">$toGo</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$maze</span><span class="p">[</span><span class="nv">$y</span> <span class="o">+</span> <span class="nv">$toGo</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]][</span><span class="nv">$x</span> <span class="o">+</span> <span class="nv">$toGo</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]]</span> <span class="o">===</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                            <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$toGo</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">],</span> <span class="nv">$toGo</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">],</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$wayToGoFiltered</span> <span class="k">as</span> <span class="nv">$toGo</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$footprintMap</span><span class="p">[</span><span class="nv">$y</span> <span class="o">+</span> <span class="nv">$toGo</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">]][</span><span class="nv">$x</span> <span class="o">+</span> <span class="nv">$toGo</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                            <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$toGo</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">],</span> <span class="nv">$toGo</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">],</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$wayToGoFiltered</span> <span class="k">as</span> <span class="nv">$toGo</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nv">$dx</span> <span class="o">=</span> <span class="nv">$toGo</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">];</span>
</span><span class='line'>                        <span class="nv">$dy</span> <span class="o">=</span> <span class="nv">$toGo</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">];</span>
</span><span class='line'>                        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                            <span class="k">if</span> <span class="p">(</span><span class="nv">$maze</span><span class="p">[</span><span class="nv">$y</span> <span class="o">+</span> <span class="nv">$dy</span><span class="p">][</span><span class="nv">$x</span> <span class="o">+</span> <span class="nv">$dx</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                                <span class="nv">$find</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>                                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$maze</span><span class="p">[</span><span class="nv">$y</span> <span class="o">+</span> <span class="nv">$dy</span><span class="p">][</span><span class="nv">$x</span> <span class="o">+</span> <span class="nv">$dx</span><span class="p">])</span> <span class="o">||</span> <span class="nv">$maze</span><span class="p">[</span><span class="nv">$y</span> <span class="o">+</span> <span class="nv">$dy</span><span class="p">][</span><span class="nv">$x</span> <span class="o">+</span> <span class="nv">$dx</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                                <span class="nv">$find</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>                                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                            <span class="p">}</span>
</span><span class='line'>                            <span class="nv">$dx</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                            <span class="nv">$dy</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="nv">$find</span> <span class="o">===</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                            <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$toGo</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">],</span> <span class="nv">$toGo</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">],</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="nv">$dx</span> <span class="o">=</span> <span class="nv">$wayToGoFiltered</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dx&#39;</span><span class="p">];</span>
</span><span class='line'>                    <span class="nv">$dy</span> <span class="o">=</span> <span class="nv">$wayToGoFiltered</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dy&#39;</span><span class="p">];</span>
</span><span class='line'>                    <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$dx</span><span class="p">,</span> <span class="nv">$dy</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>                <span class="p">};</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$function</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="sd">/**</span>
</span><span class='line'><span class="sd"> * パックマンDIコンテナ 問題１用</span>
</span><span class='line'><span class="sd"> *</span>
</span><span class='line'><span class="sd"> */</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Pacman_Dicon_Q1</span> <span class="k">extends</span> <span class="nx">Pacman_Dicon</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * サービス取得</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param string $service サービス取得名</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return mixed</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>        <span class="k">public</span> <span class="k">function</span> <span class="nf">get</span><span class="p">(</span><span class="nv">$service</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">switch</span> <span class="p">(</span><span class="nv">$service</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">case</span> <span class="s1">&#39;direction&#39;</span><span class="o">:</span>
</span><span class='line'>                <span class="c1">//$directionStrategy = array(array(-1, 0), array(0, -1), array(1, 0), array(0, 1), array(0, 0));</span>
</span><span class='line'>                <span class="nv">$directionStrategy</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span><span class='line'>                <span class="nb">shuffle</span><span class="p">(</span><span class="nv">$directionStrategy</span><span class="p">);</span>
</span><span class='line'>                <span class="k">return</span> <span class="nv">$directionStrategy</span><span class="p">;</span>
</span><span class='line'>            <span class="k">case</span> <span class="s1">&#39;move&#39;</span><span class="o">:</span>
</span><span class='line'>                <span class="nv">$function</span> <span class="o">=</span>  <span class="k">function</span> <span class="p">(</span><span class="nv">$x</span><span class="p">,</span> <span class="nv">$y</span><span class="p">,</span> <span class="nv">$dx</span><span class="p">,</span> <span class="nv">$dy</span><span class="p">,</span> <span class="nv">$maze</span><span class="p">,</span> <span class="o">&amp;</span><span class="c1">#038;$wayCnt, $wayToGo, $footprintMap, $joystick)</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$wayToGo</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nv">$dx</span> <span class="o">=</span> <span class="nv">$wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dx&#39;</span><span class="p">];</span>
</span><span class='line'>                        <span class="nv">$dy</span> <span class="o">=</span> <span class="nv">$wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dy&#39;</span><span class="p">];</span>
</span><span class='line'>                        <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$dx</span><span class="p">,</span> <span class="nv">$dy</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;no_way_to_go&#39;</span><span class="p">);</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">};</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$function</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="sd">/**</span>
</span><span class='line'><span class="sd"> * モンスター</span>
</span><span class='line'><span class="sd"> */</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Monster</span> <span class="k">extends</span> <span class="nx">Character</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 最初？</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var bool</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_init</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * モンスターL</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var string</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_j</span> <span class="o">=</span> <span class="s1">&#39;L&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 移動</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param array $maze</span>
</span><span class='line'><span class="sd">     * @param int   $pacmanX</span>
</span><span class='line'><span class="sd">     * @param int   $pacmanY</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return void</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">move</span><span class="p">(</span><span class="nv">$maze</span><span class="p">,</span> <span class="nv">$pacmanX</span><span class="p">,</span> <span class="nv">$pacmanY</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_init</span> <span class="o">===</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">//時刻 t = 0 においては、初期位置の 下、左、上、右 の順で最初に進入可能なマスの方向に移動します。</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_init</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_setPositionStatus</span><span class="p">(</span><span class="nv">$maze</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_clockwiseDirection</span><span class="p">);</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dy</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dy&#39;</span><span class="p">];</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dx&#39;</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">//下、左、上、右 の順</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_setPositionStatus</span><span class="p">(</span><span class="nv">$maze</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_clockwiseDirection</span><span class="p">);</span>
</span><span class='line'>            <span class="k">switch</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGoCount</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>                    <span class="c1">// 行き止まりなので唯一いける方向へ</span>
</span><span class='line'>                    <span class="nv">$togo</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dy</span> <span class="o">=</span> <span class="nv">$togo</span><span class="p">[</span><span class="s1">&#39;dy&#39;</span><span class="p">];</span>
</span><span class='line'>                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span> <span class="o">=</span> <span class="nv">$togo</span><span class="p">[</span><span class="s1">&#39;dx&#39;</span><span class="p">];</span>
</span><span class='line'>                <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span><span class='line'>                    <span class="c1">// バックじゃない方</span>
</span><span class='line'>                    <span class="nv">$isReverse</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span> <span class="o">===</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dx&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span><span class="c1">#038;&amp;#038; $this-&gt;_dy === ($this-&gt;_wayToGo[0][&#39;dy&#39;] * -1));</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$isReverse</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dy</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;dy&#39;</span><span class="p">];</span>
</span><span class='line'>                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;dx&#39;</span><span class="p">];</span>
</span><span class='line'>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dy</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dy&#39;</span><span class="p">];</span>
</span><span class='line'>                        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dx&#39;</span><span class="p">];</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span><span class='line'>                <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span><span class='line'>                    <span class="c1">// モンスターに応じて</span>
</span><span class='line'>                    <span class="nv">$method</span> <span class="o">=</span> <span class="s1">&#39;_move&#39;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_myChar</span><span class="p">;</span>
</span><span class='line'>                    <span class="k">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dy</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nv">$method</span><span class="p">(</span><span class="nv">$maze</span><span class="p">,</span> <span class="nv">$pacmanX</span><span class="p">,</span> <span class="nv">$pacmanY</span><span class="p">);</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;</span><span class="c1">#038;&amp;#038; $this-&gt;_dy == 0){</span>
</span><span class='line'>                        <span class="nx">p</span><span class="p">(</span><span class="s2">&quot;error </span><span class="si">$this-&gt;_myChar</span><span class="s2">&quot;</span><span class="p">);</span><span class="k">exit</span><span class="p">();</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                <span class="k">default</span><span class="o">:</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_y</span> <span class="o">+=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dy</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span> <span class="o">+=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">// もし以前パックマンがいたところに移動したら”王手”。パックマンは前にモンスターがいたところには移動できない。仮に壁にする。</span>
</span><span class='line'>        <span class="nv">$makeMeWall</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span> <span class="o">===</span> <span class="nv">$pacmanX</span> <span class="o">&amp;</span><span class="c1">#038;&amp;#038; $this-&gt;_y === $pacmanY);</span>
</span><span class='line'>        <span class="nv">$wall</span> <span class="o">=</span> <span class="nv">$makeMeWall</span> <span class="o">?</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;x&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span> <span class="o">-</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_y</span> <span class="o">-</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dy</span><span class="p">)</span> <span class="o">:</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$result</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_y</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_myChar</span><span class="p">,</span> <span class="nv">$wall</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * モンスターV</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * 敵から見た自機の相対位置を (dx, dy) と表すものとします。次のルールを上から順に適用し、最初に選ばれた方向に移動します。</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * 1. dy ≠ 0 でかつ dy の符号方向にあるマスが進入可能であれば、その方向に移動します。</span>
</span><span class='line'><span class="sd">     * 2. dx ≠ 0 でかつ dx の符号方向にあるマスが進入可能であれば、その方向に移動します。</span>
</span><span class='line'><span class="sd">     * 3. 現在位置の 下、左、上、右 の順で最初に進入可能なマスの方向に移動する。</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param array $maze    迷路</span>
</span><span class='line'><span class="sd">     * @param int   $pacmanX パックマンX座標</span>
</span><span class='line'><span class="sd">     * @param int   $pacmanX パックマンY座標</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">_moveV</span><span class="p">(</span><span class="k">array</span> <span class="nv">$maze</span><span class="p">,</span> <span class="nv">$pacmanX</span><span class="p">,</span> <span class="nv">$pacmanY</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$dx</span> <span class="o">=</span> <span class="nv">$pacmanX</span> <span class="o">-</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$dy</span> <span class="o">=</span> <span class="nv">$pacmanY</span> <span class="o">-</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_y</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">// 1</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$dy</span> <span class="o">!==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$ddy</span> <span class="o">=</span> <span class="nv">$dy</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="nv">$dy</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$maze</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_y</span> <span class="o">+</span> <span class="nv">$ddy</span><span class="p">][</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span><span class="p">])</span> <span class="o">&amp;</span><span class="c1">#038;&amp;#038; $maze[$this-&gt;_y + $ddy][$this-&gt;_x] !== &#39;#&#39;) {</span>
</span><span class='line'>                <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">$ddy</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">// 2</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$dx</span> <span class="o">!==</span> <span class="mi">0</span> <span class="p">){</span>
</span><span class='line'>            <span class="nv">$ddx</span> <span class="o">=</span> <span class="nv">$dx</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="nv">$dx</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$maze</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_y</span><span class="p">][</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span> <span class="o">+</span> <span class="nv">$ddx</span><span class="p">])</span> <span class="o">&amp;</span><span class="c1">#038;&amp;#038; $maze[$this-&gt;_y][$this-&gt;_x + $ddx] !== &#39;#&#39;) {</span>
</span><span class='line'>                <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$ddx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">// 3</span>
</span><span class='line'>        <span class="nv">$result</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dx&#39;</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dy&#39;</span><span class="p">]);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * モンスターH</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * 敵 V とほぼ同じです。唯一異なるのは 、進行方向を決めるルールのうち</span>
</span><span class='line'><span class="sd">     * 最初の二つのルールの適用順序が入れ替わるところです。</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param array $maze    迷路</span>
</span><span class='line'><span class="sd">     * @param int   $pacmanX パックマンX座標</span>
</span><span class='line'><span class="sd">     * @param int   $pacmanX パックマンY座標</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">_moveH</span><span class="p">(</span><span class="k">array</span> <span class="nv">$maze</span><span class="p">,</span> <span class="nv">$pacmanX</span><span class="p">,</span> <span class="nv">$pacmanY</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$dx</span> <span class="o">=</span> <span class="nv">$pacmanX</span> <span class="o">-</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$dy</span> <span class="o">=</span> <span class="nv">$pacmanY</span> <span class="o">-</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_y</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">// 2</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$dx</span> <span class="o">!==</span> <span class="mi">0</span> <span class="p">){</span>
</span><span class='line'>            <span class="nv">$ddx</span> <span class="o">=</span> <span class="nv">$dx</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="nv">$dx</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$maze</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_y</span><span class="p">][</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span> <span class="o">+</span> <span class="nv">$ddx</span><span class="p">])</span> <span class="o">&amp;</span><span class="c1">#038;&amp;#038; $maze[$this-&gt;_y][$this-&gt;_x + $ddx] !== &#39;#&#39;) {</span>
</span><span class='line'>                <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="nv">$ddx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">// 1</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$dy</span> <span class="o">!==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$ddy</span> <span class="o">=</span> <span class="nv">$dy</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="nv">$dy</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$maze</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_y</span> <span class="o">+</span> <span class="nv">$ddy</span><span class="p">][</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_x</span><span class="p">])</span> <span class="o">&amp;</span><span class="c1">#038;&amp;#038; $maze[$this-&gt;_y + $ddy][$this-&gt;_x] !== &#39;#&#39;) {</span>
</span><span class='line'>                <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nv">$ddy</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">// 3</span>
</span><span class='line'>        <span class="nv">$result</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dx&#39;</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dy&#39;</span><span class="p">]);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * モンスターL</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * 現在位置への進入方向から見て相対的に 左、前、右 の順</span>
</span><span class='line'><span class="sd">     * @param array $maze    迷路</span>
</span><span class='line'><span class="sd">     * @param int   $pacmanX パックマンX座標</span>
</span><span class='line'><span class="sd">     * @param int   $pacmanX パックマンY座標</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">_moveL</span><span class="p">(</span><span class="k">array</span> <span class="nv">$maze</span><span class="p">,</span> <span class="nv">$pacmanX</span><span class="p">,</span> <span class="nv">$pacmanY</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$directionStrategy</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_getRelativeDirection</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_setPositionStatus</span><span class="p">(</span><span class="nv">$maze</span><span class="p">,</span> <span class="nv">$directionStrategy</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$result</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dx&#39;</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dy&#39;</span><span class="p">]);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * モンスターR</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * 現在位置への進入方向から見て相対的に 右、前、左  の順</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param array $maze    迷路</span>
</span><span class='line'><span class="sd">     * @param int   $pacmanX パックマンX座標</span>
</span><span class='line'><span class="sd">     * @param int   $pacmanX パックマンY座標</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">_moveR</span><span class="p">(</span><span class="k">array</span> <span class="nv">$maze</span><span class="p">,</span> <span class="nv">$pacmanX</span><span class="p">,</span> <span class="nv">$pacmanY</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$directionStrategy</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_getRelativeDirection</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_setPositionStatus</span><span class="p">(</span><span class="nv">$maze</span><span class="p">,</span> <span class="nv">$directionStrategy</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$result</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dx&#39;</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_wayToGo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dy&#39;</span><span class="p">]);</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * モンスターJ</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * 最初は敵Lの行動、次回は敵Rの行動、さらに次回はまた敵Lの行動、と繰り返します。</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param array $maze    迷路</span>
</span><span class='line'><span class="sd">     * @param int   $pacmanX パックマンX座標</span>
</span><span class='line'><span class="sd">     * @param int   $pacmanX パックマンY座標</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">_moveJ</span><span class="p">(</span><span class="k">array</span> <span class="nv">$maze</span><span class="p">,</span> <span class="nv">$pacmanX</span><span class="p">,</span> <span class="nv">$pacmanY</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$method</span> <span class="o">=</span> <span class="s2">&quot;_move</span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nv">$method</span><span class="p">(</span><span class="nv">$maze</span><span class="p">,</span> <span class="nv">$pacmanX</span><span class="p">,</span> <span class="nv">$pacmanY</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_j</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_j</span> <span class="o">===</span> <span class="s1">&#39;L&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;R&#39;</span> <span class="o">:</span> <span class="s1">&#39;L&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 進行方向に対しての相対方向（左右など）戦略の配列を作成</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param interger $relativeDirection 1=右, -1=左</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">_getRelativeDirection</span><span class="p">(</span><span class="nv">$relativeDirections</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$result</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$currentDirection</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dx</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_dy</span><span class="p">);</span>
</span><span class='line'>        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$relativeDirections</span> <span class="k">as</span> <span class="nv">$relativeDirection</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$pos</span> <span class="o">=</span> <span class="nb">array_search</span><span class="p">(</span><span class="nv">$currentDirection</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_clockwiseDirection</span><span class="p">);</span>
</span><span class='line'>            <span class="nv">$directionIndex</span> <span class="o">=</span> <span class="nv">$pos</span> <span class="o">+</span> <span class="nv">$relativeDirection</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nv">$directionIndex</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nv">$directionIndex</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nv">$directionIndex</span> <span class="o">===</span> <span class="mi">4</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nv">$directionIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="nb">array_push</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_clockwiseDirection</span><span class="p">[</span><span class="nv">$directionIndex</span><span class="p">]);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="sd">/**</span>
</span><span class='line'><span class="sd"> * ゲーム</span>
</span><span class='line'><span class="sd"> *</span>
</span><span class='line'><span class="sd"> */</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Pacman_Game</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * スコア</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var int</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * クリアスコア</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var int</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_clearScore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 制限時間</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var int</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_timeOut</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 時間</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var int</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * パックマン</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var Pacman</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_pacman</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * モンスター</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_monsters</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 迷路</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_maze</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * キャラ付迷路</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_mazeWithChar</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * キャラなし迷路</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_mazeWithoutChar</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * パックマンX座標</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var int</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_pacmanX</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * パックマンY座標</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var int</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_pacmanY</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * デバック?</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var bool</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_debug</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * デバックアニメーション時間</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var int</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_debugTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * デバックアニメーション?</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var bool</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_debugAnimation</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * パックマンDIコンテナ</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var Pacman_Dicon</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_pacmanDicon</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * __clone</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">__clone</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacman</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacman</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$cloneMonsters</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_monsters</span> <span class="k">as</span> <span class="nv">$monster</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$cloneMonsters</span><span class="p">[]</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$monster</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_monsters</span> <span class="o">=</span> <span class="nv">$cloneMonsters</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 迷路から必要なオブジェクトやプロパティをセット</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * +Pacmanオブジェクト</span>
</span><span class='line'><span class="sd">     * +Monsterオブジェクト</span>
</span><span class='line'><span class="sd">     * +ドットの数</span>
</span><span class='line'><span class="sd">     * +キャラクターがいない迷路</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">_injectFromMaze</span><span class="p">(</span><span class="nv">$maze</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$point</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacman</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_monsters</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="nv">$y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$maze</span><span class="p">[</span><span class="nv">$y</span><span class="p">]);</span> <span class="nv">$y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">for</span><span class="p">(</span><span class="nv">$x</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="nv">$x</span> <span class="o">&lt;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$maze</span><span class="p">[</span><span class="nv">$y</span><span class="p">]);</span> <span class="nv">$x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nv">$char</span> <span class="o">=</span> <span class="nv">$maze</span><span class="p">[</span><span class="nv">$y</span><span class="p">][</span><span class="nv">$x</span><span class="p">];</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nv">$char</span> <span class="o">===</span> <span class="s1">&#39;@&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacman</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Pacman</span><span class="p">(</span><span class="nv">$char</span><span class="p">,</span> <span class="nv">$x</span><span class="p">,</span> <span class="nv">$y</span><span class="p">);</span>
</span><span class='line'>                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacman</span><span class="o">-&gt;</span><span class="na">setFootprintMap</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$maze</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$maze</span><span class="p">));</span>
</span><span class='line'>                    <span class="nv">$maze</span><span class="p">[</span><span class="nv">$y</span><span class="p">][</span><span class="nv">$x</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$char</span> <span class="o">===</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nv">$point</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/[A-Z]/&#39;</span><span class="p">,</span> <span class="nv">$char</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_monsters</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Monster</span><span class="p">(</span><span class="nv">$char</span><span class="p">,</span> <span class="nv">$x</span><span class="p">,</span> <span class="nv">$y</span><span class="p">);</span>
</span><span class='line'>                    <span class="nv">$maze</span><span class="p">[</span><span class="nv">$y</span><span class="p">][</span><span class="nv">$x</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_clearScore</span> <span class="o">=</span> <span class="nv">$point</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_maze</span> <span class="o">=</span> <span class="nv">$maze</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 問題１</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return void</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">_injectQuestionOne</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$maze</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;###########&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#.V..#..H.#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#.##...##.#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#L#..#..R.#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#.#.###.#.#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#....@....#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;###########&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_injectFromMaze</span><span class="p">(</span><span class="nv">$maze</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanDicon</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Pacman_Dicon_Q1</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_timeOut</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 問題2</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return void</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">_injectQuestionTwo</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$maze</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;####################&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;###.....L..........#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;###.##.##.##L##.##.#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;###.##.##.##.##.##.#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#.L................#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#.##.##.##.##.##.###&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#.##.##L##.##.##.###&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#.................L#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#.#.#.#J####J#.#.#.#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#L.................#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;###.##.##.##.##.##.#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;###.##.##R##.##.##.#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#................R.#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#.##.##.##.##R##.###&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#.##.##.##.##.##.###&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#@....R..........###&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;####################&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_injectFromMaze</span><span class="p">(</span><span class="nv">$maze</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanDicon</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Pacman_Dicon</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_timeOut</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 問題3</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return void</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">_injectQuestionThree</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$maze</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;##########################################################&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#........................................................#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#.###.#########.###############.########.###.#####.#####.#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#.###.#########.###############.########.###.#####.#####.#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#.....#########....J.............J.......###.............#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#####.###.......#######.#######.########.###.#######.#####&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#####.###.#####J#######.#######.########.###.##   ##.#####&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#####.###L#####.##   ##L##   ##.##    ##.###.##   ##.#####&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#####.###..H###.##   ##.##   ##.########.###.#######J#####&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#####.#########.##   ##L##   ##.########.###.###V....#####&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#####.#########.#######.#######..........###.#######.#####&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#####.#########.#######.#######.########.###.#######.#####&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#.....................L.........########..........R......#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#L####.##########.##.##########....##....#########.#####.#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#.####.##########.##.##########.##.##.##.#########.#####.#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;#.................##............##..@.##...............R.#&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$maze</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_split</span><span class="p">(</span><span class="s1">&#39;##########################################################&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_injectFromMaze</span><span class="p">(</span><span class="nv">$maze</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanDicon</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Pacman_Dicon</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_timeOut</span> <span class="o">=</span> <span class="mi">700</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 初期化</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return void</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">init</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// init</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_mazeWithChar</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_mazeWithoutChar</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_maze</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanX</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * パックマン取得</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return Pacman</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">getPacman</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacman</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 1ゲームプレイ</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">runGame</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// init</span>
</span><span class='line'>        <span class="nv">$lastGame</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$this</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$isHit</span> <span class="o">=</span> <span class="nv">$isTimeOut</span> <span class="o">=</span> <span class="nv">$isClear</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$gameCount</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">// main</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nv">$isHit</span> <span class="o">&amp;</span><span class="c1">#038;&amp;#038; !$isClear) {</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_time</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="nv">$isTimeOut</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_time</span> <span class="o">&gt;=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_timeOut</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nv">$isTimeOut</span> <span class="o">===</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="c1">// モンスター</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_runMonsters</span><span class="p">();</span>
</span><span class='line'>            <span class="c1">// pacman</span>
</span><span class='line'>            <span class="k">list</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanX</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanY</span><span class="p">,</span> <span class="nv">$dx</span><span class="p">,</span> <span class="nv">$dy</span><span class="p">,</span> <span class="nv">$takeSnapShot</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacman</span><span class="o">-&gt;</span><span class="na">move</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_mazeWithChar</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_time</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanDicon</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_mazeWithoutChar</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanY</span><span class="p">][</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanX</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_score</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_mazeWithoutChar</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanY</span><span class="p">][</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanX</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="c1">// 描画</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_mazeWithChar</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanY</span><span class="o">-</span> <span class="nv">$dy</span><span class="p">][</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanX</span> <span class="o">-</span> <span class="nv">$dx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_mazeWithChar</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanY</span><span class="p">][</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanX</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;@&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nv">$takeSnapShot</span> <span class="o">===</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">//  パックマンが曲がるのでスナップショット</span>
</span><span class='line'>                <span class="nv">$joy</span> <span class="o">=</span> <span class="nv">$lastGame</span><span class="o">-&gt;</span><span class="na">getPacman</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getJoystick</span><span class="p">();</span>
</span><span class='line'>                <span class="nb">array_push</span><span class="p">(</span><span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$games</span><span class="p">,</span> <span class="nv">$lastGame</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="c1">// 後処理</span>
</span><span class='line'>            <span class="nv">$isClear</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_score</span> <span class="o">==</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_clearScore</span><span class="p">);</span>
</span><span class='line'>            <span class="c1">//            $restDot = $this-&gt;_clearScore - $this-&gt;_score;</span>
</span><span class='line'>            <span class="c1">//            $isTimeOut = ($restDot &gt; $this-&gt;_timeOut - $this-&gt;_time || $this-&gt;_time &gt;= Pacman_Quiz::$minClearTime + $restDot);</span>
</span><span class='line'>            <span class="nv">$isHit</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_hitCheck</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanX</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanY</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_debug</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_showCompositScreen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_mazeWithoutChar</span><span class="p">);</span>
</span><span class='line'>                <span class="nb">usleep</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_debugTime</span><span class="p">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_debugAnimation</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">echo</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[;H</span><span class="se">\033</span><span class="s2">[2J&quot;</span><span class="p">;</span> <span class="c1">// clear screen</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="nv">$joy</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacman</span><span class="o">-&gt;</span><span class="na">getJoystick</span><span class="p">();</span>
</span><span class='line'>            <span class="nv">$lastGame</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$this</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$isTimeOut</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">//            $this-&gt;_checkRepeatGame();</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_gameOver</span><span class="p">(</span><span class="s1">&#39;TimeOut&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_mazeWithChar</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$isHit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;hit&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$isClear</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_time</span> <span class="o">&gt;=</span> <span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$minClearTime</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$minClearTime</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_time</span><span class="p">;</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_gameOver</span><span class="p">(</span><span class="s1">&#39;Clear&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_mazeWithChar</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * ゲームを繰り返していないかdebugチェック</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return void</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">_checkRepeatGame</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">static</span> <span class="nv">$joystat</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$joy</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacman</span><span class="o">-&gt;</span><span class="na">getJoystick</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$key</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$joy</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$joystat</span><span class="p">[</span><span class="nv">$key</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$joystat</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="k">echo</span> <span class="s2">&quot;repeated. </span><span class="si">$joy\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$joystat</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * モンスター移動</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return void</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">_runMonsters</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_mazeWithChar</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_mazeWithoutChar</span><span class="p">;</span>
</span><span class='line'>        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_monsters</span> <span class="k">as</span> <span class="nv">$monster</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">list</span><span class="p">(</span><span class="nv">$monsterX</span><span class="p">,</span> <span class="nv">$monsterY</span><span class="p">,</span> <span class="nv">$myChar</span><span class="p">,</span> <span class="nv">$wall</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$monster</span><span class="o">-&gt;</span><span class="na">move</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_mazeWithoutChar</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanX</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacmanY</span><span class="p">);</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_mazeWithChar</span><span class="p">[</span><span class="nv">$monsterY</span><span class="p">][</span><span class="nv">$monsterX</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$myChar</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$wall</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_mazeWithChar</span><span class="p">[</span><span class="nv">$wall</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]][</span><span class="nv">$wall</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * ハイスコアセット</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return void</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">setHighScore</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_score</span> <span class="o">&gt;</span> <span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$highscore</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$highscore</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_score</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * Game Over画面出力</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param string $reason　      ゲームオーバーの理由</span>
</span><span class='line'><span class="sd">     * @param string $mazeWithChar　キャラクター付迷路</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return void</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">_gameOver</span><span class="p">(</span><span class="nv">$reason</span><span class="p">,</span> <span class="nv">$mazeWithChar</span><span class="p">,</span> <span class="nv">$forceShow</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$forceShow</span> <span class="o">||</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_score</span> <span class="o">&gt;</span> <span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$highscore</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$highscore</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_score</span><span class="p">;</span>
</span><span class='line'>            <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_showCompositScreen</span><span class="p">(</span><span class="nv">$mazeWithChar</span><span class="p">);</span>
</span><span class='line'>            <span class="nv">$msg</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$reason</span> <span class="o">===</span> <span class="s1">&#39;clear&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;Game Clear&quot;</span> <span class="o">:</span> <span class="s2">&quot;GAME OVER(</span><span class="si">$reason</span><span class="s2">)&quot;</span> <span class="p">;</span>
</span><span class='line'>            <span class="k">echo</span> <span class="s2">&quot;High Score:&quot;</span> <span class="o">.</span> <span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$highscore</span> <span class="o">.</span> <span class="s1">&#39; total:&#39;</span><span class="o">.</span> <span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$gameCount</span> <span class="o">.</span> <span class="s2">&quot; </span><span class="si">$msg\n\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * ヒットチェック</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param $pacmanX パックマンX座標</span>
</span><span class='line'><span class="sd">     * @param $pacmanY パックマンY座標</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return bool</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">_hitCheck</span><span class="p">(</span><span class="nv">$pacmanX</span><span class="p">,</span> <span class="nv">$pacmanY</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$isHit</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_monsters</span> <span class="k">as</span> <span class="nv">$monster</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">list</span><span class="p">(</span><span class="nv">$monsterX</span><span class="p">,</span> <span class="nv">$monsterY</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$monster</span><span class="o">-&gt;</span><span class="na">getPosition</span><span class="p">();</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nv">$pacmanX</span> <span class="o">===</span> <span class="nv">$monsterX</span> <span class="o">&amp;</span><span class="c1">#038;&amp;#038; $pacmanY == $monsterY) {</span>
</span><span class='line'>                <span class="nv">$isHit</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$isHit</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * デバックモード</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param int $time アニメーションタイム</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return void</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">setDebug</span><span class="p">(</span><span class="nv">$time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_debugTime</span> <span class="o">=</span>  <span class="nv">$time</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_debugAnimation</span> <span class="o">=</span> <span class="p">(</span><span class="nb">is_integer</span><span class="p">(</span><span class="nv">$time</span><span class="p">)</span> <span class="o">&amp;</span><span class="c1">#038;&amp;#038; $time &gt; 0) ? true : false;</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_debug</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * 迷路配列作成</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return array</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">_split</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$result</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span> <span class="nv">$i</span><span class="o">++</span><span class="p">){</span>
</span><span class='line'>            <span class="nv">$result</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * ゲーム画面描画</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @reutnr void</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">_showCompositScreen</span><span class="p">(</span><span class="k">array</span> <span class="nv">$maze</span><span class="p">,</span> <span class="nv">$debug</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$characters</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_monsters</span><span class="p">;</span>
</span><span class='line'>        <span class="nb">array_push</span><span class="p">(</span><span class="nv">$characters</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacman</span><span class="p">);</span>
</span><span class='line'>        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$characters</span> <span class="k">as</span> <span class="nv">$character</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">list</span><span class="p">(</span><span class="nv">$char</span><span class="p">,</span> <span class="nv">$x</span><span class="p">,</span> <span class="nv">$y</span><span class="p">,</span> <span class="nv">$dx</span><span class="p">,</span> <span class="nv">$dy</span><span class="p">)</span> <span class="o">=</span> <span class="nv">$character</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</span><span class='line'>            <span class="nv">$maze</span><span class="p">[</span><span class="nv">$y</span><span class="p">][</span><span class="nv">$x</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$char</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">echo</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$maze</span> <span class="k">as</span> <span class="nv">$y</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">echo</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$y</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nv">$point</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_score</span> <span class="o">===</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_clearScore</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_timeOut</span> <span class="o">-</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_time</span><span class="p">)</span> <span class="o">+</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_score</span> <span class="o">:</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_score</span><span class="p">;</span>
</span><span class='line'>        <span class="k">echo</span> <span class="s2">&quot;Score:</span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_score</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_clearScore</span><span class="si">}</span><span class="s2"> Point:</span><span class="si">{</span><span class="nv">$point</span><span class="si">}</span><span class="s2"> Game:</span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_time</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_timeOut</span><span class="si">}</span><span class="s2"> Stacked Game:&quot;</span> <span class="o">.</span> <span class="nb">count</span><span class="p">(</span><span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$games</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot; </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="k">echo</span> <span class="s2">&quot;High Score: &quot;</span><span class="o">.</span> <span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$highscore</span> <span class="o">.</span> <span class="s1">&#39; total: &#39;</span><span class="o">.</span> <span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$gameCount</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="k">echo</span> <span class="s2">&quot;Play:&quot;</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_pacman</span><span class="o">-&gt;</span><span class="na">getJoystick</span><span class="p">()</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="sd">/**</span>
</span><span class='line'><span class="sd"> * パックマンクイズ</span>
</span><span class='line'><span class="sd"> *</span>
</span><span class='line'><span class="sd"> * @author akihito</span>
</span><span class='line'><span class="sd"> */</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Pacman_Quiz</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * パックマンの行動</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="nv">$pacmanThought</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * ゲーム</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="nv">$games</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * ハイスコア</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var int</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="nv">$highscore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * クリア最小時間</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var int</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="nv">$minClearTime</span> <span class="o">=</span> <span class="mi">999</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * ゲーム回数</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var int</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="nv">$gameCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * TimeOutの時にゲームをpopするか</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @var bool</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$_popOnTimeOut</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * TimeOutの時にゲームをpopするかを設定</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @param bool $setPopOnTimeout</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">setPopOnTimeout</span><span class="p">(</span><span class="nv">$setPopOnTimeout</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_setPopOnTimeout</span> <span class="o">=</span> <span class="nv">$setPopOnTimeout</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * クイズ実行</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return void</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">run</span><span class="p">(</span><span class="nv">$injector</span> <span class="o">=</span> <span class="s1">&#39;_injectQuestionThree&#39;</span><span class="p">,</span> <span class="nv">$debug</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$game</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Pacman_Game</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$debug</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$game</span><span class="o">-&gt;</span><span class="na">setDebug</span><span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nv">$game</span><span class="o">-&gt;</span><span class="nv">$injector</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$game</span><span class="o">-&gt;</span><span class="na">init</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$firstGame</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$game</span><span class="p">;</span>
</span><span class='line'>        <span class="nb">array_push</span><span class="p">(</span><span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$games</span><span class="p">,</span> <span class="nv">$firstGame</span><span class="p">);</span>
</span><span class='line'>        <span class="k">do</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$game</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">echo</span> <span class="s2">&quot;All Game is Over.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>                <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$game</span><span class="o">-&gt;</span><span class="na">runGame</span><span class="p">();</span>
</span><span class='line'>                <span class="nv">$game</span> <span class="o">=</span> <span class="nb">array_pop</span><span class="p">(</span><span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$games</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nv">$game</span> <span class="o">=</span> <span class="nb">array_pop</span><span class="p">(</span><span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$games</span><span class="p">);</span>
</span><span class='line'>                <span class="nv">$result</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_showCounter</span><span class="p">();</span>
</span><span class='line'>            <span class="c1">// Time Out</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span> <span class="o">===</span> <span class="k">true</span> <span class="o">&amp;</span><span class="c1">#038;&amp;#038; !$this-&gt;_popOnTimeOut) {</span>
</span><span class='line'>                <span class="nx">self</span><span class="o">::</span><span class="nv">$pacmanThought</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>                <span class="nx">self</span><span class="o">::</span><span class="nv">$games</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$games</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>                <span class="nv">$game</span> <span class="o">=</span> <span class="nb">array_pop</span><span class="p">(</span><span class="nx">Pacman_Quiz</span><span class="o">::</span><span class="nv">$games</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * クイズ実行　（問題１用）</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return void</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">run1</span><span class="p">(</span><span class="nv">$injector</span> <span class="o">=</span> <span class="s1">&#39;_injectQuestionOne&#39;</span><span class="p">,</span> <span class="nv">$debug</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$game</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Pacman_Game</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$debug</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$game</span><span class="o">-&gt;</span><span class="na">setDebug</span><span class="p">(</span><span class="nv">$debug</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nv">$game</span><span class="o">-&gt;</span><span class="nv">$injector</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$game</span><span class="o">-&gt;</span><span class="na">init</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$firstGame</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$game</span><span class="p">;</span>
</span><span class='line'>        <span class="nb">array_push</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$games</span><span class="p">,</span> <span class="nv">$firstGame</span><span class="p">);</span>
</span><span class='line'>        <span class="k">do</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>                <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$game</span><span class="o">-&gt;</span><span class="na">runGame</span><span class="p">();</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="nv">$game</span><span class="o">-&gt;</span><span class="na">setHighScore</span><span class="p">();</span>
</span><span class='line'>            <span class="nx">self</span><span class="o">::</span><span class="nv">$games</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>            <span class="nx">self</span><span class="o">::</span><span class="nv">$pacmanThought</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>            <span class="nv">$game</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$firstGame</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="sd">/**</span>
</span><span class='line'><span class="sd">     * カウンタ表示</span>
</span><span class='line'><span class="sd">     *</span>
</span><span class='line'><span class="sd">     * @return void</span>
</span><span class='line'><span class="sd">     */</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">_showCounter</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">static</span> <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nv">$i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">echo</span> <span class="s2">&quot;.</span><span class="si">$i</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// クイズ実行</span>
</span><span class='line'><span class="nv">$quiz</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Pacman_Quiz</span><span class="p">();</span>
</span><span class='line'><span class="c1">//$quiz-&gt;setPopOnTimeout(true); // true:TimeOutしてもスタックからゲームを取り出すモード</span>
</span><span class='line'><span class="c1">//$quiz-&gt;run1(&#39;_injectQuestionOne&#39;);</span>
</span><span class='line'><span class="c1">//$quiz-&gt;run(&#39;_injectQuestionTwo&#39;);</span>
</span><span class='line'><span class="c1">// 問題３</span>
</span><span class='line'><span class="c1">//$quiz-&gt;run(&#39;_injectQuestionThree&#39;, true); //逐次画面描画</span>
</span><span class='line'><span class="nv">$quiz</span><span class="o">-&gt;</span><span class="na">run</span><span class="p">(</span><span class="s1">&#39;_injectQuestionThree&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>    <span class="c1">//アニメーション</span>
</span><span class='line'><span class="c1">//$quiz-&gt;run(&#39;_injectQuestionThree&#39;);       //ハイスコアチャレンジ</span>
</span></code></pre></td></tr></table></div></figure>




<ol class="footnotes">
  <li id="footnote_0_112" class="footnote">
    この動画はAIによる移動です。再現プレイではありません。 [<a href="#identifier_0_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_1_112" class="footnote">
    結局その見通しは大甘でした [<a href="#identifier_1_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_2_112" class="footnote">
    AKABE? [<a href="#identifier_2_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_3_112" class="footnote">
    モンスタークラスにそれぞれの性格のモンスターがメソッドとして実装されていて迷路とPacmanの座標を受け取ったメソッドが進行方向を配列で返します。 [<a href="#identifier_3_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_4_112" class="footnote">
    95%以上得点が圧縮調整されてました。参加者の得点が高かったのでしょう [<a href="#identifier_4_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_5_112" class="footnote">
    それぐらい知っとけという感じですが [<a href="#identifier_5_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_6_112" class="footnote">
    正に深さ優先探索！ [<a href="#identifier_6_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_7_112" class="footnote">
    ゲームオブジェクトはプロパティとしてモンスターやパックマンのオブジェクトなどゲーム要素全てもっています。 [<a href="#identifier_7_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_8_112" class="footnote">
    メモリと時間が許せば [<a href="#identifier_8_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_9_112" class="footnote">
    その方がスコアが良く、ランダムで繰り返しても同じゲームが再現することがほとんどありませんででした [<a href="#identifier_9_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_10_112" class="footnote">
    ゲームオーバー時に積まれたゲームスタックを再評価し、10,000回に一回しか出ないような良いスコアの途中のゲーム状態から再開してみる..など色々やってみましたがあまりスコアアップに繋がりませんでした。オライリー本にもありますが"大器晩成型"のスコアがとであがってくるタイプのを消してしまうからではないかと思いました。 [<a href="#identifier_10_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_11_112" class="footnote">
    これも膨大なメモリを要します。他にもいろいろな探索がオライリー本に紹介されてますがどれが一番向いてたのでしょうか [<a href="#identifier_11_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_12_112" class="footnote">
    残りドットが少なくなったら取りにいくロジックを追加したらかなり性能があがるかもしれません [<a href="#identifier_12_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_13_112" class="footnote">
    アセンブラは16bitのスーパーファミコン(65816)、メガドライブ (680000+Z80)までやりました [<a href="#identifier_13_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_14_112" class="footnote">
    懐かしい響き! [<a href="#identifier_14_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_15_112" class="footnote">
    自機が”＠”でした！当時いろんなゲームの自機が@。PC-6001用ASCIIのAXシリーズとか... [<a href="#identifier_15_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_16_112" class="footnote">
    動作確認にも大変世話になりました [<a href="#identifier_16_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
  <li id="footnote_17_112" class="footnote">
    AI検索のみの移動です。人の手による修正はありません [<a href="#identifier_17_112" class="footnote-link footnote-back-link">&#8617;</a>]
  </li>
</ol>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/05/resource_cache/">リソースキャッシュ</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2010-05-20T00:00:00+09:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2010</span></span> <span class='time'>12:00 am</span></time>
        
           | <a href="/2010/05/resource_cache/#disqus_thread"
             data-disqus-identifier="http://koriym.github.io/2010/05/resource_cache/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><div style="float: right; margin-left: 10px;">
  <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" data-url="http://www.bear-project.net/blog/2010/05/resource_cache/">Tweet</a>
</div>


<h3>BEAR 0.8.x</h3>

<p>現在のBEARは0.8.Xで、コアな機能は大分実装されてきてました。ここで機能追加を一旦fix、BEAR0.9は確認、テスト、パフォーマンスの向上など安定性の向上のためのバージョンにしてBEAR1.0に繋げようかと考えてます。実装前にその後の機能追加や方向性など単なるアイデアでまとまってないのも含めてかいてみようと思います。</p>

<h3>リソースキャッシュ</h3>

<p>Webフレームワークのキャッシュで最も一般的なのはビューキャッシュでしょうか。ビュー部分をページまるごと、あるいは表示の一部分をキャッシュし、その取得ロジックやDBアクセスのコストをセーブします。Smartyでも簡単に使えます。モデルをキャッシュしようとするとコントローラでモデル（オブジェクト）を直接アクセスするフレームワークでは、コントローラでキャッシュを利用するか、モデル側（ビヘイビアなどで）でキャッシュ対応するのが一般的だとおもいます。</p>

<p>BEARではページはリソースを直接扱わず、ページにインジェクトされたリソースブラウザサービスがリソースアクセスを行います。キャッシュ機構はページが使用するリクエストサービスが実装しています。（WebアクセスでWebブラウザがキャッシュ機構をもっているようなものです）</p>

<h3>NoSQLキャッシュ</h3>

<p>ROAの「ステートレス」と「統一インターフェイス」で、リソースへリクエストをメソッド、URI、バリュー（引数）それにオプションが決まれば事前準備なしに行う事ができます。そのリクエストはURIとバリューの値をシリアライズすれば１つのキーにすることが可能です。そのシリアライズされたリクエスト&rdquo;キー&rdquo;でリソース状態をバリューにキャッシュとしてNoSQLを使えばどうかと考えてます。キャッシュというより参照用RDBの代わりです。</p>

<h3>キャッシュ更新を時間切れでなくメソッドで</h3>

<p>キャッシュ破棄のタイミングは時間指定でなくメソッドを用いるのはどうかと考えてます。つまり、特定バリューのリソースアクセスにバージョンを持っておき、&rdquo;サイドエフェクトがある操作"（update, delete)を行うとバージョン番号があがるというものです。</p>

<p>IDしか引き数を持たないリソースがあったとして、バージョン番号1,ID=3というキー"1:ID=3"でread()を何時間してもキャッシュに変化がなくオリジナルデータソース（RDB）にアクセスはありません。ですがID=3でのupdateやdeleteが発生するとリソースバージョンが1から2になりキャッシュキーは（2:ID=3）になります。キーが代わりキャッシュヒットしないので新しいキャッシュデータがストアされます。（古いキャッシュを明示的に破棄しないでGCにまかせます）</p>

<h3>閉じたリソースと開いたリソース</h3>

<p>以上の事はリソースが他のリソースに依存していないことを前提としています。（join先のテーブルが別リソースに使われてて更新されていたら機能しない）。それを解決するためにリソースにそのリソースの依存性がないというアノテーションを用意したり（@cache closedとか？）リソースキャッシュの依存性を示すようなアノテーション（@cache dependency profile, followerとか？）を用意すればいいのかなとか考えてます（まだ自信がありません）</p>

<h3>ビューキャッシュ</h3>

<p>リソース状態だけでなく、リソーステンプレートを（しかもUA別に）ストアしてやればビューキャッシュになります。キャッシュはレイヤーを持つのでリソース状態キャッシュはリソースクライアントで利用する事ができます。それにリソーステンプレートが適用されたキャッシュはビューキャッシュとなります。※その場合のキャッシュキーはURI + バリュー + バージョン + UA + テンプレート</p>

<p>こういう風にうまくRDBのデータをマスターとしてNoSQLのキャッシュにうまく乗せ、RDBの使いやすさとNoSQLのスケールアウト性がうまく合成できれば理想的なんじゃないかと。RDBのリクエストを最小化することができれば使用するDBライブラリ(MDB2, PDO, Zend_Db）等の性能差をあまり考えなくてよくなるメリットもあります。揮発性のあるキャッシュというより、参照用DB（スレーブDB）の代替になれば理想的です。容量や実装の問題もあるかもしれませんが高い可能性を感じています。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/page7">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/page5">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/11/10/re-code-reading/">Re: BEAR.Sundayをコードリーディングしたのでメモ程度にアウトプットする</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/07/28/an-interface-as-an-api/">An Interface as an API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/04/php7-dot-0-0/">PHP7.0.0</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/01/phpconfuk2015/">基調講演「全てを結ぶ力」(2015)</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/08/haphpy-birthday/">HaPHPy Birthday PHP</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/koriym">@koriym</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'koriym',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/102811656239290261200?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Akihito Koriyama -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'koriym';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script>
    (function(w,d){
        var c,e=d.createDocumentFragment(),f=d.getElementsByTagName("script")[0],
                a=function(a,b){if(!d.getElementById(b)){c=d.createElement("script");
                    c.src=a;c.id=b||null;c.async=true;e.appendChild(c);}};
                a("//b.st-hatena.com/js/bookmark_button_wo_al.js");
                f.parentNode.insertBefore(e,f);
            })(this,document);
</script>


</body>
</html>
